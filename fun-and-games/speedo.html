<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Speedometer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      background: #000;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body {
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      /* Support for safe areas on notched devices */
      min-height: 100vh;
      min-height: -webkit-fill-available;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    #permission-screen {
      text-align: center;
      padding: 2rem;
    }

    #permission-screen h1 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }

    #permission-screen p {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: #aaa;
    }

    #permission-screen .instructions {
      font-size: 0.9rem;
      color: #888;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }

    #permission-screen .install-hint {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 1.5rem;
      padding: 1rem;
      border: 1px solid #333;
      border-radius: 0.5rem;
      background: #111;
    }

    #start-button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 1.5rem 3rem;
      font-size: 1.3rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    #start-button:hover {
      background: #0052a3;
    }

    #start-button:active {
      background: #003d7a;
    }

    #speedometer {
      display: none;
      text-align: center;
      width: 100%;
      position: relative;
    }

    /* HUD mode - mirror for windshield reflection */
    #speedometer.hud-mode {
      transform: scaleX(-1);
    }

    /* Rotate 180 for upside-down portrait mode */
    #speedometer.rotated {
      transform: rotate(180deg);
    }

    /* Combined: mirror + rotate */
    #speedometer.hud-mode.rotated {
      transform: scaleX(-1) rotate(180deg);
    }

    #speed-display {
      font-size: 52.5vmin;
      font-weight: bold;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.05em;
      cursor: pointer;
    }

    #unit-display {
      font-size: 12vmin;
      color: #888;
      margin-top: 1.5rem;
    }

    #error-message {
      color: #ff4444;
      margin-top: 1rem;
      font-size: 1rem;
    }

    /* Hide error by default */
    #error-message:empty {
      display: none;
    }
  </style>
</head>
<body>
  <div id="permission-screen">
    <h1>Speedometer</h1>
    <p>Uses GPS to display your current speed</p>
    <div class="instructions">
      <strong>Location Required:</strong> This app requires GPS access. All location data stays on your device—nothing is sent anywhere. <a href="speedo_README.md" style="color: #0066cc;">Learn more</a><br><br>
      <strong>Controls:</strong><br>
      Single tap speed = Toggle HUD mirror mode<br>
      Double tap speed = Rotate 180°
    </div>
    <div id="install-hint" class="install-hint" style="display: none;">
      <strong>⚠️ Installation Required:</strong><br>
      For the location API to work, you must add this page to your homescreen:<br>
      <strong>Safari:</strong> Tap Share → Add to Home Screen
    </div>
    <button id="start-button">Start</button>
    <div id="error-message"></div>
  </div>

  <div id="speedometer">
    <div id="speed-display">0</div>
    <div id="unit-display">MPH</div>
  </div>

  <script>
    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    let currentSpeed = 0; // Speed in meters per second from GPS
    let watchId = null; // Geolocation watch handle
    let wakeLock = null; // Wake Lock API handle
    let noSleepAudio = null; // Silent audio for iOS wake lock fallback
    let lastTapTime = 0; // For detecting double-tap gestures

    // ============================================================================
    // DOM REFERENCES
    // ============================================================================
    const permissionScreen = document.getElementById('permission-screen');
    const speedometer = document.getElementById('speedometer');
    const speedDisplay = document.getElementById('speed-display');
    const errorMessage = document.getElementById('error-message');
    const startButton = document.getElementById('start-button');
    const installHint = document.getElementById('install-hint');

    // ============================================================================
    // INITIALIZATION - Detect standalone mode and show install hint if needed
    // ============================================================================
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                        window.navigator.standalone ||
                        document.referrer.includes('android-app://');

    if (!isStandalone) {
      installHint.style.display = 'block';
    }

    // ============================================================================
    // UTILITY FUNCTIONS - Speed conversion and display updates
    // ============================================================================
    function toMph(metersPerSecond) {
      return Math.round(metersPerSecond * 2.23694);
    }

    function updateDisplay() {
      const mph = toMph(currentSpeed);
      speedDisplay.textContent = mph;
    }

    // ============================================================================
    // GEOLOCATION HANDLING - GPS position updates and error handling
    // ============================================================================
    function handlePosition(position) {
      const speed = position.coords.speed;
      currentSpeed = (speed !== null && speed >= 0) ? speed : 0;
    }

    function handleError(error) {
      const messages = {
        1: 'Location permission denied. Please allow location access and try again.',
        2: 'Location unavailable. Please check your device settings.',
        3: 'Location request timeout. Please try again.'
      };

      errorMessage.textContent = messages[error.code] || 'Error: ' + error.message;
      permissionScreen.style.display = 'block';
      speedometer.style.display = 'none';
    }

    function startTracking() {
      if (!navigator.geolocation) {
        errorMessage.textContent = 'Geolocation is not supported by your browser';
        return;
      }

      errorMessage.textContent = '';

      const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      };

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          if (permissionScreen.style.display !== 'none') {
            permissionScreen.style.display = 'none';
            speedometer.style.display = 'block';
            requestWakeLock();
            setInterval(updateDisplay, 100); // 10Hz update rate for responsive display
          }
          handlePosition(position);
        },
        handleError,
        options
      );
    }

    // ============================================================================
    // WAKE LOCK MANAGEMENT - Prevent screen from sleeping during use
    // ============================================================================
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
            console.log('Wake lock released');
          });
        }
      } catch (err) {
        console.log('Wake lock failed:', err);
      }

      enableNoSleepAudio();
    }

    function enableNoSleepAudio() {
      if (!noSleepAudio) {
        const silentAudio = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4S/sTjCAAAAAAD/+xDEAAPAAAGkAAAAIAAANIAAAARMQU1FMy4xMDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/+xDEAAPAAAGkAAAAIAAANIAAAARMQU1FMy4xMDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/+xDEAAPAAAGkAAAAIAAANIAAAARMQU1FMy4xMDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=';
        noSleepAudio = new Audio(silentAudio);
        noSleepAudio.loop = true;
        noSleepAudio.play().catch(err => {
          console.log('Silent audio play failed:', err);
        });
      }
    }

    function disableNoSleepAudio() {
      if (noSleepAudio) {
        noSleepAudio.pause();
        noSleepAudio = null;
      }
    }

    // ============================================================================
    // EVENT HANDLERS - User interactions and gesture detection
    // ============================================================================
    startButton.addEventListener('click', startTracking);

    speedDisplay.addEventListener('click', () => {
      const currentTime = new Date().getTime();
      const tapGap = currentTime - lastTapTime;

      if (tapGap < 300 && tapGap > 0) {
        // Double tap - toggle rotation
        speedometer.classList.toggle('rotated');
      } else {
        // Single tap - toggle HUD mode (with delay to detect double tap)
        setTimeout(() => {
          const checkTime = new Date().getTime();
          if (checkTime - currentTime >= 300) {
            speedometer.classList.toggle('hud-mode');
          }
        }, 300);
      }

      lastTapTime = currentTime;
    });

    // ============================================================================
    // LIFECYCLE MANAGEMENT - Cleanup and visibility handling
    // ============================================================================
    window.addEventListener('beforeunload', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
      }
      if (wakeLock !== null) {
        wakeLock.release();
      }
      disableNoSleepAudio();
    });

    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible') {
        if (wakeLock !== null) {
          await requestWakeLock();
        }
        if (noSleepAudio && noSleepAudio.paused) {
          noSleepAudio.play().catch(err => {
            console.log('Failed to restart audio:', err);
          });
        }
      }
    });
  </script>
</body>
</html>
