<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Speedometer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      background: #000;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body {
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      /* Support for safe areas on notched devices */
      min-height: 100vh;
      min-height: -webkit-fill-available;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    #permission-screen {
      text-align: center;
      padding: 2rem;
    }

    #permission-screen h1 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }

    #permission-screen p {
      font-size: 1.1rem;
      margin-bottom: 2rem;
      color: #aaa;
    }

    #start-button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 1.5rem 3rem;
      font-size: 1.3rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    #start-button:hover {
      background: #0052a3;
    }

    #start-button:active {
      background: #003d7a;
    }

    #speedometer {
      display: none;
      text-align: center;
      width: 100%;
      position: relative;
    }

    /* HUD mode - mirror for windshield reflection */
    #speedometer.hud-mode {
      transform: scaleX(-1);
    }

    #speed-display {
      font-size: 52.5vmin;
      font-weight: bold;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.05em;
      cursor: pointer;
    }

    #unit-display {
      font-size: 12vmin;
      color: #888;
      margin-top: 1.5rem;
    }

    #error-message {
      color: #ff4444;
      margin-top: 1rem;
      font-size: 1rem;
    }

    /* Hide error by default */
    #error-message:empty {
      display: none;
    }
  </style>
</head>
<body>
  <div id="permission-screen">
    <h1>Speedometer</h1>
    <p>Uses GPS to display your current speed</p>
    <button id="start-button">Start</button>
    <div id="error-message"></div>
  </div>

  <div id="speedometer">
    <div id="speed-display">0</div>
    <div id="unit-display">MPH</div>
  </div>

  <script>
    // State
    let currentSpeed = 0; // in meters per second
    let watchId = null;
    let wakeLock = null;
    let noSleepAudio = null;

    // DOM elements
    const permissionScreen = document.getElementById('permission-screen');
    const speedometer = document.getElementById('speedometer');
    const speedDisplay = document.getElementById('speed-display');
    const errorMessage = document.getElementById('error-message');
    const startButton = document.getElementById('start-button');

    // Convert m/s to mph
    function toMph(metersPerSecond) {
      return Math.round(metersPerSecond * 2.23694);
    }

    // Update display (called once per second)
    function updateDisplay() {
      const mph = toMph(currentSpeed);
      speedDisplay.textContent = mph;
    }

    // Handle position updates (called as often as GPS provides data)
    function handlePosition(position) {
      // Get speed in m/s (may be null if not available)
      const speed = position.coords.speed;

      if (speed !== null && speed >= 0) {
        currentSpeed = speed;
      } else {
        // If speed is not available from GPS, set to 0
        currentSpeed = 0;
      }
    }

    // Handle geolocation errors
    function handleError(error) {
      const messages = {
        1: 'Location permission denied. Please allow location access and try again.',
        2: 'Location unavailable. Please check your device settings.',
        3: 'Location request timeout. Please try again.'
      };

      errorMessage.textContent = messages[error.code] || 'Error: ' + error.message;
    }

    // Request wake lock to keep screen on
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');

          // Re-acquire wake lock when visibility changes
          wakeLock.addEventListener('release', () => {
            console.log('Wake lock released');
          });
        }
      } catch (err) {
        console.log('Wake lock failed:', err);
      }

      // Fallback for iOS: use silent audio loop
      // This technique works on older iOS versions and as backup
      enableNoSleepAudio();
    }

    // Enable screen wake using silent audio (iOS fallback)
    function enableNoSleepAudio() {
      if (!noSleepAudio) {
        // Create a silent audio file using data URI (Web Audio API)
        // This is a tiny silent WebM audio file
        const silentAudio = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4S/sTjCAAAAAAD/+xDEAAPAAAGkAAAAIAAANIAAAARMQU1FMy4xMDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/+xDEAAPAAAGkAAAAIAAANIAAAARMQU1FMy4xMDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/+xDEAAPAAAGkAAAAIAAANIAAAARMQU1FMy4xMDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=';

        noSleepAudio = new Audio(silentAudio);
        noSleepAudio.loop = true;

        // Play the silent audio
        noSleepAudio.play().catch(err => {
          console.log('Silent audio play failed:', err);
        });
      }
    }

    // Disable the silent audio
    function disableNoSleepAudio() {
      if (noSleepAudio) {
        noSleepAudio.pause();
        noSleepAudio = null;
      }
    }

    // Start tracking speed
    function startTracking() {
      if (!navigator.geolocation) {
        errorMessage.textContent = 'Geolocation is not supported by your browser';
        return;
      }

      errorMessage.textContent = '';

      const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      };

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          // Hide permission screen and show speedometer on first successful position
          if (permissionScreen.style.display !== 'none') {
            permissionScreen.style.display = 'none';
            speedometer.style.display = 'block';

            // Request wake lock
            requestWakeLock();

            // Start display updates (once per second)
            setInterval(updateDisplay, 1000);
          }

          handlePosition(position);
        },
        handleError,
        options
      );
    }

    // Event listener for start button
    startButton.addEventListener('click', startTracking);

    // Event listener for speed display - toggle HUD mode on tap
    speedDisplay.addEventListener('click', () => {
      speedometer.classList.toggle('hud-mode');
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
      }
      if (wakeLock !== null) {
        wakeLock.release();
      }
      disableNoSleepAudio();
    });

    // Handle visibility change to re-acquire wake lock and restart audio
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible') {
        // Re-acquire wake lock
        if (wakeLock !== null) {
          await requestWakeLock();
        }
        // Restart silent audio if it was playing
        if (noSleepAudio && noSleepAudio.paused) {
          noSleepAudio.play().catch(err => {
            console.log('Failed to restart audio:', err);
          });
        }
      }
    });
  </script>
</body>
</html>
