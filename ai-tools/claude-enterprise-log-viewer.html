<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Audit Log Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
  {
    "imports": {
      "preact": "https://esm.sh/preact@10.23.1",
      "preact/": "https://esm.sh/preact@10.23.1/",
      "@preact/signals": "https://esm.sh/@preact/signals@1.3.0?external=preact",
      "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact",
      "jszip": "https://esm.sh/jszip@3.10.1",
      "papaparse": "https://esm.sh/papaparse@5.4.1"
    }
  }
  </script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app"></div>
  
  <script type="module">
    import { render } from 'preact';
    import { html } from 'htm/preact';
    import { signal, computed } from '@preact/signals';
    import { useEffect, useRef } from 'preact/hooks';
    import JSZip from 'jszip';
    import Papa from 'papaparse';

    // State management
    const logs = signal([]);
    const selectedLog = signal(null);
    const searchQuery = signal('');
    const filterEvent = signal('all');
    const filterCategory = signal('all');
    const isDragging = signal(false);
    const isLoading = signal(false);
    const error = signal(null);
    const statsExpanded = signal(true);
    const sortColumn = signal('created_at');
    const sortDirection = signal('desc');
    const dateRangeStart = signal('');
    const dateRangeEnd = signal('');

    // Get actor name for display/search
    function getActorName(log) {
      try {
        const actorData = log.actor_parsed;
        if (!actorData) return 'Unknown';
        
        return actorData.name || 
               actorData.metadata?.email_address ||
               actorData.email || 
               'Unknown';
      } catch (err) {
        return 'Unknown';
      }
    }

    // Categorize events based on prefix patterns
    function categorizeEvent(eventName) {
      if (!eventName) return 'Other';
      
      // Special cases
      if (eventName.startsWith('extra_usage_spend_limit_')) return 'Billing';
      
      // Extract prefix before first underscore
      const prefix = eventName.split('_')[0];
      
      const categoryMap = {
        'conversation': 'Conversations',
        'project': 'Projects',
        'user': 'Authentication',
        'org': 'Organization',
        'file': 'Files',
        'role': 'Permissions'
      };
      
      return categoryMap[prefix] || 'Other';
    }

    // Computed filtered logs
    const filteredLogs = computed(() => {
      let result = logs.value;
      
      // Filter by date range
      if (dateRangeStart.value || dateRangeEnd.value) {
        result = result.filter(log => {
          if (!log.created_date) return false;
          const logDate = new Date(log.created_date);
          logDate.setHours(0, 0, 0, 0); // Normalize to start of day
          
          if (dateRangeStart.value) {
            const startDate = new Date(dateRangeStart.value);
            startDate.setHours(0, 0, 0, 0);
            if (logDate < startDate) return false;
          }
          
          if (dateRangeEnd.value) {
            const endDate = new Date(dateRangeEnd.value);
            endDate.setHours(23, 59, 59, 999); // End of day
            if (logDate > endDate) return false;
          }
          
          return true;
        });
      }
      
      // Filter by category
      if (filterCategory.value !== 'all') {
        result = result.filter(log => categorizeEvent(log.event) === filterCategory.value);
      }
      
      // Filter by event type
      if (filterEvent.value !== 'all') {
        result = result.filter(log => log.event === filterEvent.value);
      }
      
      // Search across multiple fields including actor name
      if (searchQuery.value) {
        const query = searchQuery.value.toLowerCase();
        result = result.filter(log => {
          const actorName = getActorName(log).toLowerCase();
          return (
            log.event?.toLowerCase().includes(query) ||
            actorName.includes(query) ||
            log.actor_info?.toLowerCase().includes(query) ||
            log.event_info?.toLowerCase().includes(query) ||
            log.entity_info?.toLowerCase().includes(query) ||
            log.ip_address?.toLowerCase().includes(query)
          );
        });
      }
      
      // Sort
      result = [...result].sort((a, b) => {
        let aVal, bVal;
        
        switch (sortColumn.value) {
          case 'created_at':
            aVal = a.created_date || 0;
            bVal = b.created_date || 0;
            break;
          case 'event':
            aVal = a.event || '';
            bVal = b.event || '';
            break;
          case 'actor':
            aVal = getActorName(a);
            bVal = getActorName(b);
            break;
          case 'ip_address':
            aVal = a.ip_address || '';
            bVal = b.ip_address || '';
            break;
          case 'platform':
            aVal = a.client_platform || '';
            bVal = b.client_platform || '';
            break;
          default:
            return 0;
        }
        
        if (aVal < bVal) return sortDirection.value === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDirection.value === 'asc' ? 1 : -1;
        return 0;
      });
      
      return result;
    });

    // Get unique event types and categories for filter dropdown
    const eventTypes = computed(() => {
      const types = new Set(logs.value.map(log => log.event).filter(Boolean));
      return ['all', ...Array.from(types).sort()];
    });

    const eventCategories = computed(() => {
      const categories = new Set(logs.value.map(log => categorizeEvent(log.event)));
      return ['all', ...Array.from(categories).sort()];
    });

    // Parse JSON fields in CSV data (handles both JSON and Python dict strings)
    function parseJsonField(field) {
      if (!field) return null;
      try {
        // Try parsing as-is first (for valid JSON)
        return JSON.parse(field);
      } catch {
        try {
          // Convert Python dict syntax to JSON (single quotes to double quotes)
          const jsonString = field
            .replace(/'/g, '"')  // Replace single quotes with double quotes
            .replace(/None/g, 'null')  // Replace Python None with JSON null
            .replace(/True/g, 'true')  // Replace Python True with JSON true
            .replace(/False/g, 'false');  // Replace Python False with JSON false
          return JSON.parse(jsonString);
        } catch {
          return field;  // Return as-is if parsing fails
        }
      }
    }

    // Process uploaded zip file
    async function handleFile(file) {
      if (!file.name.endsWith('.zip')) {
        error.value = 'Please upload a .zip file';
        return;
      }

      isLoading.value = true;
      error.value = null;

      try {
        const zip = new JSZip();
        const contents = await zip.loadAsync(file);
        
        // Find the CSV file (should be audit_logs.csv or audit_log.csv)
        const csvFile = Object.keys(contents.files).find(name => 
          name.toLowerCase().includes('audit') && name.endsWith('.csv')
        );

        if (!csvFile) {
          throw new Error('No audit log CSV found in zip file');
        }

        const csvContent = await contents.files[csvFile].async('text');
        
        // Parse CSV
        const result = Papa.parse(csvContent, {
          header: true,
          dynamicTyping: false,
          skipEmptyLines: true,
          transformHeader: (header) => header.trim()
        });

        if (result.errors.length > 0) {
          console.warn('CSV parsing warnings:', result.errors);
        }

        // Process and enrich data
        const processed = result.data.map((row, index) => ({
          ...row,
          id: index,
          actor_parsed: parseJsonField(row.actor_info),
          event_parsed: parseJsonField(row.event_info),
          entity_parsed: parseJsonField(row.entity_info),
          created_date: row.created_at ? new Date(row.created_at) : null
        }));

        logs.value = processed;
        selectedLog.value = null;
      } catch (err) {
        error.value = err.message;
        console.error('Error processing file:', err);
      } finally {
        isLoading.value = false;
      }
    }

    // File upload component
    function FileUpload() {
      const fileInputRef = useRef(null);

      const handleDragOver = (e) => {
        e.preventDefault();
        isDragging.value = true;
      };

      const handleDragLeave = (e) => {
        e.preventDefault();
        isDragging.value = false;
      };

      const handleDrop = (e) => {
        e.preventDefault();
        isDragging.value = false;
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
      };

      const handleFileInput = (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
      };

      if (logs.value.length > 0) return null;

      return html`
        <div class="max-w-2xl mx-auto mt-16 p-8">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">Claude Audit Log Viewer</h1>
          <p class="text-gray-600 mb-8">Upload or drag & drop your audit log zip archive</p>
          
          <div
            class="${isDragging.value ? 'border-blue-500 bg-blue-50' : 'border-gray-300'} border-2 border-dashed rounded-lg p-12 text-center cursor-pointer transition-colors"
            onDragOver=${handleDragOver}
            onDragLeave=${handleDragLeave}
            onDrop=${handleDrop}
            onClick=${() => fileInputRef.current?.click()}
          >
            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
              <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <p class="mt-4 text-sm text-gray-600">
              <span class="font-semibold text-blue-600">Click to upload</span> or drag and drop
            </p>
            <p class="mt-1 text-xs text-gray-500">ZIP file containing audit_logs.csv</p>
            <input
              ref=${fileInputRef}
              type="file"
              accept=".zip"
              class="hidden"
              onChange=${handleFileInput}
            />
          </div>

          ${error.value && html`
            <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
              <p class="text-sm text-red-600">${error.value}</p>
            </div>
          `}

          ${isLoading.value && html`
            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <p class="text-sm text-blue-600">Processing file...</p>
            </div>
          `}
        </div>
      `;
    }

    // Export functionality - flatten parsed objects into columns
    function exportToCSV(data, filename = 'audit_logs_export.csv') {
      // Helper to convert object to key: value text block
      const objectToTextBlock = (obj, prefix = '') => {
        if (!obj || typeof obj !== 'object') return '';
        
        const lines = [];
        Object.entries(obj).forEach(([key, value]) => {
          const fullKey = prefix ? `${prefix}.${key}` : key;
          if (value && typeof value === 'object' && !Array.isArray(value)) {
            // Nested object - recurse
            lines.push(objectToTextBlock(value, fullKey));
          } else if (Array.isArray(value)) {
            lines.push(`${fullKey}: [${value.join(', ')}]`);
          } else {
            lines.push(`${fullKey}: ${value}`);
          }
        });
        return lines.filter(Boolean).join('\n');
      };

      // Flatten nested objects into separate columns
      const flattenedData = data.map(row => {
        const flatRow = {
          created_at: row.created_at,
          event: row.event,
          event_category: categorizeEvent(row.event),
          ip_address: row.ip_address,
          device_id: row.device_id,
          user_agent: row.user_agent,
          client_platform: row.client_platform
        };

        // Flatten actor_parsed
        if (row.actor_parsed) {
          flatRow.actor_name = row.actor_parsed.name || '';
          flatRow.actor_type = row.actor_parsed.type || '';
          flatRow.actor_uuid = row.actor_parsed.uuid || '';
          flatRow.actor_email = row.actor_parsed.metadata?.email_address || '';
        }

        // Add full event details as text block
        flatRow.event_details = objectToTextBlock(row.event_parsed);

        // Add full entity details as text block
        flatRow.entity_details = objectToTextBlock(row.entity_parsed);

        return flatRow;
      });
      
      const csv = Papa.unparse(flattenedData);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // Toolbar component
    function Toolbar() {
      const handleReset = () => {
        logs.value = [];
        selectedLog.value = null;
        searchQuery.value = '';
        filterEvent.value = 'all';
        filterCategory.value = 'all';
        dateRangeStart.value = '';
        dateRangeEnd.value = '';
        error.value = null;
      };

      const handleExportAll = () => {
        exportToCSV(logs.value, 'all_audit_logs.csv');
      };

      const handleExportFiltered = () => {
        exportToCSV(filteredLogs.value, 'filtered_audit_logs.csv');
      };

      const setDatePreset = (days) => {
        const end = new Date();
        const start = new Date();
        start.setDate(start.getDate() - days);
        
        dateRangeStart.value = start.toISOString().split('T')[0];
        dateRangeEnd.value = end.toISOString().split('T')[0];
      };

      const clearDateRange = () => {
        dateRangeStart.value = '';
        dateRangeEnd.value = '';
      };

      return html`
        <div class="bg-white border-b border-gray-200 px-6 py-4 sticky top-0 z-20 shadow-sm">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h1 class="text-2xl font-bold text-gray-900">Audit Logs</h1>
              <p class="text-sm text-gray-500 mt-1">
                ${filteredLogs.value.length} of ${logs.value.length} records
              </p>
            </div>
            <div class="flex gap-2">
              <button
                onClick=${handleExportAll}
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                Export All
              </button>
              <button
                onClick=${handleExportFiltered}
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                disabled=${filteredLogs.value.length === logs.value.length}
              >
                Export Filtered
              </button>
              <button
                onClick=${handleReset}
                class="px-4 py-2 text-sm font-medium text-red-700 bg-white border border-red-300 rounded-lg hover:bg-red-50"
              >
                Load New File
              </button>
            </div>
          </div>

          <div class="flex gap-4 mb-3">
            <div class="flex-1">
              <input
                type="text"
                placeholder="Search events, actors, IPs..."
                value=${searchQuery.value}
                onInput=${(e) => searchQuery.value = e.target.value}
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <div class="w-48">
              <select
                value=${filterCategory.value}
                onChange=${(e) => filterCategory.value = e.target.value}
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                ${eventCategories.value.map(category => html`
                  <option value=${category}>
                    ${category === 'all' ? 'All Categories' : category}
                  </option>
                `)}
              </select>
            </div>
            <div class="w-64">
              <select
                value=${filterEvent.value}
                onChange=${(e) => filterEvent.value = e.target.value}
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                ${eventTypes.value.map(type => html`
                  <option value=${type}>
                    ${type === 'all' ? 'All Events' : type}
                  </option>
                `)}
              </select>
            </div>
          </div>

          <!-- Date Range Filter -->
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              <label class="text-sm font-medium text-gray-700">From:</label>
              <input
                type="date"
                value=${dateRangeStart.value}
                onInput=${(e) => dateRangeStart.value = e.target.value}
                class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            
            <div class="flex items-center gap-2">
              <label class="text-sm font-medium text-gray-700">To:</label>
              <input
                type="date"
                value=${dateRangeEnd.value}
                onInput=${(e) => dateRangeEnd.value = e.target.value}
                class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div class="flex gap-1 ml-2">
              <button
                onClick=${() => setDatePreset(7)}
                class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                Last 7d
              </button>
              <button
                onClick=${() => setDatePreset(30)}
                class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                Last 30d
              </button>
              <button
                onClick=${() => setDatePreset(90)}
                class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                Last 90d
              </button>
              ${(dateRangeStart.value || dateRangeEnd.value) && html`
                <button
                  onClick=${clearDateRange}
                  class="px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-300 rounded-lg hover:bg-blue-100"
                >
                  Clear
                </button>
              `}
            </div>
          </div>
        </div>
      `;
    }

    // Statistics component
    function Statistics() {
      const stats = computed(() => {
        const data = filteredLogs.value;
        if (data.length === 0) return null;

        // Build user profiles with all their activity
        const userProfiles = {};
        data.forEach(log => {
          try {
            const actorData = log.actor_parsed;
            if (!actorData) return;
            
            const userId = actorData.uuid || 'unknown';
            const userName = actorData.name || actorData.metadata?.email_address || 'Unknown User';
            const userEmail = actorData.metadata?.email_address || '';

            if (!userProfiles[userId]) {
              userProfiles[userId] = {
                id: userId,
                name: userName,
                email: userEmail,
                totalEvents: 0,
                events: {},
                ips: new Set(),
                firstSeen: log.created_date,
                lastSeen: log.created_date
              };
            }

            const profile = userProfiles[userId];
            profile.totalEvents++;
            profile.events[log.event] = (profile.events[log.event] || 0) + 1;
            if (log.ip_address) profile.ips.add(log.ip_address);
            if (log.created_date < profile.firstSeen) profile.firstSeen = log.created_date;
            if (log.created_date > profile.lastSeen) profile.lastSeen = log.created_date;
          } catch (e) {
            // Skip if parsing fails
          }
        });

        // Top users by activity
        const topUsers = Object.values(userProfiles)
          .sort((a, b) => b.totalEvents - a.totalEvents)
          .slice(0, 10)
          .map(user => ({
            ...user,
            ips: Array.from(user.ips)
          }));

        // Event type distribution
        const eventCounts = {};
        data.forEach(log => {
          eventCounts[log.event] = (eventCounts[log.event] || 0) + 1;
        });

        // Category distribution
        const categoryCounts = {};
        data.forEach(log => {
          const category = categorizeEvent(log.event);
          categoryCounts[category] = (categoryCounts[category] || 0) + 1;
        });

        // Categorize events for admin insights
        const adminEvents = ['org_user_invite_accepted', 'org_user_added', 'org_user_removed', 'org_settings_changed'];
        const contentEvents = ['conversation_created', 'conversation_deleted', 'conversation_renamed'];
        const securityEvents = ['login', 'logout', 'password_changed', 'mfa_enabled'];

        const eventCategories = {
          admin: data.filter(log => adminEvents.includes(log.event)).length,
          content: data.filter(log => contentEvents.includes(log.event)).length,
          security: data.filter(log => securityEvents.includes(log.event)).length,
          other: data.filter(log => !adminEvents.includes(log.event) && 
                                    !contentEvents.includes(log.event) && 
                                    !securityEvents.includes(log.event)).length
        };

        // Users with multiple IPs (potential security concern)
        const multiIPUsers = Object.values(userProfiles)
          .filter(user => user.ips.size > 1)
          .sort((a, b) => b.ips.size - a.ips.size)
          .slice(0, 5)
          .map(user => ({
            ...user,
            ips: Array.from(user.ips)
          }));

        // Activity timeline (last 24 hours by hour, or days if spanning longer)
        const dates = data.map(log => log.created_date).filter(Boolean).sort((a, b) => a - b);
        const dateRange = dates.length > 0 ? {
          earliest: dates[0],
          latest: dates[dates.length - 1],
          spanDays: Math.ceil((dates[dates.length - 1] - dates[0]) / (1000 * 60 * 60 * 24))
        } : null;

        // Activity by hour/day
        const activityByTime = {};
        data.forEach(log => {
          if (!log.created_date) return;
          const date = new Date(log.created_date);
          const key = dateRange?.spanDays > 7 
            ? date.toLocaleDateString() 
            : `${date.toLocaleDateString()} ${date.getHours()}:00`;
          activityByTime[key] = (activityByTime[key] || 0) + 1;
        });

        const timelineData = Object.entries(activityByTime)
          .sort(([a], [b]) => a.localeCompare(b))
          .slice(-20); // Last 20 time periods

        // Top event types
        const topEvents = Object.entries(eventCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 8);

        // Most active content creators/deleters
        const contentActivity = {};
        data.filter(log => contentEvents.includes(log.event)).forEach(log => {
          try {
            const actorData = log.actor_parsed;
            if (!actorData) return;
            const userName = actorData.name || actorData.metadata?.email_address || 'Unknown';
            if (!contentActivity[userName]) {
              contentActivity[userName] = { created: 0, deleted: 0, renamed: 0 };
            }
            if (log.event === 'conversation_created') contentActivity[userName].created++;
            if (log.event === 'conversation_deleted') contentActivity[userName].deleted++;
            if (log.event === 'conversation_renamed') contentActivity[userName].renamed++;
          } catch (e) {}
        });

        // Daily conversations and projects by date
        const conversationEvents = data.filter(log => log.event === 'conversation_created' && log.created_date);
        const projectEvents = data.filter(log => log.event === 'project_created' && log.created_date);
        
        const conversationsByDay = {};
        const projectsByDay = {};
        
        conversationEvents.forEach(log => {
          const dateKey = new Date(log.created_date).toLocaleDateString();
          conversationsByDay[dateKey] = (conversationsByDay[dateKey] || 0) + 1;
        });
        
        projectEvents.forEach(log => {
          const dateKey = new Date(log.created_date).toLocaleDateString();
          projectsByDay[dateKey] = (projectsByDay[dateKey] || 0) + 1;
        });

        // Get all unique dates and sort
        const allDates = new Set([...Object.keys(conversationsByDay), ...Object.keys(projectsByDay)]);
        const sortedDates = Array.from(allDates).sort((a, b) => new Date(a) - new Date(b));
        
        // Create daily activity data with both series
        const dailyActivity = sortedDates.map(date => ({
          date,
          conversations: conversationsByDay[date] || 0,
          projects: projectsByDay[date] || 0
        }));

        return {
          totalEvents: data.length,
          uniqueUsersCount: Object.keys(userProfiles).length,
          topUsers,
          eventCounts,
          categoryCounts,
          eventCategories,
          multiIPUsers,
          dateRange,
          timelineData,
          topEvents,
          contentActivity: Object.entries(contentActivity)
            .sort((a, b) => (b[1].created + b[1].deleted + b[1].renamed) - (a[1].created + a[1].deleted + a[1].renamed))
            .slice(0, 5),
          dailyActivity
        };
      });

      if (!stats.value) return null;

      const StatCard = ({ title, value, subtitle, icon, trend }) => html`
        <div class="bg-gradient-to-br from-white to-gray-50 rounded-lg border border-gray-200 p-4">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">${title}</p>
              <p class="mt-2 text-3xl font-bold text-gray-900">${value}</p>
              ${subtitle && html`<p class="mt-1 text-xs text-gray-600">${subtitle}</p>`}
              ${trend && html`<p class="mt-1 text-xs font-medium ${trend.positive ? 'text-green-600' : 'text-red-600'}">${trend.text}</p>`}
            </div>
            ${icon && html`
              <div class="ml-3 text-gray-400">
                ${icon}
              </div>
            `}
          </div>
        </div>
      `;

      return html`
        <div class="bg-white border-b border-gray-200">
          <button
            onClick=${() => statsExpanded.value = !statsExpanded.value}
            class="w-full px-6 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors"
          >
            <div class="flex items-center gap-2">
              <svg 
                class="w-5 h-5 text-gray-600 transition-transform ${statsExpanded.value ? 'rotate-90' : ''}"
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <h3 class="text-sm font-semibold text-gray-900">Analytics Dashboard</h3>
            </div>
            <span class="text-xs text-gray-500">
              ${stats.value.dateRange 
                ? `${formatDate(stats.value.dateRange.earliest)} - ${formatDate(stats.value.dateRange.latest)}`
                : ''}
            </span>
          </button>

          ${statsExpanded.value && html`
            <div class="px-6 pb-6 pt-2">
              <!-- Summary Cards -->
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <${StatCard}
                  title="Total Events"
                  value=${stats.value.totalEvents.toLocaleString()}
                  subtitle=${stats.value.dateRange ? `${stats.value.dateRange.spanDays} day span` : ''}
                  icon=${html`
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                  `}
                />
                
                <${StatCard}
                  title="Active Users"
                  value=${stats.value.uniqueUsersCount}
                  subtitle="Unique users in period"
                  icon=${html`
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                  `}
                />
                
                <${StatCard}
                  title="Admin Actions"
                  value=${stats.value.eventCategories.admin}
                  subtitle="Organization changes"
                  icon=${html`
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  `}
                />
                
                <${StatCard}
                  title="Security Alerts"
                  value=${stats.value.multiIPUsers.length}
                  subtitle="Users with multiple IPs"
                  icon=${html`
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                  `}
                />
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Top Active Users -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                  <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Top Active Users
                  </h4>
                  <div class="space-y-3">
                    ${stats.value.topUsers.slice(0, 5).map((user, idx) => html`
                      <div class="flex items-start gap-3 p-2 rounded-lg hover:bg-gray-50">
                        <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center text-xs font-bold">
                          ${idx + 1}
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-gray-900 truncate">${user.name}</p>
                          <p class="text-xs text-gray-500 truncate">${user.email}</p>
                          <div class="flex gap-2 mt-1">
                            <span class="text-xs text-gray-600">${user.totalEvents} events</span>
                            <span class="text-xs text-gray-400">•</span>
                            <span class="text-xs text-gray-600">${user.ips.length} IP${user.ips.length > 1 ? 's' : ''}</span>
                          </div>
                        </div>
                      </div>
                    `)}
                  </div>
                </div>

                <!-- Security: Multi-IP Users -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                  <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    Multiple IP Addresses
                  </h4>
                  ${stats.value.multiIPUsers.length === 0 ? html`
                    <p class="text-sm text-gray-500 italic">No users with multiple IPs detected</p>
                  ` : html`
                    <div class="space-y-3">
                      ${stats.value.multiIPUsers.map(user => html`
                        <div class="p-2 rounded-lg bg-amber-50 border border-amber-200">
                          <p class="text-sm font-medium text-gray-900 truncate">${user.name}</p>
                          <p class="text-xs text-gray-600 mt-1">${user.ips.length} different IPs:</p>
                          <div class="mt-1 flex flex-wrap gap-1">
                            ${user.ips.slice(0, 3).map(ip => html`
                              <span class="text-xs font-mono bg-white px-2 py-0.5 rounded border border-amber-300">${ip}</span>
                            `)}
                            ${user.ips.length > 3 && html`
                              <span class="text-xs text-gray-500">+${user.ips.length - 3} more</span>
                            `}
                          </div>
                        </div>
                      `)}
                    </div>
                  `}
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Event Category Distribution -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                  <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 4 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    Event Categories
                  </h4>
                  <div class="space-y-2">
                    ${Object.entries(stats.value.categoryCounts).sort((a, b) => b[1] - a[1]).map(([category, count]) => {
                      const percentage = (count / stats.value.totalEvents * 100).toFixed(1);
                      return html`
                        <div>
                          <div class="flex justify-between text-xs mb-1">
                            <span class="font-medium text-gray-700 truncate mr-2">${category}</span>
                            <span class="text-gray-500">${count} (${percentage}%)</span>
                          </div>
                          <div class="w-full bg-gray-200 rounded-full h-2">
                            <div 
                              class="bg-purple-500 h-2 rounded-full transition-all"
                              style="width: ${percentage}%"
                            ></div>
                          </div>
                        </div>
                      `;
                    })}
                  </div>
                </div>

                <!-- Event Type Distribution -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                  <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 4 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                    Top Event Types
                  </h4>
                  <div class="space-y-2">
                    ${stats.value.topEvents.map(([name, count]) => {
                      const percentage = (count / stats.value.totalEvents * 100).toFixed(1);
                      return html`
                        <div>
                          <div class="flex justify-between text-xs mb-1">
                            <span class="font-medium text-gray-700 truncate mr-2">${name}</span>
                            <span class="text-gray-500">${count} (${percentage}%)</span>
                          </div>
                          <div class="w-full bg-gray-200 rounded-full h-2">
                            <div 
                              class="bg-blue-500 h-2 rounded-full transition-all"
                              style="width: ${percentage}%"
                            ></div>
                          </div>
                        </div>
                      `;
                    })}
                  </div>
                </div>

                <!-- Content Activity -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                  <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                    Content Activity Leaders
                  </h4>
                  ${stats.value.contentActivity.length === 0 ? html`
                    <p class="text-sm text-gray-500 italic">No content activity in filtered period</p>
                  ` : html`
                    <div class="space-y-2">
                      ${stats.value.contentActivity.map(([name, activity]) => html`
                        <div class="p-2 rounded-lg border border-gray-200">
                          <p class="text-sm font-medium text-gray-900 truncate mb-1">${name}</p>
                          <div class="flex gap-3 text-xs">
                            <span class="text-green-600">✓ ${activity.created} created</span>
                            <span class="text-red-600">✗ ${activity.deleted} deleted</span>
                            <span class="text-blue-600">✎ ${activity.renamed} renamed</span>
                          </div>
                        </div>
                      `)}
                    </div>
                  `}
                </div>
              </div>

              <!-- Daily Activity Chart -->
              ${stats.value.dailyActivity.length > 0 && html`
                <div class="mt-6 bg-white border border-gray-200 rounded-lg p-6">
                  <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Daily Activity Over Time
                  </h4>
                  
                  <!-- Legend -->
                  <div class="flex gap-6 mb-4">
                    <div class="flex items-center gap-2">
                      <div class="w-4 h-4 bg-blue-500 rounded"></div>
                      <span class="text-sm text-gray-700">Conversations</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <div class="w-4 h-4 bg-purple-500 rounded"></div>
                      <span class="text-sm text-gray-700">Projects</span>
                    </div>
                  </div>

                  <div class="relative">
                    ${(() => {
                      const data = stats.value.dailyActivity;
                      const maxConv = Math.max(...data.map(d => d.conversations), 1);
                      const maxProj = Math.max(...data.map(d => d.projects), 1);
                      
                      const chartHeight = 300;
                      const chartWidth = Math.max(800, data.length * 40); // Responsive width
                      const padding = { top: 20, right: 60, bottom: 80, left: 60 };
                      const plotHeight = chartHeight - padding.top - padding.bottom;
                      const plotWidth = chartWidth - padding.left - padding.right;
                      const barWidth = plotWidth / data.length * 0.35; // Each series gets 35% of space

                      // Format date for display
                      const formatDate = (dateStr) => {
                        const d = new Date(dateStr);
                        return `${d.getMonth() + 1}/${d.getDate()}`;
                      };

                      return html`
                        <div class="overflow-x-auto">
                          <svg width="${chartWidth}" height="${chartHeight}">
                            <!-- Left Y-axis (Conversations) -->
                            <text x="20" y="${padding.top - 5}" class="text-xs fill-blue-600 font-medium">Conversations</text>
                            ${[0, 1, 2, 3, 4].map(i => {
                              const value = Math.round(maxConv * i / 4);
                              const y = padding.top + plotHeight - (plotHeight * i / 4);
                              return html`
                                <g key=${i}>
                                  <line x1="${padding.left - 5}" y1="${y}" x2="${padding.left}" y2="${y}" 
                                    stroke="#94a3b8" stroke-width="1" />
                                  <text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" 
                                    class="text-xs fill-blue-600">${value}</text>
                                  <line x1="${padding.left}" y1="${y}" x2="${padding.left + plotWidth}" y2="${y}" 
                                    stroke="#e5e7eb" stroke-width="1" />
                                </g>
                              `;
                            })}

                            <!-- Right Y-axis (Projects) -->
                            <text x="${chartWidth - 50}" y="${padding.top - 5}" text-anchor="end" class="text-xs fill-purple-600 font-medium">Projects</text>
                            ${[0, 1, 2, 3, 4].map(i => {
                              const value = Math.round(maxProj * i / 4);
                              const y = padding.top + plotHeight - (plotHeight * i / 4);
                              return html`
                                <g key=${i}>
                                  <line x1="${padding.left + plotWidth}" y1="${y}" 
                                    x2="${padding.left + plotWidth + 5}" y2="${y}" 
                                    stroke="#94a3b8" stroke-width="1" />
                                  <text x="${padding.left + plotWidth + 10}" y="${y + 4}" 
                                    class="text-xs fill-purple-600">${value}</text>
                                </g>
                              `;
                            })}

                            <!-- Bars and X-axis labels -->
                            ${data.map((d, i) => {
                              const x = padding.left + (i / data.length) * plotWidth;
                              const convHeight = (d.conversations / maxConv) * plotHeight;
                              const projHeight = (d.projects / maxProj) * plotHeight;
                              
                              return html`
                                <g key=${i}>
                                  <!-- Conversation bar (left) -->
                                  <rect
                                    x="${x}"
                                    y="${padding.top + plotHeight - convHeight}"
                                    width="${barWidth}"
                                    height="${convHeight}"
                                    fill="rgb(59, 130, 246)"
                                    opacity="0.8"
                                  />
                                  
                                  <!-- Project bar (right) -->
                                  <rect
                                    x="${x + barWidth + 2}"
                                    y="${padding.top + plotHeight - projHeight}"
                                    width="${barWidth}"
                                    height="${projHeight}"
                                    fill="rgb(168, 85, 247)"
                                    opacity="0.8"
                                  />
                                  
                                  <!-- X-axis date label -->
                                  <text
                                    x="${x + barWidth}"
                                    y="${padding.top + plotHeight + 15}"
                                    text-anchor="middle"
                                    class="text-xs fill-gray-600"
                                    transform="rotate(45, ${x + barWidth}, ${padding.top + plotHeight + 15})"
                                  >
                                    ${formatDate(d.date)}
                                  </text>
                                </g>
                              `;
                            })}

                            <!-- Axes -->
                            <line x1="${padding.left}" y1="${padding.top}" 
                              x2="${padding.left}" y2="${padding.top + plotHeight}" 
                              stroke="#374151" stroke-width="2" />
                            <line x1="${padding.left}" y1="${padding.top + plotHeight}" 
                              x2="${padding.left + plotWidth}" y2="${padding.top + plotHeight}" 
                              stroke="#374151" stroke-width="2" />
                            <line x1="${padding.left + plotWidth}" y1="${padding.top}" 
                              x2="${padding.left + plotWidth}" y2="${padding.top + plotHeight}" 
                              stroke="#374151" stroke-width="2" />
                          </svg>
                        </div>

                        <!-- Summary Stats -->
                        <div class="mt-6 grid grid-cols-2 gap-6">
                          <div class="border-l-4 border-blue-500 pl-4">
                            <p class="text-xs text-gray-500 uppercase font-medium mb-2">Conversations</p>
                            <div class="grid grid-cols-3 gap-3">
                              <div>
                                <p class="text-xs text-gray-500">Total</p>
                                <p class="text-lg font-bold text-gray-900">${data.reduce((sum, d) => sum + d.conversations, 0)}</p>
                              </div>
                              <div>
                                <p class="text-xs text-gray-500">Peak Day</p>
                                <p class="text-lg font-bold text-gray-900">${maxConv}</p>
                              </div>
                              <div>
                                <p class="text-xs text-gray-500">Avg/Day</p>
                                <p class="text-lg font-bold text-gray-900">${(data.reduce((sum, d) => sum + d.conversations, 0) / data.length).toFixed(1)}</p>
                              </div>
                            </div>
                          </div>
                          
                          <div class="border-l-4 border-purple-500 pl-4">
                            <p class="text-xs text-gray-500 uppercase font-medium mb-2">Projects</p>
                            <div class="grid grid-cols-3 gap-3">
                              <div>
                                <p class="text-xs text-gray-500">Total</p>
                                <p class="text-lg font-bold text-gray-900">${data.reduce((sum, d) => sum + d.projects, 0)}</p>
                              </div>
                              <div>
                                <p class="text-xs text-gray-500">Peak Day</p>
                                <p class="text-lg font-bold text-gray-900">${maxProj}</p>
                              </div>
                              <div>
                                <p class="text-xs text-gray-500">Avg/Day</p>
                                <p class="text-lg font-bold text-gray-900">${(data.reduce((sum, d) => sum + d.projects, 0) / data.length).toFixed(1)}</p>
                              </div>
                            </div>
                          </div>
                        </div>
                      `;
                    })()}
                  </div>
                </div>
              `}
            </div>
          `}
        </div>
      `;
    }

    // Format date for display
    function formatDate(date) {
      if (!date) return 'N/A';
      return new Date(date).toLocaleString();
    }

    // Detail card component
    function DetailCard({ log }) {
      if (!log) return null;

      // Render a value based on its type
      const renderValue = (value, depth = 0) => {
        if (value === null || value === undefined || value === '') {
          return html`<span class="text-gray-400 italic">N/A</span>`;
        }
        
        if (typeof value === 'boolean') {
          return html`<span class="text-sm font-medium ${value ? 'text-green-600' : 'text-red-600'}">${value.toString()}</span>`;
        }
        
        if (typeof value === 'number') {
          return html`<span class="text-sm font-mono text-gray-900">${value}</span>`;
        }
        
        if (typeof value === 'string') {
          // Check if it's a URL
          if (value.startsWith('http://') || value.startsWith('https://')) {
            return html`<a href="${value}" target="_blank" class="text-sm text-blue-600 hover:underline break-all">${value}</a>`;
          }
          return html`<span class="text-sm text-gray-900 break-all">${value}</span>`;
        }
        
        if (Array.isArray(value)) {
          if (value.length === 0) return html`<span class="text-gray-400 italic">Empty array</span>`;
          return html`
            <div class="space-y-1 mt-1">
              ${value.map((item, idx) => html`
                <div class="pl-3 border-l-2 border-gray-200">
                  <span class="text-xs text-gray-500">[${idx}]</span>
                  ${renderValue(item, depth + 1)}
                </div>
              `)}
            </div>
          `;
        }
        
        if (typeof value === 'object') {
          return renderObject(value, depth);
        }
        
        return html`<span class="text-sm text-gray-900">${String(value)}</span>`;
      };

      // Render an object's keys and values
      const renderObject = (obj, depth = 0) => {
        const entries = Object.entries(obj);
        if (entries.length === 0) {
          return html`<span class="text-gray-400 italic">Empty object</span>`;
        }
        
        return html`
          <div class="space-y-2 ${depth > 0 ? 'mt-1 pl-3 border-l-2 border-gray-200' : ''}">
            ${entries.map(([key, value]) => html`
              <div>
                <div class="text-xs font-medium text-gray-600 mb-0.5">${key}</div>
                <div class="ml-2">${renderValue(value, depth + 1)}</div>
              </div>
            `)}
          </div>
        `;
      };

      // Render a section with a title and content
      const renderSection = (title, data) => {
        if (!data || (typeof data === 'object' && Object.keys(data).length === 0)) {
          return html`
            <div class="border-b border-gray-100 pb-4">
              <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">${title}</h4>
              <span class="text-gray-400 italic">No data</span>
            </div>
          `;
        }

        return html`
          <div class="border-b border-gray-100 pb-4">
            <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">${title}</h4>
            ${typeof data === 'object' ? renderObject(data) : renderValue(data)}
          </div>
        `;
      };

      return html`
        <div class="bg-white border-l-4 border-blue-500 shadow-lg rounded-lg p-6">
          <div class="flex justify-between items-start mb-6">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">Event Details</h3>
              <p class="text-xs text-gray-500 mt-1">${formatDate(log.created_at)}</p>
            </div>
            <button
              onClick=${() => selectedLog.value = null}
              class="text-gray-400 hover:text-gray-600 transition-colors"
              aria-label="Close"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <!-- Event Type Badge -->
            <div class="border-b border-gray-100 pb-4">
              <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Event Type</h4>
              <div class="flex gap-2">
                <span class="inline-block px-3 py-1 text-sm font-medium text-blue-700 bg-blue-100 rounded-full">
                  ${log.event}
                </span>
                <span class="inline-block px-3 py-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-full">
                  ${categorizeEvent(log.event)}
                </span>
              </div>
            </div>

            ${renderSection('Actor Information', log.actor_parsed)}
            ${renderSection('Event Information', log.event_parsed)}
            ${renderSection('Entity Information', log.entity_parsed)}

            <!-- Technical Details -->
            <div class="border-b border-gray-100 pb-4">
              <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Technical Details</h4>
              <div class="space-y-2">
                <div>
                  <div class="text-xs font-medium text-gray-600 mb-0.5">IP Address</div>
                  <div class="ml-2">
                    <span class="text-sm font-mono text-gray-900">${log.ip_address || 'N/A'}</span>
                  </div>
                </div>
                <div>
                  <div class="text-xs font-medium text-gray-600 mb-0.5">Device ID</div>
                  <div class="ml-2">
                    <span class="text-sm font-mono text-gray-900">${log.device_id || 'N/A'}</span>
                  </div>
                </div>
                <div>
                  <div class="text-xs font-medium text-gray-600 mb-0.5">Client Platform</div>
                  <div class="ml-2">
                    <span class="text-sm text-gray-900">${log.client_platform || 'N/A'}</span>
                  </div>
                </div>
                <div>
                  <div class="text-xs font-medium text-gray-600 mb-0.5">User Agent</div>
                  <div class="ml-2">
                    <span class="text-xs text-gray-700 break-all">${log.user_agent || 'N/A'}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Grid row component
    function GridRow({ log, isSelected }) {
      return html`
        <tr
          onClick=${() => selectedLog.value = log}
          class="${isSelected ? 'bg-blue-50 border-l-4 border-l-blue-500' : 'hover:bg-gray-50'} cursor-pointer border-b border-gray-200 transition-colors"
        >
          <td class="px-6 py-4 text-sm text-gray-500 font-mono">
            ${formatDate(log.created_at)}
          </td>
          <td class="px-6 py-4 text-sm font-medium text-gray-900">
            ${log.event}
          </td>
          <td class="px-6 py-4 text-sm text-gray-700">
            ${getActorName(log)}
          </td>
          <td class="px-6 py-4 text-sm font-mono text-gray-600">
            ${log.ip_address || 'N/A'}
          </td>
          <td class="px-6 py-4 text-sm text-gray-600">
            ${log.client_platform || 'N/A'}
          </td>
        </tr>
      `;
    }

    // Main grid component
    function Grid() {
      const handleSort = (column) => {
        if (sortColumn.value === column) {
          sortDirection.value = sortDirection.value === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn.value = column;
          sortDirection.value = 'desc';
        }
      };

      const SortableHeader = ({ column, label }) => {
        const isActive = sortColumn.value === column;
        const isAsc = sortDirection.value === 'asc';
        
        return html`
          <th 
            onClick=${() => handleSort(column)}
            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors select-none bg-gray-50"
          >
            <div class="flex items-center gap-1">
              <span>${label}</span>
              <svg class="w-4 h-4 ${isActive ? 'text-blue-600' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${isActive && isAsc ? html`
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                ` : html`
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                `}
              </svg>
            </div>
          </th>
        `;
      };

      return html`
        <div class="bg-white">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="sticky z-10 shadow-sm" style="top: 210px;">
              <tr>
                <${SortableHeader} column="created_at" label="Timestamp" />
                <${SortableHeader} column="event" label="Event" />
                <${SortableHeader} column="actor" label="Actor" />
                <${SortableHeader} column="ip_address" label="IP Address" />
                <${SortableHeader} column="platform" label="Platform" />
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${filteredLogs.value.length === 0 ? html`
                <tr>
                  <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                    ${searchQuery.value || filterEvent.value !== 'all'
                      ? 'No matching records found'
                      : 'No data available'}
                  </td>
                </tr>
              ` : filteredLogs.value.map(log => html`
                <${GridRow}
                  key=${log.id}
                  log=${log}
                  isSelected=${selectedLog.value?.id === log.id}
                />
              `)}
            </tbody>
          </table>
        </div>
      `;
    }

    // Main app component
    function App() {
      if (logs.value.length === 0) {
        return html`<${FileUpload} />`;
      }

      return html`
        <div class="min-h-screen bg-gray-50">
          <${Toolbar} />
          <${Statistics} />
          <div class="flex">
            <div class="flex-1">
              <${Grid} />
            </div>
            ${selectedLog.value && html`
              <div class="w-96 border-l border-gray-200 bg-white sticky top-0 h-screen overflow-y-auto">
                <div class="p-6">
                  <${DetailCard} log=${selectedLog.value} />
                </div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>
</html>
