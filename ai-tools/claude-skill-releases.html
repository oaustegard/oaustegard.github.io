<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Skills - Releases</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

  <!-- Import Map Configuration -->
  <script type="importmap">
    {
      "imports": {
        "preact": "https://esm.sh/*preact@10.23.1",
        "preact/": "https://esm.sh/*preact@10.23.1/",
        "@preact/signals": "https://esm.sh/*@preact/signals@1.3.0",
        "@preact/signals-core": "https://esm.sh/*@preact/signals-core@1.8.0",
        "htm": "https://esm.sh/*htm@3.1.1",
        "htm/preact": "https://esm.sh/*htm@3.1.1/preact"
      }
    }
  </script>

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
    }

    /* Prose styles for markdown content */
    .prose h1 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
    .prose h2 { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
    .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
    .prose a { color: #3b82f6; text-decoration: underline; }
    .prose a:hover { color: #2563eb; }
    .prose strong { font-weight: 600; }
    .prose ul { list-style: disc; margin-left: 1.5rem; margin-bottom: 0.75rem; }
    .prose li { margin-bottom: 0.25rem; }

    /* Table of Contents styles */
    .toc-container {
      position: fixed;
      top: 2rem;
      left: 2rem;
      width: 240px;
      max-height: calc(100vh - 4rem);
      overflow-y: auto;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      padding: 1.5rem;
    }

    .toc-link {
      display: block;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.25rem;
      color: #4b5563;
      text-decoration: none;
      border-radius: 0.375rem;
      transition: all 0.15s;
      font-size: 0.875rem;
    }

    .toc-link:hover {
      background-color: #f3f4f6;
      color: #1f2937;
    }

    .toc-link.active {
      background-color: #dbeafe;
      color: #1e40af;
      font-weight: 500;
    }

    /* Main content margin to account for ToC */
    .content-with-toc {
      margin-left: 280px;
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Responsive - hide ToC on smaller screens */
    @media (max-width: 1024px) {
      .toc-container {
        display: none;
      }
      .content-with-toc {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { render } from 'preact';
    import { useSignal, useComputed } from '@preact/signals';
    import { useEffect } from 'preact/hooks';
    import { html } from 'htm/preact';

    function App() {
      const releases = useSignal([]);
      const loading = useSignal(true);
      const error = useSignal(null);
      const activeSection = useSignal('');

      // Initialize sort mode from URL query parameter
      const urlParams = new URLSearchParams(window.location.search);
      const initialSort = urlParams.get('sort') === 'latest' ? 'latest' : 'alphabetical';
      const sortMode = useSignal(initialSort);

      // Update URL when sort mode changes
      useEffect(() => {
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('sort', sortMode.value);
        window.history.pushState({}, '', newUrl);
      }, [sortMode.value]);

      // Handle browser back/forward navigation
      useEffect(() => {
        const handlePopState = () => {
          const urlParams = new URLSearchParams(window.location.search);
          const sort = urlParams.get('sort') === 'latest' ? 'latest' : 'alphabetical';
          sortMode.value = sort;
        };

        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
      }, []);

      // Fetch releases from GitHub API
      useEffect(() => {
        async function fetchReleases() {
          try {
            const response = await fetch('https://api.github.com/repos/oaustegard/claude-skills/releases');

            if (!response.ok) {
              throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            releases.value = data;
            loading.value = false;
          } catch (err) {
            error.value = err.message;
            loading.value = false;
          }
        }

        fetchReleases();
      }, []);

      // Track active section on scroll
      useEffect(() => {
        if (loading.value || releases.value.length === 0) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                activeSection.value = entry.target.id;
              }
            });
          },
          { rootMargin: '-20% 0px -70% 0px' }
        );

        // Observe all release sections
        const sections = document.querySelectorAll('[data-release-section]');
        sections.forEach((section) => observer.observe(section));

        return () => observer.disconnect();
      }, [loading.value, releases.value.length]);

      // Sort releases based on current sort mode
      const sortedReleases = useComputed(() => {
        return [...releases.value].sort((a, b) => {
          if (sortMode.value === 'latest') {
            // Sort by published date (most recent first)
            const dateA = new Date(a.published_at);
            const dateB = new Date(b.published_at);
            return dateB - dateA;
          } else {
            // Sort alphabetically by tag name
            const nameA = (a.tag_name || a.name || '').toLowerCase();
            const nameB = (b.tag_name || b.name || '').toLowerCase();
            return nameA.localeCompare(nameB);
          }
        });
      });

      // Loading state
      if (loading.value) {
        return html`
          <div class="min-h-screen bg-gray-100 flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-lg">
              <div class="text-center">
                <div class="animate-spin inline-block w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
                <p class="text-gray-600">Loading releases...</p>
              </div>
            </div>
          </div>
        `;
      }

      // Error state
      if (error.value) {
        return html`
          <div class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-lg shadow-lg max-w-md">
              <div class="text-center">
                <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Error Loading Releases</h2>
                <p class="text-gray-600">${error.value}</p>
              </div>
            </div>
          </div>
        `;
      }

      return html`
        <div>
          <!-- Table of Contents -->
          ${sortedReleases.value.length > 0 && html`
            <${TableOfContents}
              releases=${sortedReleases.value}
              activeSection=${activeSection.value}
            />
          `}

          <!-- Main Content -->
          <div class="min-h-screen bg-gray-100 py-8 px-4 ${sortedReleases.value.length > 0 ? 'content-with-toc' : ''}">
            <div class="max-w-4xl mx-auto">
              <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <!-- Back Link -->
                <div class="mb-4">
                  <a href="/ai-tools" class="inline-flex items-center text-blue-500 hover:text-blue-600 transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Back to AI Tools
                  </a>
                </div>

                <div class="flex items-start justify-between mb-2">
                  <h1 class="text-3xl font-bold text-gray-800">Claude Skills - Releases</h1>

                  <!-- Sort Toggle -->
                  <div class="flex gap-2 bg-gray-100 rounded-lg p-1">
                    <button
                      onClick=${() => sortMode.value = 'alphabetical'}
                      class="px-3 py-1.5 rounded text-sm font-medium transition-colors ${sortMode.value === 'alphabetical' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:text-gray-900'}"
                    >
                      A-Z
                    </button>
                    <button
                      onClick=${() => sortMode.value = 'latest'}
                      class="px-3 py-1.5 rounded text-sm font-medium transition-colors ${sortMode.value === 'latest' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:text-gray-900'}"
                    >
                      Latest
                    </button>
                  </div>
                </div>

                <p class="text-gray-600">
                  ${sortMode.value === 'alphabetical' ? 'Alphabetical' : 'Latest'} listing of all releases from ${' '}
                  <a href="https://github.com/oaustegard/claude-skills"
                     class="text-blue-500 hover:underline"
                     target="_blank"
                     rel="noopener noreferrer">
                    oaustegard/claude-skills
                  </a>
                </p>
                <p class="text-sm text-gray-500 mt-2">
                  Total releases: ${sortedReleases.value.length}
                </p>
              </div>

              <div class="space-y-4">
                ${sortedReleases.value.map(release => {
                  // Find .zip assets
                  const zipAssets = (release.assets || []).filter(asset =>
                    asset.name.toLowerCase().endsWith('.zip')
                  );

                  // Create a slug for the ID
                  const id = `release-${release.tag_name}`;

                  return html`
                    <${ReleaseCard}
                      key=${release.id}
                      id=${id}
                      name=${release.name || release.tag_name}
                      publishedAt=${release.published_at}
                      description=${release.body}
                      zipAssets=${zipAssets}
                    />
                  `;
                })}
              </div>

              ${sortedReleases.value.length === 0 && html`
                <div class="bg-white rounded-lg shadow-lg p-8 text-center">
                  <p class="text-gray-600">No releases found.</p>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function TableOfContents({ releases, activeSection }) {
      return html`
        <div class="toc-container">
          <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wide">Table of Contents</h3>
          <nav>
            ${releases.map(release => {
              const id = `release-${release.tag_name}`;
              const name = release.name || release.tag_name;
              const isActive = activeSection === id;

              return html`
                <a
                  key=${release.id}
                  href="#${id}"
                  class="toc-link ${isActive ? 'active' : ''}"
                >
                  ${name}
                </a>
              `;
            })}
          </nav>
        </div>
      `;
    }

    function ReleaseCard({ id, name, publishedAt, description, zipAssets }) {
      // Truncate description at first horizontal rule (---)
      const truncatedDesc = description ? description.split(/\n---+\n/)[0].trim() : '';

      // Remove the first markdown heading (# skill-name) if present
      const descWithoutHeader = truncatedDesc.replace(/^#\s+[^\n]+\n*/, '');

      // Parse markdown to HTML
      const descriptionHtml = descWithoutHeader ? marked.parse(descWithoutHeader) : '';

      // Format the published date in local time
      const publishedDate = publishedAt ? new Date(publishedAt).toLocaleString() : '';

      return html`
        <div
          id=${id}
          data-release-section
          class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow p-6"
        >
          <div class="flex items-start justify-between mb-3">
            <div>
              <h2 class="text-xl font-bold text-gray-800">${name}</h2>
              ${publishedDate && html`
                <p class="text-sm text-gray-500">${publishedDate}</p>
              `}
            </div>
          </div>

          ${descriptionHtml && html`
            <div
              class="prose prose-sm max-w-none mb-4 text-gray-700"
              dangerouslySetInnerHTML=${{ __html: descriptionHtml }}
            />
          `}

          ${zipAssets.length > 0 && html`
            <div class="border-t pt-4">
              <p class="text-sm font-semibold text-gray-700 mb-2">Downloads:</p>
              <div class="flex flex-wrap gap-2">
                ${zipAssets.map(asset => html`
                  <a
                    key=${asset.id}
                    href=${asset.browser_download_url}
                    class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm font-medium"
                    download
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    ${asset.name}
                  </a>
                `)}
              </div>
            </div>
          `}

          ${zipAssets.length === 0 && html`
            <p class="text-sm text-gray-500 italic border-t pt-4">No .zip files available for this release</p>
          `}
        </div>
      `;
    }

    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>
</html>
