<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneNote Protocol Forwarder</title>
    <style>
      body {font-family: Arial, Helvetica, sans-serif; margin-left: 50px}
    </style>
</head>
<body>
    <p><a href="javascript:history.back()">Back...</a></p>
    <h1>OneNote Forwarder</h1>
    <h2>What does this do?</h2>
    <p>When provided a suitable query string, this page will use JavaScript to redirect to a OneNote page or section</p>

    <h2>Why is this needed?</h2>
    <p>OneNote urls use the <code>onenote:</code> protocol which is not allowed in many applications. Using this page as an intermediary 
        allows you to effectively link to a OneNote page or section using 
        a <code>http</code> or <code>https</code> protocol</p>
    
    <h2>How do I use it?</h2>
    <p>OneNote links can be obtained by right-clicking on a page or section in OneNote and selecting "Copy Link to Page" or "Copy Link to Section"</p>
    <p>The format of a OneNote link will look like this: 
        <pre>onenote:https://example.com/public/SitePages/HelloWorld/New%20World.one#Hello%20World&section-id={407570BB-A4B0-42C5-B78A-CC4A40BF3F29}&page-id={84699AA3-6F05-456C-B953-5DFBEBEDD322}&end</pre></p>
        <p><b>To use this page as a OneNote forwarder</b>, call this page with the OneNote link as a query string parameter like this:<br/>
        <pre>onenote.html?https://example.com/public/SitePages/HelloWorld/New%20World.one#Hello%20World&section-id={407570BB-A4B0-42C5-B78A-CC4A40BF3F29}&page-id={84699AA3-6F05-456C-B953-5DFBEBEDD322}&end</pre></p>
    <p>Note: The first time you use this, you'll likely need to allow this site to open the OneNote application.</p>

    <h2>Paste Your OneNote URL</h2>
    Rather than manipulating the query string you can also simply paste your OneNote URL here and click the button to generate a forwarder link.
    <form id="oneNoteForm" onsubmit="return handleFormSubmit(event)">
        <input type="text" id="oneNoteUrl" name="oneNoteUrl" placeholder="Paste your OneNote URL here" style="width: 80%;">
        <input type="submit" value="Generate Forwarder Link">
    </form>

    <script>

function handleFormSubmit(event) {
    event.preventDefault();
    let input = document.getElementById('oneNoteUrl').value.trim();
    if (input) {
        let oneNoteUrl = input.startsWith('onenote:') ? input : 'onenote:' + input;
        let encodedUrl = encodeURIComponent(oneNoteUrl.replace('onenote:', ''));
        window.location.href = `${thisUrl}?${encodedUrl}`;
    }
    return false;
}

var getFullQueryString = function() {
    // Get everything after the '?' including any '#' parts
    let fullQuery = window.location.href.split('?')[1];
    return fullQuery ? decodeURIComponent(fullQuery) : '';
}

var getOneNoteLink = function(fullQuery) {
    let oneNoteUrl = '';
    if (fullQuery) {
        // Check if 'onenote:' is in the query string
        let oneNoteIndex = fullQuery.indexOf('onenote:');
        if (oneNoteIndex !== -1) {
            oneNoteUrl = fullQuery.substring(oneNoteIndex);
        } else {
            oneNoteUrl = 'onenote:' + fullQuery;
        }
    }
    return oneNoteUrl;
}

var updateLinks = function(oneNoteUrl) {
    let on = document.getElementById('on');
    on.innerText = on.href = oneNoteUrl || on.href;
    
    let lnk = document.getElementById('lnk');
    if (oneNoteUrl) {
        // Encode the entire OneNote URL for use in query string
        let encodedUrl = encodeURIComponent(oneNoteUrl.replace('onenote:', ''));
        lnk.innerText = lnk.href = `${thisUrl}?${encodedUrl}`;
    }
}

let thisUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}`;
let fullQuery = getFullQueryString();
let oneNoteUrl = getOneNoteLink(fullQuery);

// Update links only if a URL is provided
if (oneNoteUrl) {
    updateLinks(oneNoteUrl);
    // Redirect to OneNote
    window.location.href = oneNoteUrl;
}
    </script>
</body>
</html>
