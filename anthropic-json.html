<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude API Response Viewer</title>
    <script type="importmap">
        {
            "imports": {
                "preact": "https://esm.sh/preact@10.23.1",
                "preact/": "https://esm.sh/preact@10.23.1/",
                "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
            }
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: #fafafa;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .input-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .input-section h2 {
            margin: 0 0 15px 0;
            color: #555;
            font-size: 1.1em;
        }
        
        .gist-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .load-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .load-btn:hover {
            background: #0056b3;
        }
        
        .error {
            color: #d73027;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .collapsible {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .collapsible-header {
            background: #f5f5f5;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            font-weight: 500;
            user-select: none;
        }
        
        .collapsible-header:hover {
            background: #ebebeb;
        }
        
        .collapsible-content {
            padding: 15px;
            display: none;
            background: #fafafa;
        }
        
        .collapsible.expanded .collapsible-content {
            display: block;
        }
        
        .thinking-content {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        
        .content-section {
            margin-top: 20px;
        }
        
        .content-text {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 16px;
        }
        
        .content-text h1, .content-text h2, .content-text h3 {
            margin: 24px 0 12px 0;
            font-weight: 600;
        }
        
        .content-text h1 { font-size: 1.5em; }
        .content-text h2 { font-size: 1.3em; }
        .content-text h3 { font-size: 1.1em; }
        
        .content-text strong, .content-text b {
            font-weight: 600;
        }
        
        .content-text ul, .content-text ol {
            padding-left: 20px;
            margin: 12px 0;
        }
        
        .content-text li {
            margin: 4px 0;
        }
        
        .content-text p {
            margin: 12px 0;
        }
        
        .citation {
            font-size: 0.8em;
            vertical-align: super;
            color: #007bff;
            text-decoration: none;
            margin: 0 1px;
        }
        
        .citation:hover {
            text-decoration: underline;
        }
        
        .search-section {
            margin-bottom: 20px;
        }
        
        .search-query {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
        }
        
        .search-result {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #f9f9f9;
        }
        
        .search-result h4 {
            margin: 0 0 8px 0;
            color: #1a0dab;
            font-size: 14px;
        }
        
        .search-result a {
            color: #1a0dab;
            text-decoration: none;
        }
        
        .search-result a:hover {
            text-decoration: underline;
        }
        
        .search-url {
            color: #006621;
            font-size: 12px;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .instructions {
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        import { render } from 'preact';
        import { html } from 'htm/preact';
        import { useState, useEffect } from 'preact/hooks';

        // Simple markdown to HTML converter
        function markdownToHtml(text) {
            if (!text) return '';
            
            return text
                // Headers
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Lists (simple implementation)
                .replace(/^\- (.*$)/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.*$)/gm, '<li>$1. $2</li>')
                // Wrap consecutive <li> items in <ul>
                .replace(/(<li>.*<\/li>(\n<li>.*<\/li>)*)/gs, (match) => {
                    return '<ul>' + match + '</ul>';
                })
                // Paragraphs (double newlines)
                .replace(/\n\n/g, '</p><p>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>')
                // Clean up empty paragraphs
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<h[1-6]>)/g, '$1')
                .replace(/(<\/h[1-6]>)<\/p>/g, '$1')
                .replace(/<p>(<ul>)/g, '$1')
                .replace(/(<\/ul>)<\/p>/g, '$1');
        }

        function App() {
            const [data, setData] = useState(null);
            const [error, setError] = useState(null);
            const [gistUrl, setGistUrl] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const gist = params.get('gist');
                if (gist) {
                    setGistUrl(gist);
                    loadFromGist(gist);
                }
            }, []);

            const loadFromGist = async (url) => {
                setLoading(true);
                setError(null);
                
                try {
                    let fetchUrl = url;
                    
                    // Convert GitHub gist URL to raw URL if needed
                    if (url.includes('github.com') && url.includes('/gist/')) {
                        const gistId = url.split('/').pop().split('#')[0];
                        fetchUrl = `https://gist.githubusercontent.com/oaustegard/${gistId}/raw`;
                    }
                    
                    const response = await fetch(fetchUrl);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch: ${response.status}`);
                    }
                    
                    const text = await response.text();
                    const parsed = JSON.parse(text);
                    setData(parsed);
                } catch (err) {
                    setError(`Error loading gist: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const handleLoad = () => {
                if (gistUrl.trim()) {
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('gist', gistUrl.trim());
                    window.history.pushState({}, '', newUrl);
                    loadFromGist(gistUrl.trim());
                }
            };

            const toggleCollapsible = (e) => {
                const header = e.currentTarget;
                const collapsible = header.parentElement;
                collapsible.classList.toggle('expanded');
            };

            const renderContent = (content) => {
                if (!content || !Array.isArray(content)) return null;

                // Group searches and results together
                const processedContent = [];
                const searchGroups = [];
                let currentSearchGroup = null;

                // First pass: group search-related items
                content.forEach((item, index) => {
                    if (item.type === 'thinking') {
                        processedContent.push(item);
                    } else if (item.type === 'server_tool_use' && item.name === 'web_search') {
                        currentSearchGroup = { searches: [item], results: [] };
                        searchGroups.push(currentSearchGroup);
                    } else if (item.type === 'web_search_tool_result' && currentSearchGroup) {
                        currentSearchGroup.results.push(item);
                    } else {
                        if (currentSearchGroup) {
                            processedContent.push({ type: 'search_group', groups: [...searchGroups] });
                            searchGroups.length = 0;
                            currentSearchGroup = null;
                        }
                        processedContent.push(item);
                    }
                });

                // Don't forget remaining search groups
                if (searchGroups.length > 0) {
                    processedContent.push({ type: 'search_group', groups: [...searchGroups] });
                }

                let citationCounter = 1;

                return processedContent.map((item, index) => {
                    if (item.type === 'thinking') {
                        return html`
                            <div key=${index} class="collapsible">
                                <div class="collapsible-header" onClick=${toggleCollapsible}>
                                    🤔 Thinking Process
                                </div>
                                <div class="collapsible-content">
                                    <div class="thinking-content">${item.thinking}</div>
                                </div>
                            </div>
                        `;
                    }

                    if (item.type === 'search_group') {
                        const totalSearches = item.groups.reduce((acc, group) => acc + group.searches.length, 0);
                        return html`
                            <div key=${index} class="collapsible">
                                <div class="collapsible-header" onClick=${toggleCollapsible}>
                                    🔍 Web Research (${totalSearches} searches)
                                </div>
                                <div class="collapsible-content">
                                    ${item.groups.map((group, groupIdx) => html`
                                        <div key=${groupIdx} class="search-section">
                                            ${group.searches.map((search, searchIdx) => html`
                                                <div key=${searchIdx} class="search-query">
                                                    🔍 Query: "${search.input.query}"
                                                </div>
                                            `)}
                                            ${group.results.map((result, resultIdx) => {
                                                const results = result.content?.filter(c => c.type === 'web_search_result') || [];
                                                return html`
                                                    <div key=${resultIdx}>
                                                        <div style="margin: 10px 0; font-weight: 500;">📋 Results (${results.length}):</div>
                                                        ${results.map((res, resIdx) => html`
                                                            <div key=${resIdx} class="search-result">
                                                                <h4><a href=${res.url} target="_blank">${res.title}</a></h4>
                                                                <div class="search-url">${res.url}</div>
                                                                ${res.page_age && html`<div style="font-size: 12px; color: #666;">Page age: ${res.page_age}</div>`}
                                                            </div>
                                                        `)}
                                                    </div>
                                                `;
                                            })}
                                        </div>
                                    `)}
                                </div>
                            </div>
                        `;
                    }

                    if (item.type === 'text') {
                        const htmlContent = markdownToHtml(item.text);
                        return html`
                            <div key=${index} class="content-text" dangerouslySetInnerHTML=${{ __html: htmlContent }}></div>
                        `;
                    }

                    if (item.type === 'citations') {
                        const citationLinks = item.citations?.map(citation => {
                            const citationNum = citationCounter++;
                            return html`<a 
                                key=${citationNum}
                                href=${citation.url} 
                                class="citation" 
                                target="_blank"
                                title="${citation.title}: ${citation.cited_text}"
                            >${citationNum}</a>`;
                        }) || [];

                        const htmlContent = markdownToHtml(item.text);
                        
                        return html`
                            <div key=${index} class="content-text">
                                <span dangerouslySetInnerHTML=${{ __html: htmlContent }}></span>${citationLinks}
                            </div>
                        `;
                    }

                    return null;
                }).filter(Boolean);
            };

            return html`
                <div class="container">
                    <h1>Claude API Response Viewer</h1>
                    
                    <div class="input-section">
                        <h2>Load from GitHub Gist</h2>
                        <input 
                            type="text" 
                            class="gist-input"
                            placeholder="Paste GitHub Gist URL containing Claude API JSON response"
                            value=${gistUrl}
                            onInput=${(e) => setGistUrl(e.target.value)}
                        />
                        <button class="load-btn" onClick=${handleLoad} disabled=${loading}>
                            ${loading ? 'Loading...' : 'Load Response'}
                        </button>
                        
                        ${!data && !error && html`
                            <div class="instructions">
                                <strong>Instructions:</strong> Create a GitHub Gist containing only the JSON output 
                                from an Anthropic API response, then paste the gist URL above and click "Load Response".
                            </div>
                        `}
                    </div>

                    ${error && html`<div class="error">${error}</div>`}
                    
                    ${data && html`
                        <div class="content-section">
                            ${renderContent(data.content)}
                        </div>
                    `}
                </div>
            `;
        }

        render(html`<${App} />`, document.getElementById('app'));
    </script>
</body>
</html>
