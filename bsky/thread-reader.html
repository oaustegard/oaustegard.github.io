<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bluesky Thread Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
    {
      "imports": {
        "preact": "https://esm.sh/*preact@10.23.1",
        "preact/": "https://esm.sh/*preact@10.23.1/",
        "htm": "https://esm.sh/*htm@3.1.1",
        "htm/preact": "https://esm.sh/*htm@3.1.1/preact"
      }
    }
  </script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .post-text { overflow-wrap: anywhere; word-break: break-word; }

    /* Avatar: always show colored letter; img overlays it when loaded */
    .avatar-wrap {
      position: relative;
      width: 36px; height: 36px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 0.875rem; color: white;
    }
    .avatar-wrap img {
      position: absolute; inset: 0;
      width: 100%; height: 100%; object-fit: cover;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .avatar-wrap img.loaded { opacity: 1; }

    .avatar-sm {
      width: 20px; height: 20px;
      font-size: 0.65rem;
    }

    /* User search highlight */
    .post-highlighted {
      border-color: #f59e0b !important;
      background-color: #fffbeb !important;
      box-shadow: 0 0 0 2px #fcd34d44;
    }

    /* Longest branch indicator */
    .longest-branch-card {
      border-color: #818cf8 !important;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app"><div style="padding:2rem;color:#888">Loadingâ€¦</div></div>
  <div id="err" style="display:none;padding:1rem;background:#fee;color:#900;font-family:monospace;white-space:pre-wrap;position:fixed;bottom:0;left:0;right:0;max-height:40vh;overflow:auto;z-index:9999"></div>
  <script>
    window.onerror = (msg,s,l,c,e) => {
      document.getElementById('err').style.display='block';
      document.getElementById('err').textContent='Error: '+msg+'\n'+(e&&e.stack||'');
    };
    window.addEventListener('unhandledrejection',e=>{
      document.getElementById('err').style.display='block';
      document.getElementById('err').textContent+='Rejection: '+(e.reason&&e.reason.stack||e.reason)+'\n';
    });

    // Deterministic hue from a DID string â€” inline so usable from CSS via inline style
    function avatarHue(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
      return Math.abs(hash) % 360;
    }
    window.avatarHue = avatarHue;
  </script>

  <script type="module">
    import { render } from 'preact';
    import { useState, useEffect, useRef, useMemo } from 'preact/hooks';
    import { html } from 'htm/preact';

    // â”€â”€ URL / API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function parseBskyUrl(url) {
      const m = url.match(/bsky\.app\/profile\/([^/?# \t]+)\/post\/([^/?# \t]+)/);
      return m ? { actor: m[1], rkey: m[2] } : null;
    }

    async function resolveToAtUri(input) {
      input = input.trim();
      if (input.startsWith('at://')) return input;
      const parsed = parseBskyUrl(input);
      if (!parsed) throw new Error('Paste a bsky.app post URL or an at:// URI');
      let did = parsed.actor;
      if (!did.startsWith('did:')) {
        const r = await fetch('https://public.api.bsky.app/xrpc/com.atproto.identity.resolveHandle?handle='+encodeURIComponent(did));
        if (!r.ok) throw new Error('Could not resolve handle: '+did);
        did = (await r.json()).did;
      }
      return 'at://'+did+'/app.bsky.feed.post/'+parsed.rkey;
    }

    async function fetchThread(atUri) {
      const r = await fetch('https://public.api.bsky.app/xrpc/app.bsky.feed.getPostThread?uri='+encodeURIComponent(atUri)+'&depth=1000&parentHeight=0');
      if (!r.ok) {
        const b = await r.json().catch(()=>({}));
        throw new Error(b.message || 'API error '+r.status);
      }
      return (await r.json()).thread;
    }

    // â”€â”€ Display helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function timeAgo(iso) {
      const diff = Date.now() - new Date(iso).getTime();
      const m=Math.floor(diff/60000), h=Math.floor(diff/3600000), d=Math.floor(diff/86400000);
      if (m<1) return 'now';
      if (h<1) return m+'m';
      if (d<1) return h+'h';
      if (d<30) return d+'d';
      return new Date(iso).toLocaleDateString();
    }

    function postUrl(p) {
      return 'https://bsky.app/profile/'+p.author.did+'/post/'+p.uri.split('/').pop();
    }

    // â”€â”€ Tree helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function validReplies(node) {
      return (node.replies||[]).filter(r=>r.$type==='app.bsky.feed.defs#threadViewPost');
    }

    function countAll(node) {
      const v = validReplies(node);
      return v.reduce((n,r)=>n+1+countAll(r), 0);
    }

    function branchPostCount(node) {
      return 1 + validReplies(node).reduce((n,r) => n + branchPostCount(r), 0);
    }

    function findLongestBranch(thread) {
      const replies = validReplies(thread);
      if (!replies.length) return null;
      let best = null, bestCount = 0;
      for (const r of replies) {
        const count = branchPostCount(r);
        if (count > bestCount) { bestCount = count; best = r; }
      }
      return best ? { node: best, postCount: bestCount } : null;
    }

    // â”€â”€ Pre-computation helpers (O(n) single traversals) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // Returns a Set of URIs where the OP (opDid) is present anywhere in the subtree
    function computeOpSubtreeSet(node, opDid, set) {
      const replies = validReplies(node);
      let hasOp = node.post?.author?.did === opDid;
      for (const r of replies) {
        if (computeOpSubtreeSet(r, opDid, set)) hasOp = true;
      }
      if (hasOp) set.add(node.post.uri);
      return hasOp;
    }

    // Returns a Set of URIs where the search query matches anywhere in the subtree
    function computeSearchSubtreeSet(node, query, set) {
      const replies = validReplies(node);
      let hasMatch = matchesSearch(node.post, query);
      for (const r of replies) {
        if (computeSearchSubtreeSet(r, query, set)) hasMatch = true;
      }
      if (hasMatch) set.add(node.post.uri);
      return hasMatch;
    }

    // â”€â”€ Search matching (author handle/name and post text) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function matchesSearch(post, query) {
      if (!query) return false;
      const q = query.toLowerCase().replace(/^@/, '');
      return (post.author.handle||'').toLowerCase().includes(q) ||
             (post.author.displayName||'').toLowerCase().includes(q) ||
             (post.record?.text||'').toLowerCase().includes(q);
    }

    // â”€â”€ DynImg â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function DynImg({ url, alt, styleObj, cls }) {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current && url) ref.current.setAttribute('src', url);
      }, [url]);
      return html`<img ref=${ref} alt=${alt||''} class=${cls||''}
        style=${styleObj||{}} onError=${e=>e.target.style.display='none'} />`;
    }

    // â”€â”€ Avatar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function Avatar({ author, small }) {
      const hue = window.avatarHue(author.did || author.handle || '');
      const bg = `hsl(${hue},60%,45%)`;
      const letter = (author.displayName || author.handle || '?')[0].toUpperCase();
      const coverStyle = { position:'absolute', inset:0, width:'100%', height:'100%', objectFit:'cover' };
      return html`
        <div class=${'avatar-wrap'+(small?' avatar-sm':'')} style=${'background:'+bg}>
          <span>${letter}</span>
          ${author.avatar && html`<${DynImg} url=${author.avatar} cls="loaded" styleObj=${coverStyle} />`}
        </div>
      `;
    }

    // â”€â”€ Embed components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function ImageGrid({ images }) {
      if (!images?.length) return null;
      return html`
        <div class=${`mt-2 grid gap-1 rounded-lg overflow-hidden ${images.length > 1 ? 'grid-cols-2' : 'grid-cols-1'}`}>
          ${images.map((img, i) => {
            const ar = img.aspectRatio ? img.aspectRatio.width+'/'+img.aspectRatio.height : '16/9';
            return html`
              <a key=${i} href="${img.fullsize}" target="_blank" rel="noopener" class="block">
                <${DynImg} url=${img.thumb} alt=${img.alt||''} cls="w-full object-cover max-h-48"
                  styleObj=${{aspectRatio:ar, objectFit:'cover', width:'100%'}} />
              </a>`;
          })}
        </div>
      `;
    }

    function VideoThumb({ embed }) {
      return html`
        <div class="mt-2 relative rounded-lg overflow-hidden bg-black cursor-pointer"
          style="aspect-ratio: ${embed.aspectRatio ? embed.aspectRatio.width+'/'+embed.aspectRatio.height : '16/9'}; max-height: 300px">
          <${DynImg} url=${embed.thumbnail} alt="Video" cls="w-full h-full"
            styleObj=${{width:'100%', height:'100%', objectFit:'cover', opacity:0.8}} />
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="bg-black bg-opacity-60 rounded-full w-12 h-12 flex items-center justify-center">
              <span style="font-size:1.5rem">â–¶</span>
            </div>
          </div>
        </div>
      `;
    }

    function ExternalCard({ external }) {
      return html`
        <a href="${external.uri}" target="_blank" rel="noopener"
          class="block mt-2 rounded-lg border border-gray-200 bg-gray-50 hover:bg-gray-100 transition-colors overflow-hidden no-underline">
          ${external.thumb && html`<${DynImg} url=${external.thumb} cls="w-full object-cover max-h-32"
            styleObj=${{width:'100%', objectFit:'cover', maxHeight:'8rem'}} />`}
          <div class="p-2">
            <div class="text-xs font-semibold text-gray-800 post-text">${external.title}</div>
            ${external.description && html`<div class="text-xs text-gray-500 post-text mt-0.5 line-clamp-2">${external.description}</div>`}
            <div class="text-xs text-gray-400 mt-1 truncate">${external.uri}</div>
          </div>
        </a>
      `;
    }

    function QuotedPost({ record }) {
      if (!record || record.$type !== 'app.bsky.embed.record#viewRecord') return null;
      const qUrl = 'https://bsky.app/profile/'+record.author.did+'/post/'+record.uri.split('/').pop();
      return html`
        <a href="${qUrl}" target="_blank" rel="noopener"
          class="block mt-2 rounded-lg border border-gray-200 bg-gray-50 hover:bg-gray-100 p-3 no-underline transition-colors">
          <div class="flex items-center gap-2 mb-1">
            <${Avatar} author=${record.author} small=${true} />
            <span class="text-xs font-semibold text-gray-700 truncate">${record.author.displayName||record.author.handle}</span>
            <span class="text-xs text-gray-400 truncate">@${record.author.handle}</span>
            <span class="text-xs text-gray-400 ml-auto flex-shrink-0">${timeAgo(record.indexedAt||record.value?.createdAt||'')}</span>
          </div>
          <p class="text-xs text-gray-700 post-text leading-relaxed">${record.value?.text||''}</p>
        </a>
      `;
    }

    function PostEmbed({ embed }) {
      if (!embed) return null;
      const t = embed.$type;

      if (t === 'app.bsky.embed.images#view')
        return html`<${ImageGrid} images=${embed.images} />`;

      if (t === 'app.bsky.embed.video#view')
        return html`<${VideoThumb} embed=${embed} />`;

      if (t === 'app.bsky.embed.external#view')
        return html`<${ExternalCard} external=${embed.external} />`;

      if (t === 'app.bsky.embed.record#view')
        return html`<${QuotedPost} record=${embed.record} />`;

      if (t === 'app.bsky.embed.recordWithMedia#view') {
        const media = embed.media;
        const record = embed.record?.record;
        return html`
          <div>
            <${PostEmbed} embed=${media} />
            <${QuotedPost} record=${record} />
          </div>
        `;
      }

      return null;
    }

    // â”€â”€ Post card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const MAX_INDENT = 4;

    function PostCard({ node, isRoot, depth, rootAuthorDid, filters, collapseKey, expandKey, longestBranchUri }) {
      const p = node.post;
      const rkey = p.uri.split('/').pop();

      // Determine if this node is a non-OP branch (no OP anywhere in its subtree)
      const nonOpBranch = !isRoot && filters.collapseNonOP &&
        !!filters.opSubtreeSet && !filters.opSubtreeSet.has(p.uri);

      // userCollapsed: null = use auto state, true/false = user override
      const [userCollapsed, setUserCollapsed] = useState(null);

      // Derived collapsed state: user override takes priority, fallback to nonOpBranch
      const collapsed = userCollapsed !== null ? userCollapsed : nonOpBranch;

      // Global Collapse All / Expand All signals
      useEffect(() => { if (collapseKey > 0) setUserCollapsed(true); }, [collapseKey]);
      useEffect(() => { if (expandKey > 0) setUserCollapsed(false); }, [expandKey]);

      // Reset user override when collapseNonOP filter changes so auto-state takes effect
      useEffect(() => { setUserCollapsed(null); }, [filters.collapseNonOP]);

      function toggle() { setUserCollapsed(!collapsed); }

      // â”€â”€ Apply filters to replies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const allReplies = validReplies(node);
      let visibleReplies = allReplies;

      // Search filter: only show branches containing the search match
      if (filters.search && filters.searchSubtreeSet) {
        visibleReplies = visibleReplies.filter(r => filters.searchSubtreeSet.has(r.post.uri));
      }

      // Hide stubs: filter out leaf nodes (no visible children)
      if (filters.hideStubs) {
        visibleReplies = visibleReplies.filter(r => validReplies(r).length > 0);
      }

      // Engagement filters
      if (filters.minLikes > 0) {
        visibleReplies = visibleReplies.filter(r => (r.post?.likeCount||0) >= filters.minLikes);
      }
      if (filters.minReplies > 0) {
        visibleReplies = visibleReplies.filter(r => (r.post?.replyCount||0) >= filters.minReplies);
      }

      const sorted = [...visibleReplies].sort((a,b) => (b.post.likeCount||0) - (a.post.likeCount||0));
      const desc = countAll(node);
      const hiddenByFilters = allReplies.length - visibleReplies.length;

      const isHighlighted = !!filters.search && matchesSearch(p, filters.search);
      const isLongestBranch = !!longestBranchUri && p.uri === longestBranchUri;

      const cardClass = [
        'rounded-xl border p-3',
        isRoot ? 'bg-white border-blue-200 shadow-sm' : 'bg-white border-gray-100',
        isHighlighted ? 'post-highlighted' : '',
        isLongestBranch ? 'longest-branch-card' : '',
      ].filter(Boolean).join(' ');

      return html`
        <div id=${'post-'+rkey}>
          <div class=${cardClass}>
            <div class="flex gap-2 min-w-0">
              <${Avatar} author=${p.author} />
              <div class="flex-1 min-w-0">
                <div class="flex items-baseline gap-1 flex-wrap mb-1">
                  <span class="font-semibold text-gray-900 text-sm truncate max-w-[130px]">${p.author.displayName||p.author.handle}</span>
                  <span class="text-gray-400 text-xs truncate">@${p.author.handle}</span>
                  ${isLongestBranch && html`
                    <span class="text-xs bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded-full font-medium ml-1 whitespace-nowrap">
                      ğŸ“ˆ longest
                    </span>
                  `}
                  ${nonOpBranch && html`
                    <span class="text-xs bg-gray-100 text-gray-400 px-1.5 py-0.5 rounded-full ml-1 whitespace-nowrap">
                      no OP
                    </span>
                  `}
                  <a href="${postUrl(p)}" target="_blank" rel="noopener"
                    class="text-gray-400 text-xs hover:text-sky-500 ml-auto flex-shrink-0">
                    ${timeAgo(p.record.createdAt)}
                  </a>
                </div>
                <p class="text-gray-800 text-sm post-text leading-relaxed">${p.record.text}</p>
                ${p.embed && html`<${PostEmbed} embed=${p.embed} />`}
                <div class="flex items-center gap-3 mt-2 text-gray-400 text-xs">
                  <span>ğŸ’¬ ${p.replyCount||0}</span>
                  <span>ğŸ” ${p.repostCount||0}</span>
                  <span>â¤ï¸ ${p.likeCount||0}</span>
                  ${sorted.length > 0 && html`
                    <button class="ml-auto text-sky-500 hover:text-sky-700 font-medium"
                      onClick=${toggle}>
                      ${collapsed
                        ? `â–¶ ${desc} repl${desc===1?'y':'ies'}`
                        : `â–¼ collapse (${sorted.length})`}
                    </button>
                  `}
                  ${sorted.length === 0 && allReplies.length > 0 && html`
                    <span class="ml-auto text-gray-300 italic text-xs">${allReplies.length} filtered out</span>
                  `}
                </div>
                ${hiddenByFilters > 0 && html`
                  <p class="text-xs text-gray-400 mt-1 italic">
                    ${hiddenByFilters} ${hiddenByFilters===1?'reply':'replies'} hidden by active filters
                  </p>
                `}
              </div>
            </div>
          </div>
          ${sorted.length > 0 && !collapsed && html`
            <div class=${`mt-1 space-y-2 ${depth < MAX_INDENT ? 'ml-4 pl-3 border-l-2 border-gray-200' : 'ml-1 pl-1 border-l border-gray-100'}`}>
              ${sorted.map(r => html`<${PostCard}
                key=${r.post.uri}
                node=${r}
                isRoot=${false}
                depth=${depth+1}
                rootAuthorDid=${rootAuthorDid}
                filters=${filters}
                collapseKey=${collapseKey}
                expandKey=${expandKey}
                longestBranchUri=${longestBranchUri}
              />`)}
            </div>
          `}
        </div>
      `;
    }

    // â”€â”€ URL param helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function getParams() {
      const p = new URLSearchParams(window.location.search);
      return {
        url:            p.get('url')  || '',
        hideStubs:      p.get('hs')   === '1',
        collapseNonOP:  p.get('cnop') === '1',
        minLikes:       p.get('ml')   || '',
        minReplies:     p.get('mr')   || '',
        search:         p.get('q')    || '',
      };
    }
    function setParams(vals) {
      const p = new URLSearchParams();
      if (vals.url) p.set('url', vals.url);
      if (vals.hideStubs) p.set('hs', '1');
      if (vals.collapseNonOP) p.set('cnop', '1');
      if (vals.minLikes && parseInt(vals.minLikes) > 0) p.set('ml', String(parseInt(vals.minLikes)));
      if (vals.minReplies && parseInt(vals.minReplies) > 0) p.set('mr', String(parseInt(vals.minReplies)));
      if (vals.search && vals.search.trim()) p.set('q', vals.search.trim());
      const qs = p.toString();
      window.history.replaceState({}, '', window.location.pathname + (qs ? '?' + qs : ''));
    }

    // â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function App() {
      // Initialize all state from QSPs so filters survive page loads / are shareable
      const [input, setInput] = useState(() => getParams().url);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [thread, setThread] = useState(null);
      const [shareUrl, setShareUrl] = useState('');
      const [copied, setCopied] = useState(false);

      // Filter state â€” initialised from QSPs
      const [hideStubs, setHideStubs] = useState(() => getParams().hideStubs);
      const [collapseNonOP, setCollapseNonOP] = useState(() => getParams().collapseNonOP);
      const [minLikes, setMinLikes] = useState(() => getParams().minLikes);
      const [minReplies, setMinReplies] = useState(() => getParams().minReplies);
      const [search, setSearch] = useState(() => getParams().search);

      // Global expand/collapse signals (incrementing triggers PostCard effects)
      const [collapseKey, setCollapseKey] = useState(0);
      const [expandKey, setExpandKey] = useState(0);

      // Initial load from QSP (preserves filters already in URL)
      useEffect(() => { const v = getParams().url; if (v) doLoad(v, false); }, []);

      // Sync all filter state â†’ QSP whenever anything changes
      useEffect(() => {
        setParams({ url: input, hideStubs, collapseNonOP, minLikes, minReplies, search });
        if (thread) setShareUrl(window.location.href);
      }, [input, hideStubs, collapseNonOP, minLikes, minReplies, search, thread]);

      async function doLoad(raw, resetFilters = true) {
        raw = (raw || input).trim();
        if (!raw) return;
        setLoading(true); setError(''); setThread(null); setShareUrl('');
        if (resetFilters) {
          // Reset all filters when the user loads a brand-new thread
          setHideStubs(false); setCollapseNonOP(false);
          setMinLikes(''); setMinReplies(''); setSearch('');
          setCollapseKey(0); setExpandKey(0);
        }
        try {
          const atUri = await resolveToAtUri(raw);
          const result = await fetchThread(atUri);
          if (result.$type !== 'app.bsky.feed.defs#threadViewPost') throw new Error('Thread not found or post is private');
          setThread(result);
          // QSP + shareUrl are updated by the useEffect above when thread/state change
        } catch(e) {
          setError(e.message);
        } finally {
          setLoading(false);
        }
      }

      function copy() {
        navigator.clipboard.writeText(window.location.href).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
      }

      function collapseAll() { setCollapseKey(k => k + 1); }
      function expandAll() { setExpandKey(k => k + 1); }

      function clearFilters() {
        setHideStubs(false); setCollapseNonOP(false);
        setMinLikes(''); setMinReplies(''); setSearch('');
      }

      function jumpToLongest() {
        if (!longestBranch) return;
        const rkey = longestBranch.node.post.uri.split('/').pop();
        document.getElementById('post-'+rkey)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      const total = thread ? 1+countAll(thread) : 0;
      const rootAuthorDid = thread?.post?.author?.did || '';
      const longestBranch = useMemo(() => thread ? findLongestBranch(thread) : null, [thread]);
      const topBranchCount = thread ? validReplies(thread).length : 0;

      // Pre-compute subtree sets for O(n) filtering
      const opSubtreeSet = useMemo(() => {
        if (!thread || !collapseNonOP) return null;
        const set = new Set();
        computeOpSubtreeSet(thread, rootAuthorDid, set);
        return set;
      }, [thread, collapseNonOP, rootAuthorDid]);

      const searchSubtreeSet = useMemo(() => {
        const q = search.trim();
        if (!thread || !q) return null;
        const set = new Set();
        computeSearchSubtreeSet(thread, q, set);
        return set;
      }, [thread, search]);

      const filters = useMemo(() => ({
        hideStubs,
        collapseNonOP,
        minLikes: parseInt(minLikes) || 0,
        minReplies: parseInt(minReplies) || 0,
        search: search.trim(),
        opSubtreeSet,
        searchSubtreeSet,
      }), [hideStubs, collapseNonOP, minLikes, minReplies, search, opSubtreeSet, searchSubtreeSet]);

      const anyFilterActive = hideStubs || collapseNonOP ||
        (parseInt(minLikes) > 0) || (parseInt(minReplies) > 0) || search.trim();

      return html`
        <div class="max-w-2xl mx-auto px-4 py-8">
          <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">ğŸ¦‹ Thread Viewer</h1>
            <p class="text-gray-500 text-sm mt-1">Full branching tree of any Bluesky thread</p>
          </div>
          <div class="flex gap-2 mb-4">
            <input
              type="text"
              value=${input}
              placeholder="https://bsky.app/profile/â€¦/post/â€¦"
              onInput=${e=>setInput(e.target.value)}
              onKeyDown=${e=>e.key==='Enter'&&doLoad(input, true)}
              class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400 bg-white"
            />
            <button onClick=${()=>doLoad(input, true)} disabled=${loading}
              class="px-5 py-2 bg-sky-600 text-white rounded-lg text-sm font-medium hover:bg-sky-700 disabled:opacity-50 transition-colors">
              ${loading ? 'â€¦' : 'Load'}
            </button>
          </div>
          ${error && html`<div class="mb-4 px-4 py-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">${error}</div>`}
          ${shareUrl && thread && html`
            <div class="mb-5 flex items-center gap-2 px-3 py-2 bg-sky-50 border border-sky-200 rounded-lg text-xs">
              <span class="text-sky-700 flex-1 truncate">${shareUrl}</span>
              <button onClick=${copy} class="text-sky-600 hover:text-sky-800 font-medium flex-shrink-0">
                ${copied ? 'âœ“ Copied' : 'Copy link'}
              </button>
            </div>
          `}
          ${thread && html`
            <!-- Stats + controls row -->
            <div class="mb-3 flex flex-wrap items-center gap-2 text-xs">
              <span class="text-gray-400">
                ${total} post${total!==1?'s':''} in thread
                ${topBranchCount > 0 ? ` Â· ${topBranchCount} top-level branch${topBranchCount!==1?'es':''}` : ''}
              </span>
              <div class="flex gap-1.5 ml-auto flex-wrap">
                <button onClick=${expandAll}
                  class="px-2.5 py-1 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-gray-600 font-medium transition-colors">
                  â–¼ Expand All
                </button>
                <button onClick=${collapseAll}
                  class="px-2.5 py-1 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 text-gray-600 font-medium transition-colors">
                  â–¶ Collapse All
                </button>
                ${longestBranch && html`
                  <button onClick=${jumpToLongest}
                    class="px-2.5 py-1 bg-indigo-50 border border-indigo-200 rounded-lg hover:bg-indigo-100 text-indigo-700 font-medium transition-colors">
                    ğŸ“ˆ Longest (${longestBranch.postCount} post${longestBranch.postCount!==1?'s':''})
                  </button>
                `}
              </div>
            </div>

            <!-- Filters row -->
            <div class=${`mb-4 px-3 py-2.5 rounded-xl border flex flex-wrap items-center gap-x-4 gap-y-2 ${anyFilterActive ? 'bg-amber-50 border-amber-200' : 'bg-white border-gray-100'}`}>
              <label class="flex items-center gap-1.5 cursor-pointer text-xs text-gray-700 select-none whitespace-nowrap"
                title="Hide leaf posts that have no replies">
                <input type="checkbox" checked=${hideStubs}
                  onChange=${e=>setHideStubs(e.target.checked)} />
                Hide stubs
              </label>
              <label class="flex items-center gap-1.5 cursor-pointer text-xs text-gray-700 select-none whitespace-nowrap"
                title="Auto-collapse branches where the OP (thread author) never replied">
                <input type="checkbox" checked=${collapseNonOP}
                  onChange=${e=>setCollapseNonOP(e.target.checked)} />
                Collapse non-OP
              </label>
              <div class="flex items-center gap-1 text-xs text-gray-500" title="Minimum like count">
                <span>â¤ï¸â‰¥</span>
                <input type="number" min="0" value=${minLikes}
                  onInput=${e=>setMinLikes(e.target.value)}
                  class="w-14 px-1.5 py-0.5 border border-gray-200 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-300 bg-white"
                  placeholder="0" />
              </div>
              <div class="flex items-center gap-1 text-xs text-gray-500" title="Minimum reply count">
                <span>ğŸ’¬â‰¥</span>
                <input type="number" min="0" value=${minReplies}
                  onInput=${e=>setMinReplies(e.target.value)}
                  class="w-14 px-1.5 py-0.5 border border-gray-200 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-300 bg-white"
                  placeholder="0" />
              </div>
              <div class="flex items-center gap-1 text-xs text-gray-500" title="Search post text, author handle, or display name">
                <span>ğŸ”</span>
                <input type="text" value=${search}
                  onInput=${e=>setSearch(e.target.value)}
                  class="w-28 px-1.5 py-0.5 border border-gray-200 rounded text-xs focus:outline-none focus:ring-1 focus:ring-sky-300 bg-white"
                  placeholder="searchâ€¦" />
              </div>
              ${anyFilterActive && html`
                <button onClick=${clearFilters}
                  class="ml-auto text-xs text-gray-400 hover:text-gray-600 flex-shrink-0 transition-colors">
                  âœ• Clear
                </button>
              `}
            </div>

            <${PostCard}
              node=${thread}
              isRoot=${true}
              depth=${0}
              rootAuthorDid=${rootAuthorDid}
              filters=${filters}
              collapseKey=${collapseKey}
              expandKey=${expandKey}
              longestBranchUri=${longestBranch?.node?.post?.uri}
            />
          `}
          ${!thread && !loading && !error && html`
            <div class="text-center py-20 text-gray-400">
              <div class="text-5xl mb-3">ğŸŒ¿</div>
              <p class="text-sm">Paste a Bluesky post URL above</p>
            </div>
          `}
        </div>
      `;
    }

    try {
      render(html`<${App} />`, document.getElementById('app'));
    } catch(e) {
      document.getElementById('err').style.display='block';
      document.getElementById('err').textContent='Render failed: '+e.message+'\n'+e.stack;
    }
  </script>
</body>
</html>
