<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bluesky Zeitgeist</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <script type="importmap">
    {
      "imports": {
        "preact": "https://esm.sh/*preact@10.23.1",
        "preact/": "https://esm.sh/*preact@10.23.1/",
        "@preact/signals": "https://esm.sh/*@preact/signals@1.3.0",
        "@preact/signals-core": "https://esm.sh/*@preact/signals-core@1.8.0",
        "htm": "https://esm.sh/*htm@3.1.1",
        "htm/preact": "https://esm.sh/*htm@3.1.1/preact"
      }
    }
  </script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
    body { font-family: 'JetBrains Mono', monospace; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .animate-pulse-slow { animation: pulse 1.5s ease-in-out infinite; }
    .drag-over { outline: 2px dashed #a78bfa; outline-offset: -2px; background: rgba(167, 139, 250, 0.1) !important; }
    .dragging { opacity: 0.5; }
  </style>
</head>
<body class="bg-gray-950 text-gray-200 min-h-screen">
  <div id="app"></div>
  
  <script type="module">
    import { render } from 'preact';
    import { useState, useEffect, useRef } from 'preact/hooks';
    import { signal, computed } from '@preact/signals';
    import { html } from 'htm/preact';

    // ========================================================================
    // CONSTANTS
    // ========================================================================
    
    const JETSTREAM_URL = 'wss://jetstream1.us-east.bsky.network/subscribe?wantedCollections=app.bsky.feed.post';
    
    // Stopwords - don't use these as standalone search terms
    const STOPWORDS = new Set([
      'a','able','about','above','across','after','again','against','all','almost',
      'alone','along','already','also','although','always','am','among','an','and',
      'another','any','anyone','anything','anywhere','are','around','as','at','away',
      'back','be','became','because','become','been','before','behind','being','below',
      'between','both','but','by','can','cannot','could','did','do','does','doing',
      'done','down','during','each','either','else','enough','even','ever','every',
      'everyone','everything','few','find','first','for','found','from','get','give',
      'go','going','gone','good','got','had','has','have','having','he','her','here',
      'hers','him','his','how','however','i','if','in','into','is','it','its','just',
      'keep','know','last','least','let','like','likely','long','look','made','make',
      'many','may','me','might','more','most','much','must','my','need','never','new',
      'no','not','nothing','now','of','off','often','on','once','one','only','or',
      'other','our','out','over','own','part','per','put','rather','re','same','see',
      'seem','seemed','seeming','seems','she','should','since','so','some','something',
      'sometime','sometimes','still','such','take','than','that','the','their','them',
      'then','there','therefore','these','they','thing','things','think','this','those',
      'though','through','thus','to','together','too','took','toward','under','until',
      'up','upon','us','use','used','uses','using','very','want','was','way','we',
      'well','went','were','what','when','where','whether','which','while','who',
      'whose','why','will','with','within','without','would','yet','you','your',
    ]);
    
    // Generic words that appear in entities but aren't distinctive
    const GENERIC_ENTITY_WORDS = new Set([
      // Locations
      'beach','city','county','state','street','avenue','road','park','center','centre',
      'university','college','school','institute','hospital','airport','station','tower',
      'building','square','plaza','district','region','area','north','south','east','west',
      // Titles/roles
      'president','senator','governor','mayor','director','chief','officer','minister',
      'secretary','general','captain','doctor','professor','judge','king','queen','prince',
      // News/media
      'breaking','news','update','report','alert','live','watch','read','more','via',
      // Common first names (short)
      'rob','bob','jim','joe','tom','mike','john','james','david','mark','paul','steve',
      'bill','dan','don','ben','sam','tim','ed','al','lee','ray','jay','max','ian',
      'mary','ann','sue','amy','kim','lisa','jane','kate','sara','beth','jean','rose',
      // Time
      'day','week','month','year','today','yesterday','tomorrow','monday','tuesday',
      'wednesday','thursday','friday','saturday','sunday','january','february','march',
      'april','may','june','july','august','september','october','november','december',
      // Other generic
      'new','old','big','great','good','best','first','last','top','high','low','late',
      'early','young','little','small','free','full','real','true','false','open',
    ]);

    // ========================================================================
    // ENTITY EXTRACTION & EXPANSION
    // ========================================================================
    
    function extractEntities(text) {
      // Match multi-word Title Case phrases
      const matches = text.match(/\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)\b/g) || [];
      return matches.filter(m => {
        const first = m.split(' ')[0];
        // Filter out common sentence starters
        return !['The','This','That','What','When','Where','How','Why','Who',
                 'Just','But','And','For','New','See','Get','Let','One','Two'].includes(first);
      });
    }
    
    function expandEntity(entity) {
      // Generate search variants for an entity
      const variants = [entity.toLowerCase()];

      const words = entity.split(' ');

      // Only add individual words if they're distinctive enough
      // Require >4 chars (stricter), not stopword, not generic, and not too common
      const distinctiveWords = [];
      for (const word of words) {
        const lower = word.toLowerCase();
        if (lower.length > 4 &&
            !STOPWORDS.has(lower) &&
            !GENERIC_ENTITY_WORDS.has(lower)) {
          distinctiveWords.push(lower);
        }
      }

      // Only add individual words if the entity has 2+ words and the word is distinctive
      // This prevents "musk" matching "musky", "elon" matching "elongated" etc.
      // For 2-word entities, only add words with 5+ chars to be safer
      const minWordLen = words.length <= 2 ? 5 : 4;
      for (const w of distinctiveWords) {
        if (w.length >= minWordLen && !variants.includes(w)) {
          variants.push(w);
        }
      }

      // Add bigrams for entities with 3+ words (e.g., "United States Congress" -> "united states", "states congress")
      if (words.length >= 3) {
        for (let i = 0; i < words.length - 1; i++) {
          const bigram = words[i].toLowerCase() + ' ' + words[i + 1].toLowerCase();
          if (!variants.includes(bigram)) {
            variants.push(bigram);
          }
        }
      }

      return variants;
    }

    // Check if text matches a variant using word-boundary-aware matching
    function matchesVariant(textLower, variant) {
      const idx = textLower.indexOf(variant);
      if (idx === -1) return false;

      // For multi-word variants, substring match is fine (already specific)
      if (variant.includes(' ')) return true;

      // For single words, check word boundaries to reduce false positives
      // e.g., prevent "trump" matching "trumpet" or "biden" matching "abiden"
      const before = idx > 0 ? textLower[idx - 1] : ' ';
      const after = idx + variant.length < textLower.length ? textLower[idx + variant.length] : ' ';
      const boundaryChars = /[\s.,;:!?'"()\-\[\]{}\/\\@#$%^&*+=<>~`|‚Äî‚Äì\n\r\t]/;
      return (idx === 0 || boundaryChars.test(before)) &&
             (idx + variant.length === textLower.length || boundaryChars.test(after));
    }

    // ========================================================================
    // GLOBAL STATE
    // ========================================================================
    
    const phase = signal('idle'); // idle | sampling | tracking
    const error = signal(null);
    const connectionStatus = signal('disconnected');
    
    // Sampling state
    const postCount = signal(0);
    const postsPerSecond = signal(0);
    const entities = signal({}); // { name: count }
    const languages = signal({});
    
    // Tracking state
    const selectedTopics = signal([]); // [{ name, variants, group? }]
    const topicFrequencies = signal({}); // { name: currentWindowCount }
    const frequencyHistory = signal([]); // [{ time, topic1: freq, topic2: freq, ... }]
    const matchingPosts = signal([]); // [{ text, topic, time, did }] - live feed (#108)
    const showLiveFeed = signal(false); // Toggle live post feed visibility

    // Drag-and-drop state (#106)
    const dragSource = signal(null); // entity name being dragged
    const dragOverTarget = signal(null); // topic name being dragged over

    // ========================================================================
    // MAIN APP
    // ========================================================================
    
    function App() {
      const wsRef = useRef(null);
      const chartRef = useRef(null);
      const chartInstance = useRef(null);
      const statsRef = useRef({ count: 0, windowStart: Date.now(), lastCounts: {} });
      const historyIntervalRef = useRef(null);

      // Cleanup
      useEffect(() => {
        return () => {
          if (wsRef.current) wsRef.current.close();
          if (chartInstance.current) chartInstance.current.destroy();
          if (historyIntervalRef.current) clearInterval(historyIntervalRef.current);
        };
      }, []);

      // Update chart data in place
      useEffect(() => {
        if (phase.value !== 'tracking' || !chartRef.current) return;
        
        const history = frequencyHistory.value;
        const topics = selectedTopics.value;
        
        if (!chartInstance.current) {
          const colors = ['#22d3ee', '#f472b6', '#a78bfa', '#34d399', '#fbbf24', '#f87171'];
          
          chartInstance.current = new Chart(chartRef.current, {
            type: 'line',
            data: {
              labels: [],
              datasets: topics.map((topic, i) => ({
                label: topic.name,
                data: [],
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length] + '20',
                tension: 0.4,
                fill: false,
                pointRadius: 0,
              }))
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: { duration: 0 }, // Disable animations
              plugins: {
                legend: { 
                  position: 'bottom',
                  labels: { color: '#9ca3af', font: { family: 'JetBrains Mono', size: 11 } }
                }
              },
              scales: {
                x: { 
                  grid: { color: '#333' },
                  ticks: { color: '#6b7280', maxTicksLimit: 10 }
                },
                y: { 
                  grid: { color: '#333' },
                  ticks: { color: '#6b7280' },
                  beginAtZero: true,
                  title: { display: true, text: 'matches/5s', color: '#6b7280' }
                }
              }
            }
          });
        }
        
        // Update data in place
        const chart = chartInstance.current;
        chart.data.labels = history.map(h => h.time + 's');
        topics.forEach((topic, i) => {
          chart.data.datasets[i].data = history.map(h => h[topic.name] || 0);
        });
        chart.update('none'); // Update without animation
        
      }, [frequencyHistory.value]);

      // ====================================================================
      // SAMPLING PHASE - Discover entities
      // ====================================================================
      
      const startSampling = () => {
        phase.value = 'sampling';
        error.value = null;
        postCount.value = 0;
        postsPerSecond.value = 0;
        entities.value = {};
        languages.value = {};
        
        const state = { 
          count: 0, 
          entities: {}, 
          langs: {},
          startTime: Date.now(),
          lastCount: 0,
        };
        
        try {
          const ws = new WebSocket(JETSTREAM_URL);
          wsRef.current = ws;
          
          ws.onopen = () => {
            connectionStatus.value = 'connected';
            console.log('Connected to Jetstream');
          };
          
          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              if (data.kind !== 'commit') return;
              if (data.commit?.collection !== 'app.bsky.feed.post') return;
              if (data.commit?.operation !== 'create') return;
              
              const text = data.commit?.record?.text;
              if (!text) return;
              
              state.count++;
              
              // Extract entities
              const ents = extractEntities(text);
              for (const e of ents) {
                state.entities[e] = (state.entities[e] || 0) + 1;
              }
              
              // Track languages
              const langs = data.commit?.record?.langs || [];
              for (const lang of langs) {
                state.langs[lang] = (state.langs[lang] || 0) + 1;
              }
            } catch (e) {}
          };
          
          ws.onerror = () => {
            error.value = 'WebSocket connection failed. This may not work in sandboxed environments.';
            connectionStatus.value = 'error';
          };
          
          ws.onclose = () => {
            connectionStatus.value = 'disconnected';
          };
          
          // Update UI every 500ms
          const updateInterval = setInterval(() => {
            const elapsed = (Date.now() - state.startTime) / 1000;
            postCount.value = state.count;
            postsPerSecond.value = elapsed > 0 ? (state.count / elapsed).toFixed(1) : 0;
            entities.value = { ...state.entities };
            languages.value = { ...state.langs };
          }, 500);
          
          // Store interval for cleanup
          statsRef.current.updateInterval = updateInterval;
          
        } catch (e) {
          error.value = `Connection failed: ${e.message}`;
          phase.value = 'idle';
        }
      };

      const stopSampling = () => {
        if (wsRef.current) wsRef.current.close();
        if (statsRef.current.updateInterval) clearInterval(statsRef.current.updateInterval);
        // Stay in sampling phase to allow topic selection
      };

      // ====================================================================
      // TRACKING PHASE - Monitor selected topics
      // ====================================================================
      
      const startTracking = () => {
        if (selectedTopics.value.length === 0) return;
        
        phase.value = 'tracking';
        frequencyHistory.value = [];
        
        // Reset chart
        if (chartInstance.current) {
          chartInstance.current.destroy();
          chartInstance.current = null;
        }
        
        const state = {
          startTime: Date.now(),
          windowCounts: {},
          windowStart: Date.now(),
          recentPosts: [],
        };
        
        // Initialize counts
        selectedTopics.value.forEach(t => { state.windowCounts[t.name] = 0; });
        topicFrequencies.value = { ...state.windowCounts };
        
        try {
          const ws = new WebSocket(JETSTREAM_URL);
          wsRef.current = ws;
          
          ws.onopen = () => {
            connectionStatus.value = 'connected';
          };
          
          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              if (data.kind !== 'commit') return;
              if (data.commit?.collection !== 'app.bsky.feed.post') return;
              if (data.commit?.operation !== 'create') return;

              const text = data.commit?.record?.text;
              if (!text) return;

              const textLower = text.toLowerCase();
              const did = data.did || '';

              // Check each topic's variants using word-boundary-aware matching (#107)
              selectedTopics.value.forEach(topic => {
                const matched = topic.variants.some(v => matchesVariant(textLower, v));
                if (matched) {
                  state.windowCounts[topic.name]++;
                  // Capture matching posts for live feed (#108)
                  state.recentPosts.push({
                    text: text.slice(0, 300),
                    topic: topic.name,
                    time: new Date().toLocaleTimeString(),
                    did,
                  });
                  // Keep buffer bounded
                  if (state.recentPosts.length > 100) {
                    state.recentPosts = state.recentPosts.slice(-50);
                  }
                }
              });
            } catch (e) {}
          };
          
          ws.onerror = () => {
            error.value = 'WebSocket connection failed';
            connectionStatus.value = 'error';
          };
          
          ws.onclose = () => {
            connectionStatus.value = 'disconnected';
          };
          
          // Record history every 5 seconds (frequency per window)
          historyIntervalRef.current = setInterval(() => {
            const elapsed = Math.floor((Date.now() - state.startTime) / 1000);

            // Create history point with current window counts
            const point = { time: elapsed };
            selectedTopics.value.forEach(topic => {
              point[topic.name] = state.windowCounts[topic.name];
            });

            frequencyHistory.value = [...frequencyHistory.value, point].slice(-30);
            topicFrequencies.value = { ...state.windowCounts };

            // Flush matching posts to signal (#108)
            if (state.recentPosts.length > 0) {
              matchingPosts.value = [...state.recentPosts].slice(-50);
            }

            // Reset window counts for next period
            selectedTopics.value.forEach(t => { state.windowCounts[t.name] = 0; });
          }, 5000);
          
        } catch (e) {
          error.value = `Connection failed: ${e.message}`;
          phase.value = 'sampling';
        }
      };

      const stopTracking = () => {
        if (wsRef.current) wsRef.current.close();
        if (historyIntervalRef.current) clearInterval(historyIntervalRef.current);
        matchingPosts.value = [];
        showLiveFeed.value = false;
        phase.value = 'sampling';
      };

      const reset = () => {
        if (wsRef.current) wsRef.current.close();
        if (statsRef.current.updateInterval) clearInterval(statsRef.current.updateInterval);
        if (historyIntervalRef.current) clearInterval(historyIntervalRef.current);
        if (chartInstance.current) {
          chartInstance.current.destroy();
          chartInstance.current = null;
        }
        phase.value = 'idle';
        postCount.value = 0;
        entities.value = {};
        selectedTopics.value = [];
        frequencyHistory.value = [];
        matchingPosts.value = [];
        showLiveFeed.value = false;
        dragSource.value = null;
        dragOverTarget.value = null;
      };

      // ====================================================================
      // TOPIC SELECTION
      // ====================================================================
      
      const toggleTopic = (name, count) => {
        const current = selectedTopics.value;
        const exists = current.find(t => t.name === name || (t.members && t.members.includes(name)));

        if (exists) {
          selectedTopics.value = current.filter(t => t.name !== exists.name);
        } else if (current.length < 6) {
          const variants = expandEntity(name);
          selectedTopics.value = [...current, { name, count, variants, members: [name] }];
        }
      };

      // Drag-and-drop handlers for entity grouping (#106)
      const handleEntityDragStart = (entityName) => {
        dragSource.value = entityName;
      };

      const handleEntityDragEnd = () => {
        dragSource.value = null;
        dragOverTarget.value = null;
      };

      const handleTopicDragOver = (e, topicName) => {
        e.preventDefault();
        dragOverTarget.value = topicName;
      };

      const handleTopicDragLeave = () => {
        dragOverTarget.value = null;
      };

      const handleTopicDrop = (e, targetTopicName) => {
        e.preventDefault();
        const sourceName = dragSource.value;
        dragSource.value = null;
        dragOverTarget.value = null;

        if (!sourceName || sourceName === targetTopicName) return;

        const current = selectedTopics.value;

        // Check if source is already in a selected topic
        const sourceTopicIdx = current.findIndex(t => t.name === sourceName || (t.members && t.members.includes(sourceName)));
        const targetTopicIdx = current.findIndex(t => t.name === targetTopicName);
        if (targetTopicIdx === -1) return;

        // If source is already a selected topic, merge the two groups
        if (sourceTopicIdx !== -1 && sourceTopicIdx !== targetTopicIdx) {
          const source = current[sourceTopicIdx];
          const target = current[targetTopicIdx];
          const mergedMembers = [...(target.members || [target.name]), ...(source.members || [source.name])];
          const mergedVariants = [...new Set([...target.variants, ...source.variants])];
          const merged = {
            name: target.name,
            count: (target.count || 0) + (source.count || 0),
            variants: mergedVariants,
            members: mergedMembers,
          };
          selectedTopics.value = current.filter((_, i) => i !== sourceTopicIdx).map(t =>
            t.name === targetTopicName ? merged : t
          );
          return;
        }

        // Source is an unselected entity ‚Äî add it to the target group
        const newVariants = expandEntity(sourceName);
        const target = current[targetTopicIdx];
        const merged = {
          ...target,
          members: [...(target.members || [target.name]), sourceName],
          variants: [...new Set([...target.variants, ...newVariants])],
          count: (target.count || 0) + (entities.value[sourceName] || 0),
        };
        selectedTopics.value = current.map(t => t.name === targetTopicName ? merged : t);
      };

      // Remove a single member from a group (#106)
      const removeMember = (topicName, memberName) => {
        const current = selectedTopics.value;
        const topic = current.find(t => t.name === topicName);
        if (!topic || !topic.members || topic.members.length <= 1) {
          // Only one member ‚Äî just remove the whole topic
          selectedTopics.value = current.filter(t => t.name !== topicName);
          return;
        }
        const newMembers = topic.members.filter(m => m !== memberName);
        if (newMembers.length === 0) {
          selectedTopics.value = current.filter(t => t.name !== topicName);
          return;
        }
        // Recalculate variants from remaining members
        const newVariants = [...new Set(newMembers.flatMap(m => expandEntity(m)))];
        const newName = memberName === topicName ? newMembers[0] : topicName;
        selectedTopics.value = current.map(t => t.name === topicName ? {
          ...t, name: newName, members: newMembers, variants: newVariants,
        } : t);
      };

      // Edit variants manually (#107)
      const editVariants = (topicName) => {
        const topic = selectedTopics.value.find(t => t.name === topicName);
        if (!topic) return;
        const input = prompt('Edit search variants (comma-separated):', topic.variants.join(', '));
        if (input === null) return;
        const newVariants = input.split(',').map(v => v.trim().toLowerCase()).filter(v => v.length > 0);
        if (newVariants.length === 0) return;
        selectedTopics.value = selectedTopics.value.map(t =>
          t.name === topicName ? { ...t, variants: newVariants } : t
        );
      };

      // ====================================================================
      // DERIVED DATA
      // ====================================================================
      
      const topEntities = computed(() => 
        Object.entries(entities.value)
          .filter(([_, n]) => n >= 2)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 20)
      );

      const langData = computed(() => 
        Object.entries(languages.value)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 6)
      );

      // ====================================================================
      // RENDER
      // ====================================================================

      return html`
        <div class="max-w-6xl mx-auto p-4">
          <!-- Header -->
          <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-800">
            <div>
              <h1 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                BLUESKY ZEITGEIST
              </h1>
              <p class="text-xs text-gray-500 tracking-wider mt-1">
                FIREHOSE ‚Ä¢ ENTITY DETECTION ‚Ä¢ TOPIC TRACKING
              </p>
            </div>
            
            <div class="flex items-center gap-3">
              <!-- Connection status -->
              <div class="flex items-center gap-2 text-xs">
                <span class="w-2 h-2 rounded-full ${
                  connectionStatus.value === 'connected' ? 'bg-green-500' :
                  connectionStatus.value === 'error' ? 'bg-red-500' : 'bg-gray-600'
                }"></span>
                <span class="text-gray-500">${connectionStatus.value}</span>
              </div>
              
              ${phase.value === 'idle' && html`
                <button 
                  onClick=${startSampling}
                  class="bg-gradient-to-r from-cyan-500 to-blue-500 text-black font-semibold px-5 py-2 rounded-lg text-sm hover:opacity-90"
                >
                  ‚ñ∂ CONNECT TO FIREHOSE
                </button>
              `}
              
              ${phase.value === 'sampling' && html`
                <button 
                  onClick=${stopSampling}
                  class="bg-gray-700 text-gray-200 font-semibold px-4 py-2 rounded-lg text-sm"
                >
                  ‚ñ† PAUSE
                </button>
                <button 
                  onClick=${startTracking}
                  disabled=${selectedTopics.value.length === 0}
                  class="bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold px-4 py-2 rounded-lg text-sm disabled:opacity-40"
                >
                  ‚ñ∂ TRACK (${selectedTopics.value.length})
                </button>
                <button 
                  onClick=${reset}
                  class="bg-gray-800 text-gray-400 px-3 py-2 rounded-lg text-sm border border-gray-700"
                >
                  ‚Ü∫
                </button>
              `}
              
              ${phase.value === 'tracking' && html`
                <button 
                  onClick=${stopTracking}
                  class="bg-gradient-to-r from-yellow-500 to-orange-500 text-black font-semibold px-5 py-2 rounded-lg text-sm"
                >
                  ‚ñ† STOP TRACKING
                </button>
              `}
            </div>
          </div>

          ${error.value && html`
            <div class="bg-red-900/30 border border-red-700/50 rounded-lg px-4 py-3 mb-4 text-red-400 text-sm">
              ‚ö† ${error.value}
            </div>
          `}

          <!-- Idle State -->
          ${phase.value === 'idle' && html`
            <div class="flex flex-col items-center justify-center py-20">
              <div class="w-24 h-24 rounded-full bg-gradient-to-br from-cyan-500/20 to-purple-500/20 border-2 border-cyan-500/30 flex items-center justify-center text-5xl mb-6">
                ü¶ã
              </div>
              <h2 class="text-lg text-gray-300 font-medium">Ready to Connect</h2>
              <p class="text-gray-500 text-sm mt-2 text-center max-w-md">
                Connects to Bluesky's Jetstream firehose (~50 posts/sec), detects trending entities via Title Case extraction, then tracks selected topics in real-time.
              </p>
            </div>
          `}

          <!-- Sampling Phase -->
          ${phase.value === 'sampling' && html`
            <div class="grid grid-cols-2 gap-4">
              <!-- Left: Stats & Entities -->
              <div class="space-y-4">
                <!-- Live Stats -->
                <div class="bg-gray-900/60 rounded-lg p-4 border border-gray-800">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-semibold text-cyan-400 tracking-wider">FIREHOSE STATS</h3>
                    <span class="flex items-center gap-1.5 px-2 py-0.5 bg-cyan-500/10 rounded-full text-[10px] text-cyan-400">
                      <span class="w-1.5 h-1.5 rounded-full bg-cyan-400 animate-pulse-slow"></span>
                      LIVE
                    </span>
                  </div>
                  
                  <div class="grid grid-cols-3 gap-4">
                    <div>
                      <div class="text-2xl font-bold text-white">${postCount.value.toLocaleString()}</div>
                      <div class="text-[10px] text-gray-500">POSTS</div>
                    </div>
                    <div>
                      <div class="text-2xl font-bold text-white">${postsPerSecond.value}</div>
                      <div class="text-[10px] text-gray-500">POSTS/SEC</div>
                    </div>
                    <div>
                      <div class="text-2xl font-bold text-white">${Object.keys(entities.value).length}</div>
                      <div class="text-[10px] text-gray-500">ENTITIES</div>
                    </div>
                  </div>
                  
                  ${langData.value.length > 0 && html`
                    <div class="mt-4">
                      <div class="text-[10px] text-gray-500 mb-2">LANGUAGES</div>
                      <div class="flex flex-wrap gap-1.5">
                        ${langData.value.map(([lang, count]) => html`
                          <span key=${lang} class="px-2 py-0.5 bg-gray-800 rounded text-[11px] text-gray-400">
                            ${lang} <span class="text-cyan-400">${postCount.value > 0 ? ((count / postCount.value) * 100).toFixed(0) : 0}%</span>
                          </span>
                        `)}
                      </div>
                    </div>
                  `}
                </div>

                <!-- Detected Entities -->
                <div class="bg-gray-900/60 rounded-lg p-4 border border-gray-800">
                  <h3 class="text-xs font-semibold text-pink-400 tracking-wider mb-3">DETECTED ENTITIES</h3>
                  <div class="space-y-1 max-h-80 overflow-y-auto">
                    ${topEntities.value.length === 0
                      ? html`<span class="text-gray-500 text-sm">Detecting Title Case phrases...</span>`
                      : topEntities.value.map(([entity, count], i) => {
                        const isSelected = selectedTopics.value.some(t => t.name === entity || (t.members && t.members.includes(entity)));
                        return html`
                          <button
                            key=${entity}
                            draggable="true"
                            onDragStart=${() => handleEntityDragStart(entity)}
                            onDragEnd=${handleEntityDragEnd}
                            onClick=${() => toggleTopic(entity, count)}
                            class="w-full flex justify-between items-center px-2 py-1.5 rounded text-left transition-colors ${
                              dragSource.value === entity ? 'dragging' : ''
                            } ${
                              isSelected
                                ? 'bg-purple-500/20 border border-purple-500/50'
                                : i === 0
                                  ? 'bg-pink-500/10 border-l-2 border-pink-500 hover:bg-pink-500/20'
                                  : 'hover:bg-gray-800 border-l-2 border-transparent'
                            }"
                          >
                            <span class="text-sm ${i === 0 && !isSelected ? 'text-pink-400' : isSelected ? 'text-purple-300' : 'text-gray-300'}">
                              ${i === 0 && !isSelected ? 'üî• ' : ''}${entity}
                              ${isSelected ? ' ‚úì' : ''}
                            </span>
                            <span class="flex items-center gap-1">
                              <span class="text-xs text-gray-500">${count}</span>
                              <span class="text-[10px] text-gray-600 cursor-grab" title="Drag to group with a selected topic">‚†ø</span>
                            </span>
                          </button>
                        `;
                      })
                    }
                  </div>
                </div>
              </div>

              <!-- Right: Selected Topics -->
              <div class="space-y-4">
                <div class="bg-purple-500/10 rounded-lg p-4 border border-purple-500/30">
                  <h3 class="text-xs font-semibold text-purple-400 tracking-wider mb-3">
                    SELECTED TOPICS (${selectedTopics.value.length}/6)
                  </h3>
                  
                  ${selectedTopics.value.length === 0
                    ? html`<p class="text-gray-500 text-sm">Click entities on the left to select topics for tracking. Drag entities onto a selected topic to group them.</p>`
                    : html`
                      <div class="space-y-3">
                        ${selectedTopics.value.map((topic, i) => {
                          const colors = ['border-cyan-500', 'border-pink-500', 'border-purple-500', 'border-green-500', 'border-yellow-500', 'border-red-500'];
                          const isDropTarget = dragOverTarget.value === topic.name;
                          return html`
                            <div key=${topic.name}
                              onDragOver=${(e) => handleTopicDragOver(e, topic.name)}
                              onDragLeave=${handleTopicDragLeave}
                              onDrop=${(e) => handleTopicDrop(e, topic.name)}
                              class="bg-gray-900/60 rounded-lg p-3 border-l-2 ${colors[i % colors.length]} ${isDropTarget ? 'drag-over' : ''} transition-all"
                            >
                              <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-white text-sm">${topic.name}</span>
                                <div class="flex items-center gap-1">
                                  <!-- Search links (#109) -->
                                  <a href="https://bsky.app/search?q=${encodeURIComponent(topic.name)}"
                                    target="_blank" rel="noopener"
                                    class="text-cyan-500 hover:text-cyan-300 text-[10px] px-1.5 py-0.5 rounded bg-cyan-500/10 hover:bg-cyan-500/20"
                                    title="Search on Bluesky"
                                    onClick=${(e) => e.stopPropagation()}
                                  >bsky</a>
                                  <a href="https://news.google.com/search?q=${encodeURIComponent(topic.name)}"
                                    target="_blank" rel="noopener"
                                    class="text-yellow-500 hover:text-yellow-300 text-[10px] px-1.5 py-0.5 rounded bg-yellow-500/10 hover:bg-yellow-500/20"
                                    title="Search on Google News"
                                    onClick=${(e) => e.stopPropagation()}
                                  >news</a>
                                  <!-- Edit variants (#107) -->
                                  <button
                                    onClick=${() => editVariants(topic.name)}
                                    class="text-gray-500 hover:text-blue-400 text-[10px] px-1"
                                    title="Edit search variants"
                                  >‚úé</button>
                                  <button
                                    onClick=${() => toggleTopic(topic.name)}
                                    class="text-gray-500 hover:text-red-400 text-xs"
                                  >‚úï</button>
                                </div>
                              </div>
                              ${topic.members && topic.members.length > 1 ? html`
                                <div class="flex flex-wrap gap-1 mb-2">
                                  ${topic.members.map(m => html`
                                    <span key=${m} class="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-purple-500/15 rounded text-[10px] text-purple-300 border border-purple-500/20">
                                      ${m}
                                      <button onClick=${() => removeMember(topic.name, m)} class="text-gray-500 hover:text-red-400 ml-0.5">√ó</button>
                                    </span>
                                  `)}
                                </div>
                              ` : ''}
                              <div class="text-[11px] text-gray-500">
                                <span class="text-gray-400">Variants:</span> ${topic.variants.join(', ')}
                              </div>
                            </div>
                          `;
                        })}
                      </div>
                    `
                  }

                  ${selectedTopics.value.length > 0 && html`
                    <p class="text-[11px] text-gray-500 mt-4">
                      Drag entities onto topics to group them. Click ‚úé to edit variants. Posts matching any variant will be counted per 5-second window.
                    </p>
                  `}
                </div>
              </div>
            </div>
          `}

          <!-- Tracking Phase -->
          ${phase.value === 'tracking' && html`
            <div class="space-y-4">
              <!-- Status -->
              <div class="bg-cyan-500/10 rounded-lg px-4 py-3 border border-cyan-500/30 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <span class="w-2.5 h-2.5 rounded-full bg-cyan-400 animate-pulse-slow"></span>
                  <span class="text-cyan-400 font-medium text-sm">TRACKING ${selectedTopics.value.length} TOPICS</span>
                  <span class="text-gray-500 text-sm">‚Ä¢ Matches per 5-second window</span>
                </div>
                <button
                  onClick=${() => { showLiveFeed.value = !showLiveFeed.value; }}
                  class="text-xs px-3 py-1.5 rounded-lg border ${showLiveFeed.value ? 'bg-green-500/20 border-green-500/50 text-green-400' : 'bg-gray-800 border-gray-700 text-gray-400 hover:text-gray-200'}"
                >
                  ${showLiveFeed.value ? '‚óè LIVE FEED ON' : '‚óã LIVE FEED'}
                </button>
              </div>

              <!-- Chart -->
              <div class="bg-gray-900/60 rounded-lg p-4 border border-gray-800">
                <h3 class="text-xs font-semibold text-cyan-400 tracking-wider mb-3">TOPIC FREQUENCY</h3>
                <div class="h-64">
                  <canvas ref=${chartRef}></canvas>
                </div>
              </div>

              <!-- Topic Cards -->
              <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                ${selectedTopics.value.map((topic, i) => {
                  const freq = topicFrequencies.value[topic.name] || 0;
                  const colors = ['border-cyan-500 text-cyan-400', 'border-pink-500 text-pink-400', 'border-purple-500 text-purple-400', 'border-green-500 text-green-400', 'border-yellow-500 text-yellow-400', 'border-red-500 text-red-400'];
                  const colorClass = colors[i % colors.length];

                  return html`
                    <div key=${topic.name} class="bg-gray-900/60 rounded-lg p-3 border border-gray-800 border-t-2 ${colorClass.split(' ')[0]}">
                      <div class="flex justify-between items-center mb-2">
                        <span class="font-medium text-white text-sm truncate">${topic.name}</span>
                        <span class="text-xl font-bold ${colorClass.split(' ')[1]}">${freq}</span>
                      </div>
                      <div class="text-[10px] text-gray-500 mb-1.5">
                        ${topic.variants.slice(0, 3).join(', ')}${topic.variants.length > 3 ? '...' : ''}
                      </div>
                      <!-- Search links (#109) -->
                      <div class="flex gap-1">
                        <a href="https://bsky.app/search?q=${encodeURIComponent(topic.name)}"
                          target="_blank" rel="noopener"
                          class="text-cyan-500 hover:text-cyan-300 text-[10px] px-1.5 py-0.5 rounded bg-cyan-500/10 hover:bg-cyan-500/20"
                        >search bsky</a>
                        <a href="https://news.google.com/search?q=${encodeURIComponent(topic.name)}"
                          target="_blank" rel="noopener"
                          class="text-yellow-500 hover:text-yellow-300 text-[10px] px-1.5 py-0.5 rounded bg-yellow-500/10 hover:bg-yellow-500/20"
                        >google news</a>
                      </div>
                    </div>
                  `;
                })}
              </div>

              <!-- Live Post Feed (#108) -->
              ${showLiveFeed.value && html`
                <div class="bg-gray-900/60 rounded-lg p-4 border border-gray-800">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-semibold text-green-400 tracking-wider">MATCHING POSTS</h3>
                    <span class="text-[10px] text-gray-500">${matchingPosts.value.length} posts captured</span>
                  </div>
                  <div class="space-y-2 max-h-80 overflow-y-auto">
                    ${matchingPosts.value.length === 0
                      ? html`<p class="text-gray-500 text-sm">Waiting for matching posts...</p>`
                      : [...matchingPosts.value].reverse().slice(0, 30).map((post, i) => {
                        const topicIdx = selectedTopics.value.findIndex(t => t.name === post.topic);
                        const topicColors = ['text-cyan-400', 'text-pink-400', 'text-purple-400', 'text-green-400', 'text-yellow-400', 'text-red-400'];
                        const tColor = topicColors[topicIdx % topicColors.length] || 'text-gray-400';
                        return html`
                          <div key=${i} class="bg-gray-800/50 rounded px-3 py-2 border-l-2 border-gray-700">
                            <div class="flex justify-between items-start mb-1">
                              <span class="text-[10px] font-medium ${tColor}">${post.topic}</span>
                              <span class="text-[10px] text-gray-600">${post.time}</span>
                            </div>
                            <p class="text-xs text-gray-300 leading-relaxed break-words">${post.text}</p>
                          </div>
                        `;
                      })
                    }
                  </div>
                </div>
              `}
            </div>
          `}

          <!-- Footer -->
          <div class="mt-8 pt-4 border-t border-gray-800 text-center text-[11px] text-gray-600">
            Bluesky Zeitgeist ‚Ä¢ Jetstream Firehose ‚Ä¢ Title Case Entity Detection ‚Ä¢ No external APIs
          </div>
        </div>
      `;
    }

    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>
</html>
