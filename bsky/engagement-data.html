<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ¦‹ BlueSky Engagement Data Processor ðŸ§µ</title>
    <script async src="https://esm.sh/@atproto/api" type="module"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1024px;
            margin: 0 auto;
            padding: 1rem;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: bold;
        }

        input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
        }

        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .tab-container {
            margin-bottom: 1rem;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 1rem;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: #4b5563;
            cursor: pointer;
        }

        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #error, .auth-error {
            color: #ef4444;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #ef4444;
            border-radius: 0.25rem;
            display: none;
        }

        .output-container {
            position: relative;
        }

        .output-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .action-button {
            background: #4b5563;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .action-button:hover {
            background: #374151;
        }

        pre {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.25rem;
            overflow: auto;
            max-height: 600px;
            white-space: pre-wrap;
            margin-top: 0;
        }

        .copy-feedback {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: #059669;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            display: none;
        }

        .loading {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #module-error {
            background: #fee2e2;
            padding: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            display: none;
        }

        #debug {
            margin-top: 1rem;
            padding: 1rem;
            background: #1f2937;
            color: #d1d5db;
            border-radius: 0.25rem;
            display: none;
        }

        /* Search options */
        .search-options {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .search-options label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Auth sections */
        .auth-section {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            background-color: #f9fafb;
        }

        .auth-section h3 {
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .auth-notice {
            background-color: #fffbeb;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: 0.75rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }

        .auth-success {
            background-color: #dcfce7;
            border: 1px solid #22c55e;
            color: #166534;
            padding: 0.75rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            display: none;
        }
    </style>
</head>

<body>
    <div id="module-error">
        Your browser doesn't support ES modules. Please use a modern browser.
    </div>

    <div id="app" style="display: none">
        <h1>ðŸ¦‹ BlueSky Engagement Data Processor ðŸ§µ</h1>
        <div class="source-link" style="margin-bottom: 1rem; text-align: right;">
          <a href="https://github.com/oaustegard/oaustegard.github.io/blob/main/bsky/engagement-data.html" target="_blank" rel="noopener noreferrer">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
            </svg>
            View Source on GitHub
          </a>
        </div>
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="post-tab">Post Processing</button>
                <button class="tab-button" data-tab="search-tab">Search Processing</button>
            </div>

            <div id="post-tab" class="tab-content active">
                <p>Given the URL of a post will extract the responses or (max 100) quote posts to the original post from the public Bluesky API.<br>
                    Data is deidentified and reduced, then made available in JSON for further analysis.</p>

                <form id="processor-form">
                    <div class="input-group">
                        <input type="url" id="url-input" placeholder="Enter Bluesky post URL" required />
                    </div>
                    <div class="input-group" style="gap: 0.5rem;">
                        <button type="submit" id="process-replies">Process Replies</button>
                        <button type="submit" id="process-quotes">Process Quotes</button>
                    </div>
                </form>
            </div>

            <div id="search-tab" class="tab-content">
                <p>Search for posts with a specific query and get the results in JSON format.<br>
                    Data is reduced and made available for further analysis.</p>

                <div id="search-auth-section" class="auth-section">
                    <h3>Authentication Required</h3>
                    <div class="auth-notice">
                        The Bluesky search API now requires authentication. Please enter your Bluesky credentials to proceed.
                        Your credentials are only used to authenticate with the Bluesky API and are never stored.
                    </div>
                    <div id="auth-success" class="auth-success">
                        Successfully authenticated! You can now search for posts.
                    </div>
                    <div id="auth-error" class="auth-error"></div>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; flex: 1;">
                            <label for="handle-input">Bluesky Handle:</label>
                            <input type="text" id="handle-input" placeholder="username.bsky.social" required />
                        </div>
                    </div>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; flex: 1;">
                            <label for="password-input">App Password:</label>
                            <input type="password" id="password-input" placeholder="xxxx-xxxx-xxxx-xxxx" required />
                            <small style="margin-top: 0.25rem; color: #6b7280;">
                                <a href="https://bsky.app/settings/app-passwords" target="_blank" rel="noopener noreferrer">Create an app password</a> in your Bluesky settings
                            </small>
                        </div>
                    </div>
                    <button type="button" id="auth-button">Authenticate</button>
                </div>

                <div id="search-form-container" style="display: none;">
                    <form id="search-form">
                        <div class="input-group">
                            <input type="text" id="search-input" placeholder="Enter search query" required />
                        </div>
                        <div class="search-options">
                            <label>
                                <input type="radio" name="sort" value="top" checked /> Top results
                            </label>
                            <label>
                                <input type="radio" name="sort" value="latest" /> Latest
                            </label>
                            <label>
                                <input type="number" id="limit-input" value="25" min="1" max="100" style="width: 4rem;" />
                                Max results
                            </label>
                        </div>
                        <div class="input-group">
                            <button type="submit" id="process-search">Process Search</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="error"></div>
        <div class="output-container">
            <div class="output-actions" style="display: none">
                <button class="action-button" id="copy-button">Copy Output</button>
            </div>
            <pre id="output"></pre>
        </div>
        <div id="copy-feedback" class="copy-feedback">Copied to clipboard!</div>
    </div>

    <script nomodule>
        document.getElementById('module-error').style.display = 'block';
    </script>

    <script type="module">
        try {
            const { BskyAgent } = await import('https://esm.sh/@atproto/api');
            document.getElementById('app').style.display = 'block';

            /* Tab handling */
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    
                    /* Update active tab button */
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    /* Update active tab content */
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });

                    /* Update URL */
                    updateQueryParam('tab', tabId);
                });
            });

            /* Create the agent using the public endpoint â€“ no authentication required for post processing. */
            const agent = new BskyAgent({
                service: 'https://bsky.social'
            });

            /* Create a separate agent for authenticated search requests */
            const searchAgent = new BskyAgent({
                service: 'https://bsky.social'
            });
            let isAuthenticated = false;

            const debugLog = {
                add(type, data) {
                    console.log(`[${new Date().toISOString()}] ${type}`, data);
                },
                clear() {
                    console.clear();
                }
            };

            const postForm = document.getElementById('processor-form');
            const searchForm = document.getElementById('search-form');
            const urlInput = document.getElementById('url-input');
            const searchInput = document.getElementById('search-input');
            const limitInput = document.getElementById('limit-input');
            const error = document.getElementById('error');
            const output = document.getElementById('output');
            const copyButton = document.getElementById('copy-button');
            const copyFeedback = document.getElementById('copy-feedback');

            /* Authentication elements */
            const authButton = document.getElementById('auth-button');
            const handleInput = document.getElementById('handle-input');
            const passwordInput = document.getElementById('password-input');
            const authError = document.getElementById('auth-error');
            const authSuccess = document.getElementById('auth-success');
            const searchFormContainer = document.getElementById('search-form-container');
            const searchAuthSection = document.getElementById('search-auth-section');

            /* === Authentication Handling === */
            
            authButton.addEventListener('click', async () => {
                authError.style.display = 'none';
                authSuccess.style.display = 'none';
                
                const handle = handleInput.value.trim();
                const password = passwordInput.value.trim();
                
                if (!handle || !password) {
                    authError.textContent = 'Please enter both handle and password';
                    authError.style.display = 'block';
                    return;
                }
                
                authButton.disabled = true;
                authButton.innerHTML = '<span class="loading"></span>Authenticating...';
                
                try {
                    await searchAgent.login({
                        identifier: handle,
                        password: password
                    });
                    
                    isAuthenticated = true;
                    authSuccess.style.display = 'block';
                    searchAuthSection.style.display = 'none';
                    searchFormContainer.style.display = 'block';
                    
                    /* Save login status in session storage */
                    sessionStorage.setItem('bsky_authenticated', 'true');
                    
                    /* Auto-process if query parameters exist */
                    autoProcessIfReady();
                } catch (err) {
                    authError.textContent = `Authentication failed: ${err.message || 'Invalid credentials'}`;
                    authError.style.display = 'block';
                    console.error('Auth error:', err);
                } finally {
                    authButton.disabled = false;
                    authButton.textContent = 'Authenticate';
                }
            });

            /* Check if already authenticated in this session */
            if (sessionStorage.getItem('bsky_authenticated') === 'true') {
                isAuthenticated = true;
                searchAuthSection.style.display = 'none';
                searchFormContainer.style.display = 'block';
            }

            /* === Query String Parameter Handling === */

            function getQueryParam(param) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            }

            function updateQueryParam(param, value) {
                const url = new URL(window.location);
                if (value) {
                    url.searchParams.set(param, value);
                } else {
                    url.searchParams.delete(param);
                }
                window.history.replaceState({}, '', url);
            }

            function autoProcessIfReady() {
                const currentTab = getQueryParam('tab') || 'post-tab';
                
                if (currentTab === 'post-tab') {
                    const currentUrl = urlInput.value.trim();
                    if (currentUrl) {
                        const processType = getQueryParam('quotes') === 'true' ? 'process-quotes' : 'process-replies';
                        const button = document.getElementById(processType);
                        if (button && !button.disabled) {
                            postForm.dispatchEvent(new Event('submit'));
                        }
                    }
                } else if (currentTab === 'search-tab' && isAuthenticated) {
                    const currentQuery = searchInput.value.trim();
                    if (currentQuery) {
                        const button = document.getElementById('process-search');
                        if (button && !button.disabled) {
                            searchForm.dispatchEvent(new Event('submit'));
                        }
                    }
                }
            }

            window.addEventListener('load', () => {
                /* Set active tab from URL */
                const tabParam = getQueryParam('tab');
                if (tabParam) {
                    const tabButton = document.querySelector(`.tab-button[data-tab="${tabParam}"]`);
                    if (tabButton) {
                        tabButton.click();
                    }
                }

                /* Set post URL from URL params */
                const qspUrl = getQueryParam('url');
                if (qspUrl) {
                    urlInput.value = qspUrl;
                    updateQueryParam('url', qspUrl);
                }

                /* Set search query from URL params */
                const qspQuery = getQueryParam('q');
                if (qspQuery) {
                    searchInput.value = qspQuery;
                    updateQueryParam('q', qspQuery);
                }

                /* Set limit from URL params */
                const qspLimit = getQueryParam('limit');
                if (qspLimit) {
                    limitInput.value = qspLimit;
                    updateQueryParam('limit', qspLimit);
                }

                /* Set sort option from URL params */
                const qspSort = getQueryParam('sort');
                if (qspSort) {
                    const sortRadio = document.querySelector(`input[name="sort"][value="${qspSort}"]`);
                    if (sortRadio) {
                        sortRadio.checked = true;
                        updateQueryParam('sort', qspSort);
                    }
                }

                autoProcessIfReady();
            });

            /* Helper Functions */

            function getRelativeTime(baseTime, compareTime) {
                const diff = compareTime - baseTime;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                if (days > 0) return `${days}d`;
                if (hours > 0) return `${hours}h`;
                if (minutes > 0) return `${minutes}m`;
                return 'now';
            }

            function safeGetCreatedAt(post) {
                try {
                    return new Date(post?.record?.createdAt || 0);
                } catch (e) {
                    debugLog.add('date_error', { error: e.message, post });
                    return new Date(0);
                }
            }

            /* Reconstruct text with full URLs from facets. */
            function reconstructTextWithFacets(text, facets) {
                if (!facets || facets.length === 0) {
                    return text;
                }
                facets.sort((a, b) => a.index.byteStart - b.index.byteStart);
                let reconstructedText = '';
                let lastIndex = 0;
                function byteToCharOffset(str, byteOffset) {
                    let currentByte = 0;
                    for (let i = 0; i < str.length; i++) {
                        const char = str[i];
                        const charBytes = new TextEncoder().encode(char).length;
                        if (currentByte + charBytes > byteOffset) {
                            return i;
                        }
                        currentByte += charBytes;
                    }
                    return str.length;
                }
                facets.forEach(facet => {
                    if (facet.features && facet.features.length > 0) {
                        const linkFeature = facet.features.find(feature => feature['$type'] === 'app.bsky.richtext.facet#link');
                        if (linkFeature) {
                            const byteStart = facet.index.byteStart;
                            const byteEnd = facet.index.byteEnd;
                            const charStart = byteToCharOffset(text, byteStart);
                            const charEnd = byteToCharOffset(text, byteEnd);
                            reconstructedText += text.substring(lastIndex, charStart);
                            reconstructedText += linkFeature.uri;
                            lastIndex = charEnd;
                        }
                    }
                });
                reconstructedText += text.substring(lastIndex);
                return reconstructedText;
            }

            /* Process a post to extract key fields. */
            function processPost(post, idCounter) {
                debugLog.add('process_post', post);
                if (!post?.record) return null;
                let content = post.record.text || '';
                if (post.record.facets && Array.isArray(post.record.facets)) {
                    content = reconstructTextWithFacets(content, post.record.facets);
                }
                const result = {
                    id: idCounter,
                    author: post.author?.did || 'unknown',
                    createdAt: post.record?.createdAt ? new Date(post.record.createdAt) : new Date(0),
                    content: content
                };
                /* Handle image embeds. */
                if (post.record?.embed?.$type === 'app.bsky.embed.images' && post.embed?.$type === 'app.bsky.embed.images#view') {
                    result.images = post.record.embed.images.map((img, i) => ({
                        url: post.embed.images[i].fullsize,
                        alt: img.alt
                    })).filter(img => img.url);
                }
                /* Handle record embeds. */
                if (post.record?.embed?.$type === 'app.bsky.embed.record' && post.embed?.$type === 'app.bsky.embed.record#view') {
                    result.embed = post.embed;
                }
                if (post.likeCount > 0) {
                    result.likes = parseInt(post.likeCount);
                }
                if (post.repostCount > 0) {
                    result.reposts = parseInt(post.repostCount);
                }
                return result;
            }

            /* Extract post info (handle and postId) from the provided URL. */
            function extractPostInfo(url) {
                const match = url.match(/bsky\.app\/profile\/([^/]+)\/post\/([^/?]+)/);
                if (!match) throw new Error('Invalid Bluesky post URL');
                return { handle: match[1], postId: match[2] };
            }

            /* Process thread in the default way (recursively processing replies) */
            async function processThread(postInfo) {
                debugLog.clear();
                debugLog.add('process_thread_start', postInfo);
                let userMap = new Map();
                let userCounter = 0;
                let postCounter = 0;
                function anonymize(did) {
                    if (!userMap.has(did)) {
                        userMap.set(did, `p${++userCounter}`);
                    }
                    return userMap.get(did);
                }
                try {
                    const threadData = await agent.getPostThread({
                        uri: `at://${postInfo.handle}/app.bsky.feed.post/${postInfo.postId}`,
                        depth: 100
                    });
                    debugLog.add('thread_data', threadData);
                    if (!threadData?.data?.thread?.post) {
                        throw new Error('Invalid thread data received');
                    }
                    function processNode(node) {
                        debugLog.add('process_node', node);
                        if (!node?.post) {
                            debugLog.add('invalid_node', node);
                            return null;
                        }
                        const post = processPost(node.post, ++postCounter);
                        if (!post) return null;
                        const result = {
                            id: post.id,
                            author: anonymize(post.author),
                            content: post.content
                        };
                        if (post.images) {
                            result.images = post.images;
                        }
                        if (post.likes > 0) {
                            result.likes = post.likes;
                        }
                        if (post.reposts > 0) {
                            result.reposts = post.reposts;
                        }
                        const rootTime = safeGetCreatedAt(threadData.data.thread.post);
                        if (post.createdAt && post.createdAt > rootTime) {
                            result.delay = getRelativeTime(rootTime, post.createdAt);
                        }
                        if (Array.isArray(node.replies) && node.replies.length > 0) {
                            const validReplies = node.replies.filter(reply => {
                                const hasContent = reply?.post?.record?.text || reply?.post?.record?.embed;
                                const hasTime = reply?.post?.record?.createdAt;
                                if (!hasContent || !hasTime) {
                                    debugLog.add('invalid_reply', reply);
                                }
                                return hasContent && hasTime;
                            });
                            if (validReplies.length > 0) {
                                validReplies.sort((a, b) => {
                                    const timeA = safeGetCreatedAt(a.post);
                                    const timeB = safeGetCreatedAt(b.post);
                                    return timeA - timeB;
                                });
                                const replies = validReplies
                                    .map(reply => processNode(reply))
                                    .filter(Boolean);
                                if (replies.length > 0) {
                                    result.replies = replies;
                                }
                            }
                        }
                        return result;
                    }
                    return processNode(threadData.data.thread);
                } catch (err) {
                    debugLog.add('thread_error', err);
                    console.error('Thread processing error:', err);
                    throw new Error(`Failed to fetch thread: ${err.message}`);
                }
            }

            /* Process quotes by first fetching the actor's profile to get its DID,
             * then building the correct post URI and calling getQuotes with a limit of 100. */
            async function processQuotes(postInfo) {
                debugLog.clear();
                /* Fetch the actor profile using the web handle. */
                const profileRes = await agent.api.app.bsky.actor.getProfile({
                    actor: postInfo.handle
                });
                /* Updated check: use profileRes.data.did directly. */
                if (!profileRes.data || !profileRes.data.did) {
                    throw new Error('Failed to fetch actor profile');
                }
                const did = profileRes.data.did;
                /* Construct the root post URI using the actor's DID. */
                const rootURI = `at://${did}/app.bsky.feed.post/${postInfo.postId}`;

                /* Fetch the root post (shallow fetch). */
                const threadData = await agent.getPostThread({ uri: rootURI, depth: 1 });
                if (!threadData?.data?.thread?.post) {
                    throw new Error('Failed to fetch root post');
                }
                let postCounter = 1;
                const rootPost = processPost(threadData.data.thread.post, postCounter);

                /* Fetch quotes using the public getQuotes API endpoint with limit 100. */
                const quotesData = await agent.api.app.bsky.feed.getQuotes({
                    uri: rootURI,
                    limit: 100
                });
                debugLog.add('quotes_data', quotesData);
                let quotePosts = [];
                if (quotesData.data && quotesData.data.posts) {
                    for (const post of quotesData.data.posts) {
                        const processed = processPost(post, ++postCounter);
                        if (processed && processed.content) {
                            /* Remove the embed if it quotes the original post. */
                            if (processed.embed && processed.embed.record && processed.embed.record.uri === rootURI) {
                                delete processed.embed;
                            }
                            quotePosts.push(processed);
                        }
                    }
                }
                return { root: rootPost, quotePosts: quotePosts };
            }

            /* Process search results */
            async function processSearch(query, limit, sort) {
                debugLog.clear();
                debugLog.add('process_search_start', { query, limit, sort });
                
                if (!isAuthenticated) {
                    throw new Error('Authentication required for search');
                }
                
                try {
                    /* Call the searchPosts API endpoint with authentication */
                    const searchData = await searchAgent.api.app.bsky.feed.searchPosts({
                        q: query,
                        limit: limit,
                        sort: sort
                    });
                    
                    debugLog.add('search_data', searchData);
                    
                    if (!searchData?.data?.posts) {
                        throw new Error('No search results found');
                    }
                    
                    let userMap = new Map();
                    let userCounter = 0;
                    let postCounter = 0;
                    
                    function anonymize(did) {
                        if (!userMap.has(did)) {
                            userMap.set(did, `p${++userCounter}`);
                        }
                        return userMap.get(did);
                    }
                    
                    const posts = [];
                    
                    /* Process each search result */
                    for (const post of searchData.data.posts) {
                        const processed = processPost(post, ++postCounter);
                        if (processed) {
                            /* Add post URI for reference */
                            if (post.uri) {
                                processed.uri = post.uri;
                            }
                            
                            /* Anonymize author DID */
                            processed.author = anonymize(processed.author);
                            
                            /* Add handle for easier identification but anonymize it */
                            if (post.author?.handle) {
                                processed.handle = `user${userCounter}`;
                            }
                            
                            posts.push(processed);
                        }
                    }
                    
                    return {
                        query: query,
                        sort: sort,
                        count: posts.length,
                        posts: posts
                    };
                } catch (err) {
                    debugLog.add('search_error', err);
                    console.error('Search processing error:', err);
                    throw new Error(`Failed to fetch search results: ${err.message}`);
                }
            }

            /* Copy Button Handler */
            copyButton.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(output.textContent);
                    copyFeedback.style.display = 'block';
                    setTimeout(() => {
                        copyFeedback.style.display = 'none';
                    }, 2000);
                } catch (err) {
                    error.textContent = 'Failed to copy to clipboard';
                    error.style.display = 'block';
                    debugLog.add('copy_error', err);
                }
            });

            /* Post Form Submit Handler */
            postForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                error.style.display = 'none';
                output.textContent = '';
                document.querySelector('.output-actions').style.display = 'none';
                
                /* Disable both process buttons and show loading text. */
                const processButtons = document.querySelectorAll('#process-replies, #process-quotes');
                processButtons.forEach(btn => btn.disabled = true);
                const originalTexts = {};
                processButtons.forEach(btn => { 
                    originalTexts[btn.id] = btn.textContent; 
                    btn.innerHTML = '<span class="loading"></span>Processing...'; 
                });
                
                const currentInput = urlInput.value.trim();
                updateQueryParam('url', currentInput);
                
                let useQuotePosts;
                /* Determine mode based on which button was clicked (or URL param for auto-process). */
                if (e.submitter) {
                    useQuotePosts = e.submitter.id === 'process-quotes';
                    updateQueryParam('quotes', useQuotePosts ? 'true' : 'false');
                } else {
                    useQuotePosts = getQueryParam('quotes') === 'true';
                }
                
                try {
                    const postInfo = extractPostInfo(currentInput);
                    let processedData;
                    if (useQuotePosts) {
                        processedData = await processQuotes(postInfo);
                    } else {
                        processedData = await processThread(postInfo);
                    }
                    output.textContent = JSON.stringify(processedData, null, 2);
                    document.querySelector('.output-actions').style.display = 'flex';
                } catch (err) {
                    error.textContent = err.message;
                    error.style.display = 'block';
                    debugLog.add('process_error', err);
                } finally {
                    processButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.innerHTML = originalTexts[btn.id];
                    });
                }
            });

            /* Search Form Submit Handler */
            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                error.style.display = 'none';
                output.textContent = '';
                document.querySelector('.output-actions').style.display = 'none';
                
                /* Disable process button and show loading text. */
                const processButton = document.getElementById('process-search');
                processButton.disabled = true;
                const originalText = processButton.textContent;
                processButton.innerHTML = '<span class="loading"></span>Processing...';
                
                const query = searchInput.value.trim();
                const limit = parseInt(limitInput.value) || 25;
                const sort = document.querySelector('input[name="sort"]:checked').value;
                
                /* Update URL parameters */
                updateQueryParam('q', query);
                updateQueryParam('limit', limit.toString());
                updateQueryParam('sort', sort);
                
                try {
                    const processedData = await processSearch(query, limit, sort);
                    output.textContent = JSON.stringify(processedData, null, 2);
                    document.querySelector('.output-actions').style.display = 'flex';
                } catch (err) {
                    error.textContent = err.message;
                    error.style.display = 'block';
                    debugLog.add('process_error', err);
                } finally {
                    processButton.disabled = false;
                    processButton.innerHTML = originalText;
                }
            });

            /* Handle browser back and forward navigation. */
            window.addEventListener('popstate', () => {
                const tab = getQueryParam('tab') || 'post-tab';
                const tabButton = document.querySelector(`.tab-button[data-tab="${tab}"]`);
                if (tabButton) {
                    tabButton.click();
                }
                
                if (tab === 'post-tab') {
                    const qspUrl = getQueryParam('url');
                    if (qspUrl !== urlInput.value) {
                        urlInput.value = qspUrl || '';
                    }
                } else if (tab === 'search-tab') {
                    const qspQuery = getQueryParam('q');
                    if (qspQuery !== searchInput.value) {
                        searchInput.value = qspQuery || '';
                    }
                    
                    const qspLimit = getQueryParam('limit');
                    if (qspLimit) {
                        limitInput.value = qspLimit;
                    }
                    
                    const qspSort = getQueryParam('sort');
                    if (qspSort) {
                        const sortRadio = document.querySelector(`input[name="sort"][value="${qspSort}"]`);
                        if (sortRadio) {
                            sortRadio.checked = true;
                        }
                    }
                }
                
                autoProcessIfReady();
            });
        } catch (err) {
            document.getElementById('module-error').style.display = 'block';
            console.error('Failed to load application:', err);
        }
    </script>
</body>

</html>
