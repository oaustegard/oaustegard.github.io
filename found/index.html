<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Found Item</title>
  <meta name="robots" content="noindex, nofollow">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0d9488;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gradient-to-b from-teal-50 to-white min-h-screen">
  <div id="app" class="max-w-md mx-auto p-6">
    <!-- Loading state -->
    <div id="loading" class="text-center py-12">
      <div class="loader mx-auto mb-4"></div>
      <p class="text-gray-600">Loading...</p>
    </div>

    <!-- Error state -->
    <div id="error" class="hidden text-center py-12">
      <div class="text-5xl mb-4">üîó</div>
      <h1 class="text-xl font-bold text-gray-800 mb-2">Invalid or Expired Link</h1>
      <p class="text-gray-600">This QR code may be damaged or the link has expired.</p>
    </div>

    <!-- Success state (shown after submit) -->
    <div id="success" class="hidden text-center py-8">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="text-6xl mb-4">‚úÖ</div>
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Message Sent!</h2>
        <p class="text-gray-600 text-lg">The owner has been notified. Thank you for helping reunite them with their item!</p>
      </div>
    </div>

    <!-- Main content -->
    <div id="content" class="hidden">
      <div class="text-center mb-6">
        <div class="text-5xl mb-3">üì¶</div>
        <h1 class="text-2xl font-bold text-gray-800">You Found Something!</h1>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-5 mb-6">
        <div class="text-sm text-teal-600 font-medium mb-1">Item</div>
        <div id="item-name" class="text-xl font-semibold text-gray-800 mb-4"></div>

        <div class="text-sm text-teal-600 font-medium mb-1">Message from Owner</div>
        <div id="owner-message" class="text-gray-700"></div>
      </div>

      <div id="form-section" class="bg-white rounded-xl shadow-lg p-5">
        <h2 class="font-semibold text-gray-800 mb-4">Let the owner know you found it</h2>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Your Message</label>
            <textarea
              id="finder-message"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500"
              rows="3"
              placeholder="Hi! I found your item at..."
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Your Contact Info (optional)</label>
            <input
              type="text"
              id="finder-contact"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500"
              placeholder="Email or phone"
            />
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="share-location" class="rounded text-teal-600">
            <label for="share-location" class="text-sm text-gray-700">Share my current location</label>
          </div>

          <div id="location-status" class="text-sm hidden">
            <div id="location-text" class="text-gray-600"></div>
            <div id="location-note" class="text-gray-400 text-xs mt-1 hidden">
              Note: Location accuracy depends on your device. Desktop browsers may only provide approximate location.
            </div>
          </div>

          <button
            id="submit-btn"
            class="w-full py-3 bg-teal-600 text-white font-medium rounded-lg hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            Send Message
          </button>

          <div id="submit-error" class="text-red-600 text-sm hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    const CONFIG = {
      // Encrypted GitHub PAT (AES-GCM encrypted, hex encoded)
      // Generated by the generator during setup
      ENCRYPTED_PAT: 'REPLACE_WITH_ENCRYPTED_PAT_FROM_GENERATOR',

      // GitHub repository for filing issues
      REPO: 'oaustegard/found-item',

      // Default owner message if none provided
      DEFAULT_MESSAGE: 'If found, please use the form below to let me know where to pick it up!'
    };
    // ============================================================================

    // Crypto utilities
    const cryptoUtils = {
      // Derive AES key from password/key string
      async deriveKey(keyString) {
        const enc = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
          'raw',
          enc.encode(keyString),
          'PBKDF2',
          false,
          ['deriveKey']
        );
        return crypto.subtle.deriveKey(
          {
            name: 'PBKDF2',
            salt: enc.encode('found-item-salt-v1'), // Static salt is fine here
            iterations: 100000,
            hash: 'SHA-256'
          },
          keyMaterial,
          { name: 'AES-GCM', length: 256 },
          false,
          ['decrypt']
        );
      },

      // Decrypt hex-encoded encrypted data
      async decrypt(encryptedHex, keyString) {
        const key = await this.deriveKey(keyString);

        // Convert hex to bytes
        const encryptedBytes = new Uint8Array(
          encryptedHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16))
        );

        // Extract IV (first 12 bytes) and ciphertext
        const iv = encryptedBytes.slice(0, 12);
        const ciphertext = encryptedBytes.slice(12);

        const decrypted = await crypto.subtle.decrypt(
          { name: 'AES-GCM', iv },
          key,
          ciphertext
        );

        return new TextDecoder().decode(decrypted);
      }
    };

    // DOM helpers
    const $ = id => document.getElementById(id);
    const show = id => $(id).classList.remove('hidden');
    const hide = id => $(id).classList.add('hidden');

    // State
    let itemName = '';
    let ownerMessage = '';
    let githubPAT = '';
    let userLocation = null;

    // Initialize
    async function init() {
      try {
        // Check configuration
        if (CONFIG.ENCRYPTED_PAT === 'REPLACE_WITH_ENCRYPTED_PAT_FROM_GENERATOR') {
          throw new Error('Found page not configured. Please run generator setup first.');
        }

        // Get URL parameters
        const params = new URLSearchParams(window.location.search);
        const key = params.get('k');
        itemName = params.get('n');
        ownerMessage = params.get('m') || '';

        if (!key || !itemName) {
          throw new Error('Missing required parameters');
        }

        // Decrypt the PAT using the key from URL
        githubPAT = await cryptoUtils.decrypt(CONFIG.ENCRYPTED_PAT, key);

        // Populate UI
        $('item-name').textContent = itemName;
        $('owner-message').textContent = ownerMessage || CONFIG.DEFAULT_MESSAGE;

        hide('loading');
        show('content');

        // Setup event listeners
        setupListeners();

      } catch (e) {
        console.error('Init error:', e);
        hide('loading');
        show('error');
      }
    }

    function getLocationErrorMessage(err) {
      switch(err.code) {
        case 1: return 'Location permission denied. Please enable location access in your browser settings.';
        case 2: return 'Location unavailable. Please try again or enter your location in the message.';
        case 3: return 'Location request timed out. Please try again.';
        default: return 'Could not get location: ' + err.message;
      }
    }

    function setupListeners() {
      // Location checkbox
      $('share-location').addEventListener('change', async (e) => {
        if (e.target.checked) {
          $('location-text').textContent = 'üìç Requesting location...';
          show('location-status');
          hide('location-note');

          try {
            const pos = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
              });
            });

            userLocation = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              accuracy: pos.coords.accuracy
            };

            const accuracyText = userLocation.accuracy > 1000
              ? `¬±${(userLocation.accuracy / 1000).toFixed(1)}km`
              : `¬±${Math.round(userLocation.accuracy)}m`;

            $('location-text').textContent = `üìç Location acquired (${accuracyText})`;
            $('location-text').className = 'text-green-600';

            if (userLocation.accuracy > 500) {
              show('location-note');
            }

          } catch (err) {
            $('location-text').textContent = '‚ùå ' + getLocationErrorMessage(err);
            $('location-text').className = 'text-red-600';
            e.target.checked = false;
            userLocation = null;
          }
        } else {
          hide('location-status');
          userLocation = null;
        }
      });

      $('submit-btn').addEventListener('click', submit);
    }

    async function submit() {
      const btn = $('submit-btn');
      const errorEl = $('submit-error');

      hide('submit-error');
      btn.disabled = true;
      btn.innerHTML = '<span class="loader"></span> Sending...';

      try {
        const message = $('finder-message').value.trim();
        const contact = $('finder-contact').value.trim();

        if (!message) {
          throw new Error('Please enter a message');
        }

        // Build issue body
        let body = `**Item:** ${itemName}\n\n`;
        body += `**Finder's Message:**\n${message}\n\n`;

        if (contact) {
          body += `**Contact Info:** ${contact}\n\n`;
        }

        if (userLocation) {
          const accuracyText = userLocation.accuracy > 1000
            ? `¬±${(userLocation.accuracy / 1000).toFixed(1)}km`
            : `¬±${Math.round(userLocation.accuracy)}m`;
          body += `**Location:** [${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}](https://www.google.com/maps?q=${userLocation.lat},${userLocation.lng}) (${accuracyText})\n`;
        }

        body += `\n---\n_Submitted via Found Item page_`;

        // Post to GitHub Issues API
        const response = await fetch(`https://api.github.com/repos/${CONFIG.REPO}/issues`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${githubPAT}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github+json'
          },
          body: JSON.stringify({
            title: `üîî Found: ${itemName}`,
            body: body,
            labels: ['found-item']
          })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.message || 'Failed to send message');
        }

        hide('content');
        show('success');
        window.scrollTo({ top: 0, behavior: 'smooth' });

      } catch (e) {
        errorEl.textContent = e.message;
        show('submit-error');
        btn.disabled = false;
        btn.innerHTML = 'Send Message';
      }
    }

    init();
  </script>
</body>
</html>
