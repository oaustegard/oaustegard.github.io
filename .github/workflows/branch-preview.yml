# Deploy source files directly to a single Cloudflare Pages preview branch.
# Skips Jekyll build entirely - the site is pure HTML/JS/CSS with no real templating.
# Only 404.html has Jekyll front matter (stripped inline); everything else deploys as-is.
name: Branch Preview

on:
  push:
    branches-ignore:
      - main

  # Allow manual trigger
  workflow_dispatch:

# Single group: we deploy to one fixed 'preview' branch, so concurrent runs would overwrite each other
concurrency:
  group: cloudflare-preview
  cancel-in-progress: true

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare deploy directory
        run: |
          mkdir -p /tmp/cloudflare-deploy
          rsync -a \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.claude/' \
            --exclude='Gemfile' \
            --exclude='Gemfile.lock' \
            --exclude='_config.yml' \
            --exclude='_MAP.md' \
            --exclude='_site/' \
            --exclude='package.json' \
            --exclude='package-lock.json' \
            --exclude='playwright.config.js' \
            --exclude='tests/' \
            --exclude='AGENTS.md' \
            --exclude='CLAUDE.md' \
            --exclude='README.md' \
            --exclude='LICENSE' \
            ./ /tmp/cloudflare-deploy/
          # Strip Jekyll front matter from 404.html (only HTML file that has it)
          python3 -c "
          import re
          with open('/tmp/cloudflare-deploy/404.html', 'r') as f:
              content = f.read()
          content = re.sub(r'^---\n.*?\n---\n', '', content, flags=re.DOTALL)
          with open('/tmp/cloudflare-deploy/404.html', 'w') as f:
              f.write(content)
          "

      - name: Deploy to Cloudflare Pages
        id: deploy
        run: |
          set +e
          OUTPUT=$(npx wrangler pages deploy /tmp/cloudflare-deploy \
            --project-name austegard \
            --branch preview \
            2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Wrangler deploy failed (exit $EXIT_CODE)"
            exit $EXIT_CODE
          fi
          URL=$(echo "$OUTPUT" | grep -oP 'https://[^\s]+\.pages\.dev' | tail -1)
          echo "url=$URL" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Summary
        run: |
          BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "## Preview Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source branch:** \`${BRANCH}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Preview URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
