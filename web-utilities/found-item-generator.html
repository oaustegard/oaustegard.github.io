<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Found Item QR Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.js"></script>
  <script type="importmap">
  {
    "imports": {
      "preact": "https://esm.sh/*preact@10.23.1",
      "preact/": "https://esm.sh/*preact@10.23.1/",
      "@preact/signals": "https://esm.sh/*@preact/signals@1.3.0",
      "@preact/signals-core": "https://esm.sh/*@preact/signals-core@1.8.0",
      "htm": "https://esm.sh/*htm@3.1.1",
      "htm/preact": "https://esm.sh/*htm@3.1.1/preact"
    }
  }
  </script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app"></div>
  
  <script type="module">
    import { render } from 'preact';
    import { useSignal } from '@preact/signals';
    import { useEffect, useRef } from 'preact/hooks';
    import { html } from 'htm/preact';

    // Crypto utilities using Web Crypto API
    const cryptoUtils = {
      async deriveKey(secret, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey(
          'raw',
          enc.encode(secret),
          'PBKDF2',
          false,
          ['deriveKey']
        );
        return window.crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt: enc.encode(salt), iterations: 100000, hash: 'SHA-256' },
          keyMaterial,
          { name: 'AES-GCM', length: 256 },
          false,
          ['encrypt', 'decrypt']
        );
      },

      async encrypt(plaintext, secret, salt) {
        const key = await this.deriveKey(secret, salt);
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const enc = new TextEncoder();
        const ciphertext = await window.crypto.subtle.encrypt(
          { name: 'AES-GCM', iv },
          key,
          enc.encode(plaintext)
        );
        // Prepend IV to ciphertext
        const combined = new Uint8Array(iv.length + ciphertext.byteLength);
        combined.set(iv);
        combined.set(new Uint8Array(ciphertext), iv.length);
        // URL-safe base64 (no padding, - instead of +, _ instead of /)
        return btoa(String.fromCharCode(...combined))
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=/g, '');
      },

      generateSecret(length = 12) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const array = new Uint8Array(length);
        window.crypto.getRandomValues(array);
        return Array.from(array, b => chars[b % chars.length]).join('');
      }
    };

    // QR Code component
    function QRCodeCanvas({ text, size = 256 }) {
      const canvasRef = useRef(null);
      
      useEffect(() => {
        if (!text || !canvasRef.current || !window.QRCode) return;
        
        window.QRCode.toCanvas(canvasRef.current, text, {
          width: size,
          margin: 2,
          color: { dark: '#1a5f4a', light: '#ffffff' }
        }, (err) => {
          if (err) console.error('QR generation error:', err);
        });
      }, [text, size]);
      
      return html`<canvas ref=${canvasRef} class="mx-auto" />`;
    }

    function App() {
      // Form state
      const pat = useSignal(localStorage.getItem('github-pat') || '');
      const repo = useSignal(localStorage.getItem('github-repo') || 'oaustegard/found-item');
      const baseUrl = useSignal(localStorage.getItem('base-url') || 'https://austegard.com/web-utilities/found');
      const itemName = useSignal('');
      const secret = useSignal(cryptoUtils.generateSecret());
      
      // Generated output
      const generatedUrl = useSignal('');
      const isGenerating = useSignal(false);
      const error = useSignal('');

      // Save settings to localStorage
      const saveSettings = () => {
        localStorage.setItem('github-pat', pat.value);
        localStorage.setItem('github-repo', repo.value);
        localStorage.setItem('base-url', baseUrl.value);
      };

      // Generate encrypted URL
      const generate = async () => {
        if (!pat.value || !itemName.value) {
          error.value = 'PAT and Item Name are required';
          return;
        }
        
        error.value = '';
        isGenerating.value = true;
        
        try {
          saveSettings();
          
          const payload = JSON.stringify({
            p: pat.value,           // PAT
            r: repo.value,          // repo
            n: itemName.value,      // item name
            // message not included - uses default in found page
          });
          
          // Use first 8 chars of secret as salt
          const salt = secret.value.substring(0, 8);
          const encrypted = await cryptoUtils.encrypt(payload, secret.value, salt);
          
          const url = `${baseUrl.value}?s=${encodeURIComponent(secret.value)}&d=${encodeURIComponent(encrypted)}`;
          generatedUrl.value = url;
          
        } catch (e) {
          error.value = `Encryption failed: ${e.message}`;
        } finally {
          isGenerating.value = false;
        }
      };

      const regenerateSecret = () => {
        secret.value = cryptoUtils.generateSecret();
        generatedUrl.value = '';
      };

      const copyUrl = async () => {
        await navigator.clipboard.writeText(generatedUrl.value);
      };

      const inputClass = "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500";
      const labelClass = "block text-sm font-medium text-gray-700 mb-1";
      const btnPrimary = "px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 disabled:opacity-50";
      const btnSecondary = "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300";

      return html`
        <div class="max-w-2xl mx-auto p-6">
          <h1 class="text-2xl font-bold text-gray-800 mb-2">Found Item QR Generator</h1>
          <p class="text-gray-600 mb-6">Generate encrypted QR codes for item recovery. All encryption happens locally.</p>
          
          <!-- Settings Section -->
          <div class="bg-white rounded-lg shadow p-4 mb-6">
            <h2 class="font-semibold text-gray-700 mb-3">Settings (saved locally)</h2>
            
            <div class="space-y-4">
              <div>
                <label class=${labelClass}>GitHub PAT (issues:write scope)</label>
                <input 
                  type="password" 
                  class=${inputClass}
                  value=${pat.value}
                  onInput=${e => pat.value = e.target.value}
                  placeholder="ghp_xxxxxxxxxxxx"
                />
              </div>
              
              <div>
                <label class=${labelClass}>GitHub Repo</label>
                <input 
                  type="text" 
                  class=${inputClass}
                  value=${repo.value}
                  onInput=${e => repo.value = e.target.value}
                  placeholder="username/repo"
                />
              </div>
              
              <div>
                <label class=${labelClass}>Found Page Base URL</label>
                <input 
                  type="text" 
                  class=${inputClass}
                  value=${baseUrl.value}
                  onInput=${e => baseUrl.value = e.target.value}
                  placeholder="https://austegard.com/web-utilities/found"
                />
              </div>
            </div>
          </div>
          
          <!-- Item Section -->
          <div class="bg-white rounded-lg shadow p-4 mb-6">
            <h2 class="font-semibold text-gray-700 mb-3">New Item</h2>
            
            <div class="space-y-4">
              <div>
                <label class=${labelClass}>Item Name / Description</label>
                <input 
                  type="text" 
                  class=${inputClass}
                  value=${itemName.value}
                  onInput=${e => itemName.value = e.target.value}
                  placeholder="Blue Water Bottle"
                />
              </div>
              
              <div>
                <label class=${labelClass}>Secret Key (unique per item)</label>
                <div class="flex gap-2">
                  <input 
                    type="text" 
                    class="${inputClass} font-mono text-sm"
                    value=${secret.value}
                    readonly
                  />
                  <button 
                    class=${btnSecondary}
                    onClick=${regenerateSecret}
                    title="Regenerate secret"
                  >â†»</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Generate Button -->
          <div class="flex gap-3 mb-6">
            <button 
              class=${btnPrimary}
              onClick=${generate}
              disabled=${isGenerating.value}
            >
              ${isGenerating.value ? 'Generating...' : 'Generate QR Code'}
            </button>
          </div>
          
          ${error.value && html`
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4">
              ${error.value}
            </div>
          `}
          
          <!-- Output Section -->
          ${generatedUrl.value && html`
            <div class="bg-white rounded-lg shadow p-4">
              <h2 class="font-semibold text-gray-700 mb-3">Generated QR Code</h2>
              
              <div class="mb-4">
                <${QRCodeCanvas} text=${generatedUrl.value} size=${256} />
              </div>
              
              <div class="mt-4">
                <label class=${labelClass}>URL (${generatedUrl.value.length} chars)</label>
                <div class="flex gap-2">
                  <input 
                    type="text" 
                    class="${inputClass} font-mono text-xs"
                    value=${generatedUrl.value}
                    readonly
                  />
                  <button class=${btnSecondary} onClick=${copyUrl}>Copy</button>
                </div>
              </div>
              
              <p class="text-sm text-gray-500 mt-3">
                Right-click the QR code to save as image, or print this page.
              </p>
            </div>
          `}
        </div>
      `;
    }

    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>
</html>
