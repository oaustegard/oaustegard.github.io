<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookmarklet Installer</title>
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-tertiary: #f0f9ff;
      --bg-card: #ffffff;
      --text-primary: #333;
      --text-secondary: #666;
      --text-tertiary: #999;
      --border-color: #ddd;
      --accent-primary: #0066cc;
      --accent-hover: #0052a3;
      --error-color: #dc2626;
      --success-color: #16a34a;
      --warning-color: #ea580c;
      --badge-blue: #3b82f6;
      --badge-green: #10b981;
      --badge-purple: #8b5cf6;
      --badge-orange: #f59e0b;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2a2a2a;
        --bg-tertiary: #1e293b;
        --bg-card: #262626;
        --text-primary: #e5e5e5;
        --text-secondary: #a3a3a3;
        --text-tertiary: #737373;
        --border-color: #404040;
        --accent-primary: #3b82f6;
        --accent-hover: #2563eb;
        --shadow: rgba(0, 0, 0, 0.3);
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      line-height: 1.6;
      color: var(--text-primary);
      background: var(--bg-primary);
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      margin-top: 0;
      color: var(--text-primary);
    }

    h2 {
      color: var(--text-primary);
      font-size: 1.25rem;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .filters-section {
      background: var(--bg-secondary);
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      border: 1px solid var(--border-color);
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .filter-row:last-child {
      margin-bottom: 0;
    }

    .input-group {
      margin: 0;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
      color: var(--text-primary);
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-family: inherit;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }

    textarea {
      min-height: 200px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.75rem;
      resize: vertical;
    }

    button {
      background-color: var(--accent-primary);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: var(--accent-hover);
    }

    button.secondary {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    button.secondary:hover {
      background-color: var(--border-color);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      gap: 0.25rem;
    }

    .badge-domain {
      background: var(--badge-blue);
      color: white;
    }

    .badge-readme {
      background: var(--badge-green);
      color: white;
    }

    .badge-metadata {
      background: var(--badge-purple);
      color: white;
    }

    .badge-warning {
      background: var(--badge-orange);
      color: white;
    }

    .metadata-info {
      background: var(--bg-tertiary);
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1rem 0;
      border: 1px solid var(--border-color);
    }

    .metadata-info h3 {
      margin: 0 0 1rem 0;
      color: var(--text-primary);
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .metadata-row {
      margin: 0.75rem 0;
    }

    .metadata-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }

    .metadata-value {
      color: var(--text-primary);
      font-size: 0.9375rem;
    }

    .domain-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .domain-tag {
      background: var(--badge-blue);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 16px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .domain-tag:hover {
      transform: scale(1.05);
    }

    .bookmarklet-link {
      margin: 1rem 0;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .bookmarklet-link a {
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 1.125rem;
    }

    .bookmarklet-link a:hover {
      text-decoration: underline;
    }

    .source-links {
      display: flex;
      gap: 1rem;
      margin: 0.5rem 0;
      flex-wrap: wrap;
    }

    .source-links a {
      color: var(--accent-primary);
      text-decoration: none;
      font-size: 0.875rem;
    }

    .source-links a:hover {
      text-decoration: underline;
    }

    .error {
      color: var(--error-color);
      font-weight: 500;
      padding: 0.75rem;
      background: rgba(220, 38, 38, 0.1);
      border-radius: 4px;
      margin: 0.5rem 0;
    }

    .warning {
      color: var(--warning-color);
      font-weight: 500;
      padding: 0.75rem;
      background: rgba(234, 88, 12, 0.1);
      border-radius: 4px;
      margin: 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .success {
      color: var(--success-color);
      font-weight: 500;
      padding: 0.75rem;
      background: rgba(22, 163, 74, 0.1);
      border-radius: 4px;
      margin: 0.5rem 0;
    }

    .info {
      background: var(--bg-tertiary);
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      border: 1px solid var(--border-color);
    }

    .info strong {
      color: var(--text-primary);
    }

    .metadata-editor {
      background: var(--bg-secondary);
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1rem 0;
      border: 1px solid var(--border-color);
    }

    .metadata-editor h3 {
      margin-top: 0;
      color: var(--text-primary);
    }

    .checkbox-group {
      margin: 1rem 0;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-weight: normal;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }

    .export-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }

    .hidden {
      display: none !important;
    }

    .footer {
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 0.875rem;
      text-align: center;
    }

    .footer a {
      color: var(--accent-primary);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    .no-results {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
      font-size: 1.125rem;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .filter-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.15.1/beautify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/terser/dist/bundle.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>üìö Bookmarklet Installer</h1>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="filter-row">
        <div class="input-group">
          <label for="searchInput">üîç Search Bookmarklets</label>
          <input type="text" id="searchInput" placeholder="Search by name, description, or domain...">
        </div>
        <div class="input-group">
          <label for="domainFilter">üåê Filter by Domain</label>
          <select id="domainFilter">
            <option value="">All domains</option>
          </select>
        </div>
        <div class="input-group">
          <label for="sortSelect">‚¨áÔ∏è Sort by</label>
          <select id="sortSelect">
            <option value="name">Name (A-Z)</option>
            <option value="name-desc">Name (Z-A)</option>
            <option value="has-metadata">Has Metadata</option>
            <option value="has-readme">Has README</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Install View -->
    <div id="installView">
      <div class="input-group">
        <label for="bookmarkletSelect">Select a Bookmarklet from
          <a href="https://github.com/oaustegard/bookmarklets" target="_blank">github.com/oaustegard/bookmarklets</a>
        </label>
        <select id="bookmarkletSelect">
          <option value="">-- Select a bookmarklet --</option>
        </select>
      </div>

      <!-- Metadata Info Display -->
      <div id="metadataInfo" class="metadata-info hidden"></div>

      <div class="source-links" id="sourceLinks"></div>

      <div class="input-group">
        <label for="codeTextarea">OR enter your own code below<br>JavaScript Code:</label>
        <textarea id="codeTextarea" placeholder="Enter your JavaScript code"></textarea>
      </div>

      <button id="beautifyButton">Format Code</button>

      <!-- Metadata Editor for Custom Code -->
      <div id="metadataEditor" class="metadata-editor hidden">
        <h3>‚ú® Add Metadata (Optional)</h3>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="addMetadataCheckbox">
            Include metadata in my bookmarklet
          </label>
        </div>
        <div id="metadataFields" class="hidden">
          <div class="input-group">
            <label for="metaTitleInput">Title</label>
            <input type="text" id="metaTitleInput" placeholder="My Awesome Bookmarklet">
          </div>
          <div class="input-group">
            <label for="metaDescInput">Description</label>
            <input type="text" id="metaDescInput" placeholder="What does this bookmarklet do?">
          </div>
          <div class="input-group">
            <label for="metaDomainsInput">Domains (comma-separated)</label>
            <input type="text" id="metaDomainsInput" placeholder="example.com, sub.example.org">
          </div>
        </div>
      </div>

      <div class="input-group">
        <label for="titleInput">Bookmarklet Name:</label>
        <input type="text" id="titleInput" placeholder="Enter bookmarklet name">
      </div>

      <!-- Validation Messages -->
      <div id="validationWarning" class="warning hidden"></div>
      <div id="error" class="error hidden"></div>
      <div id="success" class="success hidden"></div>

      <!-- Bookmarklet Link -->
      <div id="bookmarkletLink" class="bookmarklet-link hidden"></div>

      <!-- Export Buttons -->
      <div id="exportButtons" class="export-buttons hidden">
        <button id="downloadBtn">üíæ Download as .js</button>
        <button id="copyCodeBtn" class="secondary">üìã Copy Code</button>
        <button id="shareBtn" class="secondary">üîó Copy Share Link</button>
      </div>

      <div class="info">
        <strong>üìå Installation:</strong>
        <p>
          a) Drag the bookmarklet link above to your bookmarks bar<br>
          b) Click it on any webpage to run the bookmarklet
        </p>
      </div>
    </div>

    <div class="footer">
      Source code available on
      <a href="https://github.com/oaustegard/oaustegard.github.io/blob/main/web-utilities/bookmarklet-installer.html" target="_blank">GitHub</a>
    </div>
  </div>

  <script>
    (async function() {
      /* ============================================
         CONFIGURATION & STATE
         ============================================ */
      const REPO_OWNER = 'oaustegard';
      const REPO_NAME = 'bookmarklets';

      const state = {
        bookmarklets: [],
        filteredBookmarklets: [],
        selectedBookmarklet: null,
        currentMetadata: null
      };

      /* ============================================
         DOM ELEMENTS
         ============================================ */
      const elements = {
        // Filters & Search
        searchInput: document.getElementById('searchInput'),
        domainFilter: document.getElementById('domainFilter'),
        sortSelect: document.getElementById('sortSelect'),

        // Install view
        select: document.getElementById('bookmarkletSelect'),
        title: document.getElementById('titleInput'),
        code: document.getElementById('codeTextarea'),
        beautify: document.getElementById('beautifyButton'),
        link: document.getElementById('bookmarkletLink'),
        error: document.getElementById('error'),
        success: document.getElementById('success'),
        validationWarning: document.getElementById('validationWarning'),
        sourceLinks: document.getElementById('sourceLinks'),
        metadataInfo: document.getElementById('metadataInfo'),

        // Metadata editor
        metadataEditor: document.getElementById('metadataEditor'),
        addMetadataCheckbox: document.getElementById('addMetadataCheckbox'),
        metadataFields: document.getElementById('metadataFields'),
        metaTitleInput: document.getElementById('metaTitleInput'),
        metaDescInput: document.getElementById('metaDescInput'),
        metaDomainsInput: document.getElementById('metaDomainsInput'),

        // Export
        exportButtons: document.getElementById('exportButtons'),
        downloadBtn: document.getElementById('downloadBtn'),
        copyCodeBtn: document.getElementById('copyCodeBtn'),
        shareBtn: document.getElementById('shareBtn')
      };

      /* ============================================
         METADATA PARSING
         ============================================ */
      function extractMetadata(code) {
        const metadata = {
          title: null,
          description: null,
          domains: null,
          domainList: []
        };

        const metadataRegex = /\/\*\s*@(\w+):\s*([^*]+)\*\//g;
        let match;

        while ((match = metadataRegex.exec(code)) !== null) {
          const key = match[1].toLowerCase();
          const value = match[2].trim();

          if (key === 'title') metadata.title = value;
          else if (key === 'description') metadata.description = value;
          else if (key === 'domains') {
            metadata.domains = value;
            metadata.domainList = value.split(',').map(d => d.trim()).filter(Boolean);
          }
        }

        return metadata;
      }

      function hasMetadata(metadata) {
        return metadata.title || metadata.description || metadata.domains;
      }

      function validateMetadata(code) {
        const warnings = [];
        const metadata = extractMetadata(code);

        if (!hasMetadata(metadata)) {
          warnings.push('‚ö†Ô∏è No metadata found. Consider adding @title, @description, and @domains.');
        }

        return warnings;
      }

      /* ============================================
         METADATA INJECTION
         ============================================ */
      function injectMetadata(code, metadata) {
        // Remove existing metadata
        code = code.replace(/\/\*\s*@\w+:[^*]+\*\/\s*/g, '');

        // Build metadata comments
        let metadataComments = '';
        if (metadata.title) {
          metadataComments += `/* @title: ${metadata.title} */\n`;
        }
        if (metadata.description) {
          metadataComments += `/* @description: ${metadata.description} */\n`;
        }
        if (metadata.domains) {
          metadataComments += `/* @domains: ${metadata.domains} */\n`;
        }

        // Inject after javascript: prefix if present
        if (code.trim().startsWith('javascript:')) {
          return code.replace(/^javascript:\s*/, `javascript:\n${metadataComments}`);
        } else {
          return `javascript:\n${metadataComments}${code}`;
        }
      }

      /* ============================================
         BOOKMARKLET DATA FETCHING
         ============================================ */
      async function fetchBookmarklets() {
        try {
          const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();

          // Find README files
          const readmeFiles = new Set(
            data
              .filter(file => file.name.endsWith('_README.md'))
              .map(file => file.name.replace('_README.md', '.js'))
          );

          // Process bookmarklet files
          const jsFiles = data.filter(file =>
            !file.name.startsWith('_') &&
            file.name.endsWith('.js')
          );

          // Fetch metadata for each file
          const bookmarklets = await Promise.all(
            jsFiles.map(async (file) => {
              try {
                const codeResponse = await fetch(
                  `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${file.name}?_=${Date.now()}`
                );
                const code = await codeResponse.text();
                const metadata = extractMetadata(code);

                return {
                  filename: file.name,
                  name: file.name.replace('.js', ''),
                  code: code,
                  metadata: metadata,
                  hasMetadata: hasMetadata(metadata),
                  hasReadme: readmeFiles.has(file.name)
                };
              } catch (error) {
                console.error(`Error fetching ${file.name}:`, error);
                return {
                  filename: file.name,
                  name: file.name.replace('.js', ''),
                  code: '',
                  metadata: { title: null, description: null, domains: null, domainList: [] },
                  hasMetadata: false,
                  hasReadme: readmeFiles.has(file.name)
                };
              }
            })
          );

          state.bookmarklets = bookmarklets;
          state.filteredBookmarklets = bookmarklets;

          populateDropdown();
          populateDomainFilter();

          // Handle URL parameter
          const urlBookmarklet = getBookmarkletFromURL();
          if (urlBookmarklet) {
            const matching = bookmarklets.find(b => b.filename === urlBookmarklet);
            if (matching) {
              selectBookmarklet(matching);
            }
          }
        } catch (error) {
          showError(`Error loading bookmarklet list: ${error.message}`);
        }
      }

      /* ============================================
         UI RENDERING
         ============================================ */
      function renderMetadataInfo(bookmarklet) {
        if (!bookmarklet || !bookmarklet.hasMetadata) {
          elements.metadataInfo.classList.add('hidden');
          return;
        }

        const metadata = bookmarklet.metadata;
        let html = '<h3>üìã Bookmarklet Information</h3>';

        // Show filename
        html += `
          <div class="metadata-row">
            <div class="metadata-label">File</div>
            <div class="metadata-value"><code>${bookmarklet.filename}</code></div>
          </div>
        `;

        if (metadata.title) {
          html += `
            <div class="metadata-row">
              <div class="metadata-label">Title</div>
              <div class="metadata-value">${metadata.title}</div>
            </div>
          `;
        }

        if (metadata.description) {
          html += `
            <div class="metadata-row">
              <div class="metadata-label">Description</div>
              <div class="metadata-value">${metadata.description}</div>
            </div>
          `;
        }

        if (metadata.domainList.length > 0) {
          html += `
            <div class="metadata-row">
              <div class="metadata-label">Works on these domains</div>
              <div class="domain-tags">
                ${metadata.domainList.map(domain =>
                  `<span class="domain-tag" data-domain="${domain}">üåê ${domain}</span>`
                ).join('')}
              </div>
            </div>
          `;
        }

        elements.metadataInfo.innerHTML = html;
        elements.metadataInfo.classList.remove('hidden');

        // Add click handlers for domain tags
        elements.metadataInfo.querySelectorAll('.domain-tag').forEach(tag => {
          tag.addEventListener('click', () => {
            const domain = tag.dataset.domain;
            elements.domainFilter.value = domain;
            applyFilters();
          });
        });
      }

      function populateDropdown() {
        elements.select.innerHTML = '<option value="">-- Select a bookmarklet --</option>';

        state.filteredBookmarklets.forEach(bookmarklet => {
          const option = document.createElement('option');
          option.value = bookmarklet.filename;

          const indicators = [];
          if (bookmarklet.hasMetadata) indicators.push('‚ú®');
          if (bookmarklet.hasReadme) indicators.push('üìÑ');

          const displayName = bookmarklet.metadata.title || formatNameFromFilename(bookmarklet.name);
          option.textContent = `${displayName} - ${bookmarklet.filename} ${indicators.join(' ')}`;

          elements.select.appendChild(option);
        });
      }

      function populateDomainFilter() {
        const domains = new Set();
        state.bookmarklets.forEach(b => {
          b.metadata.domainList.forEach(d => domains.add(d));
        });

        const sortedDomains = Array.from(domains).sort();

        elements.domainFilter.innerHTML = '<option value="">All domains</option>';
        sortedDomains.forEach(domain => {
          const option = document.createElement('option');
          option.value = domain;
          option.textContent = `üåê ${domain}`;
          elements.domainFilter.appendChild(option);
        });
      }

      function updateSourceLinks(bookmarklet) {
        if (!bookmarklet) {
          elements.sourceLinks.innerHTML = '';
          return;
        }

        const githubSourceUrl = `https://github.com/${REPO_OWNER}/${REPO_NAME}/blob/main/${bookmarklet.filename}`;
        let html = `<a href="${githubSourceUrl}" target="_blank">üìÑ View Source</a>`;

        if (bookmarklet.hasReadme) {
          const githubReadmeUrl = `https://github.com/${REPO_OWNER}/${REPO_NAME}/blob/main/${bookmarklet.filename.replace('.js', '_README.md')}`;
          html += ` <a href="${githubReadmeUrl}" target="_blank">üìñ View README</a>`;
        }

        elements.sourceLinks.innerHTML = html;
      }

      /* ============================================
         FILTERING & SORTING
         ============================================ */
      function applyFilters() {
        const searchTerm = elements.searchInput.value.toLowerCase();
        const domainFilter = elements.domainFilter.value;
        const sortBy = elements.sortSelect.value;

        let filtered = state.bookmarklets.filter(bookmarklet => {
          // Search filter
          if (searchTerm) {
            const searchIn = [
              bookmarklet.name,
              bookmarklet.metadata.title || '',
              bookmarklet.metadata.description || '',
              ...bookmarklet.metadata.domainList
            ].join(' ').toLowerCase();

            if (!searchIn.includes(searchTerm)) {
              return false;
            }
          }

          // Domain filter
          if (domainFilter) {
            if (!bookmarklet.metadata.domainList.includes(domainFilter)) {
              return false;
            }
          }

          return true;
        });

        // Sort
        filtered.sort((a, b) => {
          switch (sortBy) {
            case 'name':
              return a.name.localeCompare(b.name);
            case 'name-desc':
              return b.name.localeCompare(a.name);
            case 'has-metadata':
              return (b.hasMetadata ? 1 : 0) - (a.hasMetadata ? 1 : 0);
            case 'has-readme':
              return (b.hasReadme ? 1 : 0) - (a.hasReadme ? 1 : 0);
            default:
              return 0;
          }
        });

        state.filteredBookmarklets = filtered;
        populateDropdown();
      }

      /* ============================================
         BOOKMARKLET SELECTION & CREATION
         ============================================ */
      async function selectBookmarklet(bookmarklet) {
        state.selectedBookmarklet = bookmarklet;
        state.currentMetadata = bookmarklet.metadata;

        elements.select.value = bookmarklet.filename;
        elements.code.value = bookmarklet.code;

        const displayTitle = bookmarklet.metadata.title || formatNameFromFilename(bookmarklet.name);
        elements.title.value = displayTitle;

        updateSourceLinks(bookmarklet);
        renderMetadataInfo(bookmarklet);

        const warnings = validateMetadata(bookmarklet.code);
        if (warnings.length > 0) {
          showWarning(warnings.join(' '));
        } else {
          hideWarning();
        }

        await updateBookmarklet();
        updateURLState(bookmarklet.filename);
      }

      async function createBookmarkletUrl(code) {
        try {
          // Apply metadata if checkbox is checked
          if (elements.addMetadataCheckbox.checked) {
            const metadata = {
              title: elements.metaTitleInput.value.trim(),
              description: elements.metaDescInput.value.trim(),
              domains: elements.metaDomainsInput.value.trim()
            };

            if (metadata.title || metadata.description || metadata.domains) {
              code = injectMetadata(code, metadata);
            }
          }

          const minifyResult = await Terser.minify(code);
          if (minifyResult.error) {
            throw minifyResult.error;
          }
          const encoded = encodeURIComponent(minifyResult.code).replace(/'/g, "%27");
          return `javascript:${encoded}`;
        } catch (error) {
          throw new Error(`Minification failed: ${error.message}`);
        }
      }

      async function updateBookmarklet() {
        const title = elements.title.value.trim() || 'Bookmarklet';
        const code = elements.code.value.trim();

        if (!code) {
          hideError();
          hideSuccess();
          elements.link.innerHTML = '';
          elements.link.classList.add('hidden');
          elements.exportButtons.classList.add('hidden');
          return;
        }

        try {
          const bookmarkletUrl = await createBookmarkletUrl(code);
          elements.link.innerHTML = `<strong>Drag this link to your bookmarks bar:</strong><br><a href="${bookmarkletUrl}">${title}</a>`;
          elements.link.classList.remove('hidden');
          elements.exportButtons.classList.remove('hidden');
          hideError();
          showSuccess('Bookmarklet created successfully!');
        } catch (error) {
          showError(`Error: ${error.message}`);
          elements.link.innerHTML = '';
          elements.link.classList.add('hidden');
          elements.exportButtons.classList.add('hidden');
        }
      }

      /* ============================================
         EXPORT FUNCTIONALITY
         ============================================ */
      function downloadBookmarklet() {
        const code = elements.code.value.trim();
        if (!code) return;

        const filename = (state.selectedBookmarklet?.filename || 'bookmarklet.js');
        const blob = new Blob([code], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        showSuccess('Downloaded!');
      }

      function copyCode() {
        const code = elements.code.value.trim();
        if (!code) return;

        navigator.clipboard.writeText(code).then(() => {
          showSuccess('Code copied to clipboard!');
        }).catch(err => {
          showError('Failed to copy code');
        });
      }

      function shareLink() {
        if (!state.selectedBookmarklet) {
          showWarning('Please select a bookmarklet first');
          return;
        }

        const url = new URL(window.location);
        url.searchParams.set('bookmarklet', state.selectedBookmarklet.filename);

        navigator.clipboard.writeText(url.toString()).then(() => {
          showSuccess('Share link copied to clipboard!');
        }).catch(err => {
          showError('Failed to copy link');
        });
      }

      /* ============================================
         URL STATE MANAGEMENT
         ============================================ */
      function updateURLState(bookmarklet) {
        const url = new URL(window.location);
        if (bookmarklet) {
          url.searchParams.set('bookmarklet', bookmarklet);
        } else {
          url.searchParams.delete('bookmarklet');
        }
        history.pushState({}, '', url);
      }

      function getBookmarkletFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('bookmarklet');
      }

      /* ============================================
         UTILITIES
         ============================================ */
      function formatNameFromFilename(name) {
        return name
          .replace(/([a-z])([A-Z])/g, '$1 $2')
          .replace(/([A-Z])([A-Z][a-z])/g, '$1 $2')
          .replace(/_/g, ' ')
          .replace(/^\w/, c => c.toUpperCase())
          .trim();
      }

      function showError(message) {
        elements.error.textContent = message;
        elements.error.classList.remove('hidden');
      }

      function hideError() {
        elements.error.classList.add('hidden');
      }

      function showSuccess(message) {
        elements.success.textContent = message;
        elements.success.classList.remove('hidden');
        setTimeout(() => hideSuccess(), 3000);
      }

      function hideSuccess() {
        elements.success.classList.add('hidden');
      }

      function showWarning(message) {
        elements.validationWarning.innerHTML = message;
        elements.validationWarning.classList.remove('hidden');
      }

      function hideWarning() {
        elements.validationWarning.classList.add('hidden');
      }

      /* ============================================
         EVENT LISTENERS
         ============================================ */

      // Filtering
      elements.searchInput.addEventListener('input', applyFilters);
      elements.domainFilter.addEventListener('change', applyFilters);
      elements.sortSelect.addEventListener('change', applyFilters);

      // Bookmarklet selection
      elements.select.addEventListener('change', async () => {
        const filename = elements.select.value;
        if (!filename) {
          state.selectedBookmarklet = null;
          elements.code.value = '';
          elements.title.value = '';
          updateSourceLinks(null);
          renderMetadataInfo(null);
          hideWarning();
          await updateBookmarklet();
          updateURLState(null);
          return;
        }

        const bookmarklet = state.bookmarklets.find(b => b.filename === filename);
        if (bookmarklet) {
          await selectBookmarklet(bookmarklet);
        }
      });

      // Code editing
      elements.title.addEventListener('input', updateBookmarklet);
      elements.code.addEventListener('input', () => {
        // Show metadata editor when user enters custom code
        if (elements.code.value.trim() && !state.selectedBookmarklet) {
          elements.metadataEditor.classList.remove('hidden');
        }

        updateBookmarklet();
      });

      elements.beautify.addEventListener('click', () => {
        const code = elements.code.value.trim();
        if (code) {
          elements.code.value = js_beautify(code, { indent_size: 2 });
          updateBookmarklet();
        }
      });

      // Metadata editor
      elements.addMetadataCheckbox.addEventListener('change', () => {
        if (elements.addMetadataCheckbox.checked) {
          elements.metadataFields.classList.remove('hidden');
          // Pre-fill title if available
          if (!elements.metaTitleInput.value && elements.title.value) {
            elements.metaTitleInput.value = elements.title.value;
          }
        } else {
          elements.metadataFields.classList.add('hidden');
        }
        updateBookmarklet();
      });

      elements.metaTitleInput.addEventListener('input', updateBookmarklet);
      elements.metaDescInput.addEventListener('input', updateBookmarklet);
      elements.metaDomainsInput.addEventListener('input', updateBookmarklet);

      // Export buttons
      elements.downloadBtn.addEventListener('click', downloadBookmarklet);
      elements.copyCodeBtn.addEventListener('click', copyCode);
      elements.shareBtn.addEventListener('click', shareLink);

      // Browser navigation
      window.addEventListener('popstate', async () => {
        const urlBookmarklet = getBookmarkletFromURL();
        if (urlBookmarklet) {
          const bookmarklet = state.bookmarklets.find(b => b.filename === urlBookmarklet);
          if (bookmarklet) {
            await selectBookmarklet(bookmarklet);
          }
        } else {
          state.selectedBookmarklet = null;
          elements.select.value = '';
          elements.code.value = '';
          elements.title.value = '';
          updateSourceLinks(null);
          renderMetadataInfo(null);
          await updateBookmarklet();
        }
      });

      /* ============================================
         INITIALIZATION
         ============================================ */
      await fetchBookmarklets();
    })();
  </script>
</body>
</html>
