<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gist Encryption/Decryption</title>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #ddd;
            --input-bg: #f9f9f9;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --button-text: #ffffff;
            --success-bg: #d4edda;
            --success-border: #c3e6cb;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-border: #f5c6cb;
            --error-text: #721c24;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --border-color: #444;
            --input-bg: #2a2a2a;
            --button-bg: #0d6efd;
            --button-hover: #0a58ca;
            --success-bg: #1e4620;
            --success-border: #2d5f2e;
            --success-text: #a3d5a5;
            --error-bg: #5a1a1a;
            --error-border: #7a2a2a;
            --error-text: #f5b5ba;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        h1 {
            margin-bottom: 10px;
        }

        .description {
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .theme-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 5px;
            z-index: 1000;
        }

        .theme-toggle button {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-color);
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .theme-toggle button.active {
            background: var(--button-bg);
            color: var(--button-text);
            font-weight: bold;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
        }

        .section h2 {
            margin-top: 0;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: inherit;
            font-size: 14px;
        }

        textarea {
            min-height: 150px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: var(--button-bg);
            color: var(--button-text);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--button-hover);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-box {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid var(--success-border);
            border-radius: 4px;
            background: var(--success-bg);
            color: var(--success-text);
            display: none;
            word-break: break-all;
        }

        .result-box.error {
            border-color: var(--error-border);
            background: var(--error-bg);
            color: var(--error-text);
        }

        .result-box.show {
            display: block;
        }

        .result-box h3 {
            margin-top: 0;
            font-size: 16px;
        }

        .result-box pre {
            background: var(--bg-color);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .copy-btn {
            background: #28a745;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .info-box {
            padding: 15px;
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            margin-top: 20px;
            font-size: 14px;
        }

        [data-theme="dark"] .info-box {
            background: #1a3a52;
            border-color: #2a5a82;
        }

        code {
            background: var(--bg-color);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="theme-toggle">
        <button data-theme="light">Light</button>
        <button data-theme="auto">Auto</button>
        <button data-theme="dark">Dark</button>
    </div>

    <h1>Gist Encryption/Decryption</h1>
    <p class="description">
        Encrypt text with AES-256-GCM to securely share via GitHub Gists.
        The encryption key never leaves your browser and can be shared via URL fragment (e.g., <code>pv.html?gistid#key=...</code>).
    </p>

    <div class="section">
        <h2>Encrypt</h2>
        <form id="encrypt-form">
            <div class="form-group">
                <label for="encrypt-salt">Salt (optional metadata, not encrypted):</label>
                <input type="text" id="encrypt-salt" placeholder="e.g., version, description">
            </div>
            <div class="form-group">
                <label for="encrypt-text">Text to Encrypt:</label>
                <textarea id="encrypt-text" placeholder="Enter your text here..." required></textarea>
            </div>
            <button type="submit">ðŸ”’ Encrypt</button>
            <button type="button" id="clear-encrypt">Clear</button>
        </form>

        <div id="encrypt-result" class="result-box">
            <h3>Encryption Successful!</h3>
            <p><strong>Encryption Key (keep this secret):</strong></p>
            <pre id="encrypt-key-display"></pre>
            <button type="button" class="copy-btn" data-copy="key">Copy Key</button>

            <p style="margin-top: 20px;"><strong>Encrypted Text (save this to a gist):</strong></p>
            <pre id="encrypt-output-display"></pre>
            <button type="button" class="copy-btn" data-copy="encrypted">Copy Encrypted Text</button>

            <p style="margin-top: 20px;"><strong>PV.html URL with key:</strong></p>
            <pre id="pv-url-display"></pre>
            <button type="button" class="copy-btn" data-copy="pv-url">Copy PV URL</button>
        </div>
    </div>

    <div class="section">
        <h2>Decrypt</h2>
        <form id="decrypt-form">
            <div class="form-group">
                <label for="decrypt-key">Encryption Key:</label>
                <input type="text" id="decrypt-key" placeholder="Paste the encryption key here..." required>
            </div>
            <div class="form-group">
                <label for="decrypt-text">Encrypted Text:</label>
                <textarea id="decrypt-text" placeholder="Paste the encrypted text (JSON format)..." required></textarea>
            </div>
            <button type="submit">ðŸ”“ Decrypt</button>
            <button type="button" id="clear-decrypt">Clear</button>
        </form>

        <div id="decrypt-result" class="result-box">
            <h3>Decryption Successful!</h3>
            <p><strong>Salt:</strong> <span id="decrypt-salt-display"></span></p>
            <p><strong>Decrypted Text:</strong></p>
            <pre id="decrypt-output-display"></pre>
            <button type="button" class="copy-btn" data-copy="decrypted">Copy Decrypted Text</button>
        </div>

        <div id="decrypt-error" class="result-box error">
            <h3>Decryption Failed</h3>
            <p id="decrypt-error-message"></p>
        </div>
    </div>

    <div class="info-box">
        <h3>How to use:</h3>
        <ol>
            <li><strong>Encrypt:</strong> Enter your text and click "Encrypt". Save the key somewhere safe (it's not recoverable).</li>
            <li><strong>Share:</strong> Copy the encrypted text and paste it into a GitHub Gist.</li>
            <li><strong>View:</strong> Share the gist URL with the key in the fragment: <code>https://austegard.com/pv.html?gistid#key=YOUR_KEY</code></li>
            <li><strong>Decrypt:</strong> Or manually decrypt by pasting the key and encrypted text above.</li>
        </ol>
        <p><strong>Technical details:</strong> Uses AES-256-GCM encryption via the Web Crypto API. All encryption/decryption happens in your browser - no data is sent to any server.</p>
    </div>

    <script>
        // Theme management
        const themeManager = {
            current: localStorage.getItem('gist-crypto-theme') || 'auto',

            init() {
                this.apply();
                this.setupControls();
            },

            apply() {
                const theme = this.current;
                let effectiveTheme = theme;

                if (theme === 'auto') {
                    effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }

                if (effectiveTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }

                document.querySelectorAll('.theme-toggle button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === theme);
                });
            },

            set(theme) {
                this.current = theme;
                localStorage.setItem('gist-crypto-theme', theme);
                this.apply();
            },

            setupControls() {
                document.querySelectorAll('.theme-toggle button').forEach(btn => {
                    btn.addEventListener('click', () => this.set(btn.dataset.theme));
                });

                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (this.current === 'auto') this.apply();
                });
            }
        };

        // Crypto utilities
        const crypto = {
            async generateKey() {
                const key = await window.crypto.subtle.generateKey(
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );
                const exported = await window.crypto.subtle.exportKey('raw', key);
                return {
                    key,
                    keyString: this.arrayBufferToBase64(exported)
                };
            },

            async importKey(keyString) {
                const keyData = this.base64ToArrayBuffer(keyString);
                return await window.crypto.subtle.importKey(
                    'raw',
                    keyData,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt', 'decrypt']
                );
            },

            async encrypt(text, salt = '') {
                const { key, keyString } = await this.generateKey();
                const iv = window.crypto.getRandomValues(new Uint8Array(12)); // 96 bits
                const encoder = new TextEncoder();
                const data = encoder.encode(text);

                const encrypted = await window.crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv },
                    key,
                    data
                );

                return {
                    keyString,
                    encrypted: {
                        salt,
                        iv: this.arrayBufferToBase64(iv),
                        data: this.arrayBufferToBase64(encrypted)
                    }
                };
            },

            async decrypt(keyString, encryptedData) {
                const key = await this.importKey(keyString);
                const iv = this.base64ToArrayBuffer(encryptedData.iv);
                const data = this.base64ToArrayBuffer(encryptedData.data);

                const decrypted = await window.crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv },
                    key,
                    data
                );

                const decoder = new TextDecoder();
                return {
                    salt: encryptedData.salt || '',
                    text: decoder.decode(decrypted)
                };
            },

            arrayBufferToBase64(buffer) {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            },

            base64ToArrayBuffer(base64) {
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                return bytes.buffer;
            }
        };

        // UI handlers
        const ui = {
            init() {
                // Encrypt form
                document.getElementById('encrypt-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const salt = document.getElementById('encrypt-salt').value;
                    const text = document.getElementById('encrypt-text').value;

                    try {
                        const { keyString, encrypted } = await crypto.encrypt(text, salt);
                        const encryptedJson = JSON.stringify(encrypted, null, 2);

                        document.getElementById('encrypt-key-display').textContent = keyString;
                        document.getElementById('encrypt-output-display').textContent = encryptedJson;
                        document.getElementById('pv-url-display').textContent =
                            'Paste encrypted text into a gist, then use:\nhttps://austegard.com/pv.html?YOUR_GIST_ID#key=' + keyString;
                        document.getElementById('encrypt-result').classList.add('show');
                    } catch (error) {
                        alert('Encryption failed: ' + error.message);
                    }
                });

                // Decrypt form
                document.getElementById('decrypt-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const keyString = document.getElementById('decrypt-key').value.trim();
                    const encryptedText = document.getElementById('decrypt-text').value.trim();

                    document.getElementById('decrypt-result').classList.remove('show');
                    document.getElementById('decrypt-error').classList.remove('show');

                    try {
                        const encrypted = JSON.parse(encryptedText);
                        const { salt, text } = await crypto.decrypt(keyString, encrypted);

                        document.getElementById('decrypt-salt-display').textContent = salt || '(none)';
                        document.getElementById('decrypt-output-display').textContent = text;
                        document.getElementById('decrypt-result').classList.add('show');
                    } catch (error) {
                        document.getElementById('decrypt-error-message').textContent = error.message;
                        document.getElementById('decrypt-error').classList.add('show');
                    }
                });

                // Clear buttons
                document.getElementById('clear-encrypt').addEventListener('click', () => {
                    document.getElementById('encrypt-form').reset();
                    document.getElementById('encrypt-result').classList.remove('show');
                });

                document.getElementById('clear-decrypt').addEventListener('click', () => {
                    document.getElementById('decrypt-form').reset();
                    document.getElementById('decrypt-result').classList.remove('show');
                    document.getElementById('decrypt-error').classList.remove('show');
                });

                // Copy buttons
                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const type = btn.dataset.copy;
                        let text = '';

                        if (type === 'key') {
                            text = document.getElementById('encrypt-key-display').textContent;
                        } else if (type === 'encrypted') {
                            text = document.getElementById('encrypt-output-display').textContent;
                        } else if (type === 'pv-url') {
                            text = document.getElementById('pv-url-display').textContent;
                        } else if (type === 'decrypted') {
                            text = document.getElementById('decrypt-output-display').textContent;
                        }

                        try {
                            await navigator.clipboard.writeText(text);
                            const originalText = btn.textContent;
                            btn.textContent = 'âœ“ Copied!';
                            setTimeout(() => {
                                btn.textContent = originalText;
                            }, 2000);
                        } catch (error) {
                            alert('Failed to copy: ' + error.message);
                        }
                    });
                });
            }
        };

        // Client-side API (similar to claude-pruner)
        window.addEventListener('message', async (event) => {
            // Accept messages from same origin or austegard.com
            if (event.origin !== window.location.origin &&
                !event.origin.includes('austegard.com')) {
                return;
            }

            if (event.data.type === 'gist-encrypt') {
                try {
                    const { keyString, encrypted } = await crypto.encrypt(
                        event.data.text,
                        event.data.salt || ''
                    );
                    event.source.postMessage({
                        type: 'gist-encrypt-result',
                        success: true,
                        key: keyString,
                        encrypted: encrypted
                    }, event.origin);
                } catch (error) {
                    event.source.postMessage({
                        type: 'gist-encrypt-result',
                        success: false,
                        error: error.message
                    }, event.origin);
                }
            } else if (event.data.type === 'gist-decrypt') {
                try {
                    const result = await crypto.decrypt(event.data.key, event.data.encrypted);
                    event.source.postMessage({
                        type: 'gist-decrypt-result',
                        success: true,
                        salt: result.salt,
                        text: result.text
                    }, event.origin);
                } catch (error) {
                    event.source.postMessage({
                        type: 'gist-decrypt-result',
                        success: false,
                        error: error.message
                    }, event.origin);
                }
            }
        });

        // Check for URL parameters (auto-populate decrypt form)
        window.addEventListener('DOMContentLoaded', () => {
            themeManager.init();
            ui.init();

            const params = new URLSearchParams(window.location.search);
            const key = params.get('key') || window.location.hash.replace(/^#key=/, '');

            if (key) {
                document.getElementById('decrypt-key').value = key;
            }
        });
    </script>
</body>
</html>
