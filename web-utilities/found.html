<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Found Item</title>
  <meta name="robots" content="noindex, nofollow">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0d9488;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gradient-to-b from-teal-50 to-white min-h-screen">
  <div id="app" class="max-w-md mx-auto p-6">
    <!-- Loading state -->
    <div id="loading" class="text-center py-12">
      <div class="loader mx-auto mb-4"></div>
      <p class="text-gray-600">Loading...</p>
    </div>
    
    <!-- Error state -->
    <div id="error" class="hidden text-center py-12">
      <div class="text-5xl mb-4">üîó</div>
      <h1 class="text-xl font-bold text-gray-800 mb-2">Invalid or Expired Link</h1>
      <p class="text-gray-600">This QR code may be damaged or the link has expired.</p>
    </div>
    
    <!-- Success state (shown after submit) -->
    <div id="success" class="hidden text-center py-8">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="text-6xl mb-4">‚úÖ</div>
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Message Sent!</h2>
        <p class="text-gray-600 text-lg">The owner has been notified. Thank you for helping reunite them with their item!</p>
      </div>
    </div>
    
    <!-- Main content -->
    <div id="content" class="hidden">
      <div class="text-center mb-6">
        <div class="text-5xl mb-3">üì¶</div>
        <h1 class="text-2xl font-bold text-gray-800">You Found Something!</h1>
      </div>
      
      <div class="bg-white rounded-xl shadow-lg p-5 mb-6">
        <div class="text-sm text-teal-600 font-medium mb-1">Item</div>
        <div id="item-name" class="text-xl font-semibold text-gray-800 mb-4"></div>
        
        <div class="text-sm text-teal-600 font-medium mb-1">Message from Owner</div>
        <div id="owner-message" class="text-gray-700"></div>
      </div>
      
      <div id="form-section" class="bg-white rounded-xl shadow-lg p-5">
        <h2 class="font-semibold text-gray-800 mb-4">Let the owner know you found it</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Your Message</label>
            <textarea 
              id="finder-message" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500"
              rows="3"
              placeholder="Hi! I found your item at..."
            ></textarea>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Your Contact Info (optional)</label>
            <input 
              type="text" 
              id="finder-contact"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500"
              placeholder="Email or phone"
            />
          </div>
          
          <div class="flex items-center gap-2">
            <input type="checkbox" id="share-location" class="rounded text-teal-600">
            <label for="share-location" class="text-sm text-gray-700">Share my current location</label>
          </div>
          
          <div id="location-status" class="text-sm hidden">
            <div id="location-text" class="text-gray-600"></div>
            <div id="location-note" class="text-gray-400 text-xs mt-1 hidden">
              Note: Location accuracy depends on your device. Desktop browsers may only provide approximate location.
            </div>
          </div>
          
          <button 
            id="submit-btn"
            class="w-full py-3 bg-teal-600 text-white font-medium rounded-lg hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            Send Message
          </button>
          
          <div id="submit-error" class="text-red-600 text-sm hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Crypto utilities
    const cryptoUtils = {
      async deriveKey(secret, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey(
          'raw',
          enc.encode(secret),
          'PBKDF2',
          false,
          ['deriveKey']
        );
        return window.crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt: enc.encode(salt), iterations: 100000, hash: 'SHA-256' },
          keyMaterial,
          { name: 'AES-GCM', length: 256 },
          false,
          ['encrypt', 'decrypt']
        );
      },

      async decrypt(encryptedBase64, secret, salt) {
        const key = await this.deriveKey(secret, salt);
        // Convert URL-safe base64 back to standard base64
        let b64 = encryptedBase64
          .replace(/-/g, '+')
          .replace(/_/g, '/');
        // Add padding if needed
        while (b64.length % 4) b64 += '=';
        
        const combined = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
        const iv = combined.slice(0, 12);
        const ciphertext = combined.slice(12);
        
        const decrypted = await window.crypto.subtle.decrypt(
          { name: 'AES-GCM', iv },
          key,
          ciphertext
        );
        return new TextDecoder().decode(decrypted);
      }
    };

    // DOM elements
    const $ = id => document.getElementById(id);
    const show = id => $(id).classList.remove('hidden');
    const hide = id => $(id).classList.add('hidden');

    // State
    let config = null;
    let userLocation = null;

    // Initialize
    async function init() {
      try {
        const params = new URLSearchParams(window.location.search);
        const secret = params.get('s');
        const encrypted = params.get('d');
        
        if (!secret || !encrypted) {
          throw new Error('Missing parameters');
        }

        // Derive salt from first 8 chars of secret
        const saltBase = secret.substring(0, 8);
        
        const decrypted = await cryptoUtils.decrypt(encrypted, secret, saltBase);
        config = JSON.parse(decrypted);
        
        // Populate UI
        $('item-name').textContent = config.n;
        $('owner-message').textContent = 'If found, please use the form below to let me know where to pick it up!';
        
        hide('loading');
        show('content');
        
        // Setup event listeners
        setupListeners();
        
      } catch (e) {
        console.error('Init error:', e);
        hide('loading');
        show('error');
      }
    }

    function getLocationErrorMessage(err) {
      switch(err.code) {
        case 1: // PERMISSION_DENIED
          return 'Location permission denied. Please enable location access in your browser settings.';
        case 2: // POSITION_UNAVAILABLE
          return 'Location unavailable. Please try again or enter your location in the message.';
        case 3: // TIMEOUT
          return 'Location request timed out. Please try again.';
        default:
          return 'Could not get location: ' + err.message;
      }
    }

    function setupListeners() {
      // Location checkbox
      $('share-location').addEventListener('change', async (e) => {
        if (e.target.checked) {
          $('location-text').textContent = 'üìç Requesting location...';
          show('location-status');
          hide('location-note');
          
          try {
            const pos = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
              });
            });
            
            userLocation = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              accuracy: pos.coords.accuracy
            };
            
            const accuracyText = userLocation.accuracy > 1000 
              ? `¬±${(userLocation.accuracy / 1000).toFixed(1)}km` 
              : `¬±${Math.round(userLocation.accuracy)}m`;
            
            $('location-text').textContent = `üìç Location acquired (${accuracyText})`;
            $('location-text').className = 'text-green-600';
            
            // Show accuracy note if poor accuracy (> 500m)
            if (userLocation.accuracy > 500) {
              show('location-note');
            }
            
          } catch (err) {
            $('location-text').textContent = '‚ùå ' + getLocationErrorMessage(err);
            $('location-text').className = 'text-red-600';
            e.target.checked = false;
            userLocation = null;
          }
        } else {
          hide('location-status');
          userLocation = null;
        }
      });

      // Submit button
      $('submit-btn').addEventListener('click', submit);
    }

    async function submit() {
      const btn = $('submit-btn');
      const errorEl = $('submit-error');
      
      hide('submit-error');
      btn.disabled = true;
      btn.innerHTML = '<span class="loader"></span> Sending...';
      
      try {
        const message = $('finder-message').value.trim();
        const contact = $('finder-contact').value.trim();
        
        if (!message) {
          throw new Error('Please enter a message');
        }
        
        // Build issue body
        let body = `**Item:** ${config.n}\n\n`;
        body += `**Finder's Message:**\n${message}\n\n`;
        
        if (contact) {
          body += `**Contact Info:** ${contact}\n\n`;
        }
        
        if (userLocation) {
          const accuracyText = userLocation.accuracy > 1000 
            ? `¬±${(userLocation.accuracy / 1000).toFixed(1)}km` 
            : `¬±${Math.round(userLocation.accuracy)}m`;
          body += `**Location:** [${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}](https://www.google.com/maps?q=${userLocation.lat},${userLocation.lng}) (${accuracyText})\n`;
        }
        
        body += `\n---\n_Submitted via Found Item page_`;
        
        // Post to GitHub Issues API
        const response = await fetch(`https://api.github.com/repos/${config.r}/issues`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${config.p}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github+json'
          },
          body: JSON.stringify({
            title: `üîî Found: ${config.n}`,
            body: body,
            labels: ['found-item']
          })
        });
        
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.message || 'Failed to send message');
        }
        
        // Show success - hide form, show success message
        hide('content');
        show('success');
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
      } catch (e) {
        errorEl.textContent = e.message;
        show('submit-error');
        btn.disabled = false;
        btn.innerHTML = 'Send Message';
      }
    }

    init();
  </script>
</body>
</html>
